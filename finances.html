<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS COMMAND ‚Äî eSports Intelligence Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #080a0d;
  --bg2: #0d1117;
  --bg3: #111820;
  --cyan: #00d4ff;
  --cyan-dim: rgba(0,212,255,0.15);
  --orange: #ff6b00;
  --orange-dim: rgba(255,107,0,0.15);
  --green: #00ff88;
  --green-dim: rgba(0,255,136,0.12);
  --red: #ff1744;
  --red-dim: rgba(255,23,68,0.15);
  --yellow: #ffd600;
  --purple: #b94fff;
  --text: #c8d8e8;
  --text-dim: #556677;
  --border: rgba(0,212,255,0.2);
  --border-hot: rgba(0,212,255,0.5);
  --font-display: 'Orbitron', monospace;
  --font-ui: 'Rajdhani', sans-serif;
  --font-data: 'Share Tech Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

::selection { background: var(--cyan); color: #000; }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--cyan-dim); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--cyan); }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 14px;
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Scanline overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
  pointer-events: none;
  z-index: 9999;
}

/* Corner decoration */
.corner-tl, .corner-tr, .corner-bl, .corner-br {
  position: absolute;
  width: 12px; height: 12px;
  pointer-events: none;
}
.corner-tl { top: 0; left: 0; border-top: 2px solid var(--cyan); border-left: 2px solid var(--cyan); }
.corner-tr { top: 0; right: 0; border-top: 2px solid var(--cyan); border-right: 2px solid var(--cyan); }
.corner-bl { bottom: 0; left: 0; border-bottom: 2px solid var(--cyan); border-left: 2px solid var(--cyan); }
.corner-br { bottom: 0; right: 0; border-bottom: 2px solid var(--cyan); border-right: 2px solid var(--cyan); }

/* ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê */
#topbar {
  height: 48px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  flex-shrink: 0;
  position: relative;
  z-index: 100;
}

.topbar-logo {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 900;
  letter-spacing: 4px;
  color: var(--cyan);
  text-shadow: 0 0 20px var(--cyan);
  display: flex;
  align-items: center;
  gap: 10px;
}
.topbar-logo::before {
  content: '';
  display: inline-block;
  width: 8px; height: 8px;
  background: var(--cyan);
  box-shadow: 0 0 8px var(--cyan);
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.7); }
}

.topbar-status {
  display: flex;
  align-items: center;
  gap: 20px;
  font-family: var(--font-data);
  font-size: 11px;
  color: var(--text-dim);
}

.status-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border: 1px solid var(--border);
  background: var(--cyan-dim);
  clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
}

.status-pill.alert { border-color: var(--orange); background: var(--orange-dim); color: var(--orange); }

#topbar-ticker {
  flex: 1;
  overflow: hidden;
  margin: 0 20px;
  height: 24px;
  position: relative;
}

.ticker-inner {
  display: flex;
  white-space: nowrap;
  font-family: var(--font-data);
  font-size: 11px;
  color: var(--text-dim);
  gap: 40px;
  width: max-content;
}

.ticker-inner.animated {
  animation: ticker-scroll var(--ticker-duration, 60s) linear infinite;
}

@keyframes ticker-scroll {
  from { transform: translateX(0); }
  to { transform: translateX(-50%); }
}

.tick-item { margin-right: 40px; }
.tick-item.up { color: var(--green); }
.tick-item.down { color: var(--red); }
.tick-item.warn { color: var(--orange); }

/* ‚ïê‚ïê‚ïê UPLOAD PANEL (initial state) ‚ïê‚ïê‚ïê */
#upload-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 40px;
}

.upload-title {
  font-family: var(--font-display);
  font-size: 36px;
  font-weight: 900;
  color: var(--cyan);
  text-shadow: 0 0 40px var(--cyan);
  text-align: center;
  letter-spacing: 8px;
}
.upload-title span { color: var(--text-dim); font-size: 14px; font-family: var(--font-data); display: block; margin-top: 8px; letter-spacing: 4px; }

.upload-zone {
  display: flex;
  gap: 30px;
}

.upload-box {
  width: 280px;
  height: 160px;
  border: 1px solid var(--border);
  background: var(--bg2);
  position: relative;
  clip-path: polygon(16px 0%, 100% 0%, calc(100% - 16px) 100%, 0% 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.upload-box:hover {
  border-color: var(--cyan);
  background: var(--cyan-dim);
}

.upload-box.loaded {
  border-color: var(--green);
  background: var(--green-dim);
}

.upload-box input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
  font-size: 0;
}

.upload-icon { font-size: 36px; }
.upload-label { font-family: var(--font-display); font-size: 12px; letter-spacing: 3px; color: var(--text-dim); }
.upload-status { font-family: var(--font-data); font-size: 11px; color: var(--cyan); }

.upload-launch {
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 4px;
  padding: 14px 40px;
  background: var(--cyan);
  color: #000;
  border: none;
  cursor: pointer;
  clip-path: polygon(12px 0%, 100% 0%, calc(100% - 12px) 100%, 0% 100%);
  transition: all 0.2s;
  opacity: 0.3;
}
.upload-launch.ready { opacity: 1; }
.upload-launch:hover { background: #fff; }

/* ‚ïê‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê‚ïê */
#app {
  display: none;
  flex: 1;
  overflow: hidden;
  flex-direction: column;
}

#app.visible { display: flex; }

/* ‚ïê‚ïê‚ïê NAV TABS ‚ïê‚ïê‚ïê */
#nav {
  display: flex;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  gap: 2px;
  flex-shrink: 0;
}

.nav-tab {
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 10px 18px;
  background: transparent;
  border: none;
  color: var(--text-dim);
  cursor: pointer;
  position: relative;
  transition: all 0.2s;
  border-bottom: 2px solid transparent;
}

.nav-tab:hover { color: var(--text); }
.nav-tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }
.nav-tab .badge {
  background: var(--red);
  color: #fff;
  font-size: 9px;
  padding: 1px 4px;
  border-radius: 2px;
  margin-left: 6px;
  font-family: var(--font-data);
  animation: pulse-badge 2s ease-in-out infinite;
}
@keyframes pulse-badge {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê */
#content {
  flex: 1;
  overflow: hidden;
  position: relative;
}

.panel {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  padding: 16px;
  display: none;
  gap: 16px;
  flex-direction: column;
}
.panel.active { display: flex; }

/* ‚ïê‚ïê‚ïê CARD COMPONENT ‚ïê‚ïê‚ïê */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  position: relative;
  padding: 16px;
}

.card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 30px; height: 2px;
  background: var(--cyan);
}

.card.orange::before { background: var(--orange); }
.card.green::before { background: var(--green); }
.card.red::before { background: var(--red); }
.card.purple::before { background: var(--purple); }
.card.yellow::before { background: var(--yellow); }

.card-title {
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 3px;
  color: var(--cyan);
  text-transform: uppercase;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card.orange .card-title { color: var(--orange); }
.card.green .card-title { color: var(--green); }
.card.red .card-title { color: var(--red); }
.card.purple .card-title { color: var(--purple); }
.card.yellow .card-title { color: var(--yellow); }

/* ‚ïê‚ïê‚ïê GRIDS ‚ïê‚ïê‚ïê */
.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.g4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; }
.g-sidebar { display: grid; grid-template-columns: 340px 1fr; gap: 16px; }
.g-sidebar-r { display: grid; grid-template-columns: 1fr 360px; gap: 16px; }

/* ‚ïê‚ïê‚ïê STAT BOXES ‚ïê‚ïê‚ïê */
.stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }

.stat-box {
  background: var(--bg3);
  border: 1px solid var(--border);
  padding: 12px 14px;
  position: relative;
  clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
}

.stat-box .lbl { font-family: var(--font-data); font-size: 10px; color: var(--text-dim); letter-spacing: 1px; }
.stat-box .val { font-family: var(--font-display); font-size: 20px; font-weight: 700; margin-top: 2px; }
.stat-box .sub { font-family: var(--font-data); font-size: 10px; color: var(--text-dim); margin-top: 1px; }
.stat-box.cyan .val { color: var(--cyan); }
.stat-box.green .val { color: var(--green); }
.stat-box.orange .val { color: var(--orange); }
.stat-box.red .val { color: var(--red); }

/* ‚ïê‚ïê‚ïê FORMS ‚ïê‚ïê‚ïê */
.nx-select, .nx-input {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 500;
  padding: 8px 12px;
  width: 100%;
  outline: none;
  transition: border-color 0.2s;
  clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
}

.nx-select:focus, .nx-input:focus { border-color: var(--cyan); }
.nx-select option { background: var(--bg3); }
.nx-input::placeholder { color: var(--text-dim); }

.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label { font-family: var(--font-data); font-size: 10px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; }

/* ‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê */
.btn {
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 9px 16px;
  border: 1px solid;
  cursor: pointer;
  transition: all 0.2s;
  clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  white-space: nowrap;
}

.btn-cyan { background: var(--cyan); color: #000; border-color: var(--cyan); }
.btn-cyan:hover { background: transparent; color: var(--cyan); }

.btn-orange { background: var(--orange); color: #000; border-color: var(--orange); }
.btn-orange:hover { background: transparent; color: var(--orange); }

.btn-green { background: var(--green); color: #000; border-color: var(--green); }
.btn-green:hover { background: transparent; color: var(--green); }

.btn-red { background: var(--red); color: #fff; border-color: var(--red); }
.btn-red:hover { background: transparent; color: var(--red); }

.btn-ghost { background: transparent; color: var(--text-dim); border-color: var(--border); }
.btn-ghost:hover { color: var(--text); border-color: var(--text-dim); }

.btn-purple { background: var(--purple); color: #fff; border-color: var(--purple); }
.btn-purple:hover { background: transparent; color: var(--purple); }

.btn-sm { padding: 5px 10px; font-size: 10px; letter-spacing: 1px; }
.btn-full { width: 100%; text-align: center; }
.btn-row { display: flex; gap: 8px; }

/* ‚ïê‚ïê‚ïê DATA TABLE ‚ïê‚ïê‚ïê */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-family: var(--font-data);
  font-size: 12px;
}

.data-table th {
  font-family: var(--font-display);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  padding: 6px 10px;
  text-align: left;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

.data-table td {
  padding: 8px 10px;
  border-bottom: 1px solid rgba(0,212,255,0.05);
  vertical-align: middle;
}

.data-table tr:hover td { background: var(--cyan-dim); }

.data-table .num { text-align: right; }
.data-table .c { color: var(--cyan); }
.data-table .g { color: var(--green); }
.data-table .r { color: var(--red); }
.data-table .o { color: var(--orange); }
.data-table .y { color: var(--yellow); }
.data-table .dim { color: var(--text-dim); }

/* ‚ïê‚ïê‚ïê SCROLLABLE LIST ‚ïê‚ïê‚ïê */
.scroll-list {
  overflow-y: auto;
  max-height: 280px;
}

.list-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  border-bottom: 1px solid rgba(0,212,255,0.05);
  transition: background 0.15s;
  gap: 8px;
}

.list-row:hover { background: var(--cyan-dim); }

.list-row .name { font-weight: 600; font-size: 13px; }
.list-row .meta { font-family: var(--font-data); font-size: 10px; color: var(--text-dim); }

/* ‚ïê‚ïê‚ïê PROGRESS BAR ‚ïê‚ïê‚ïê */
.progress-track {
  height: 4px;
  background: var(--bg3);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 4px;
}
.progress-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
}

/* ‚ïê‚ïê‚ïê ORACLE SCORE ‚ïê‚ïê‚ïê */
.oracle-ring {
  position: relative;
  width: 120px; height: 120px;
  margin: 0 auto;
}
.oracle-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.oracle-score-text {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
}
.oracle-score-text .num { font-size: 28px; font-weight: 900; }
.oracle-score-text .lbl { font-size: 9px; letter-spacing: 2px; color: var(--text-dim); }

/* ‚ïê‚ïê‚ïê BADGES ‚ïê‚ïê‚ïê */
.badge {
  font-family: var(--font-data);
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 0;
  font-weight: 700;
  clip-path: polygon(4px 0%, 100% 0%, calc(100% - 4px) 100%, 0% 100%);
}
.badge-cyan { background: var(--cyan); color: #000; }
.badge-green { background: var(--green); color: #000; }
.badge-red { background: var(--red); color: #fff; }
.badge-orange { background: var(--orange); color: #000; }
.badge-yellow { background: var(--yellow); color: #000; }
.badge-purple { background: var(--purple); color: #fff; }
.badge-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }

/* ‚ïê‚ïê‚ïê ALERT ITEM ‚ïê‚ïê‚ïê */
.alert-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-left: 3px solid;
  background: var(--bg3);
  margin-bottom: 6px;
  font-size: 13px;
}
.alert-item.critical { border-color: var(--red); }
.alert-item.warning { border-color: var(--orange); }
.alert-item.info { border-color: var(--cyan); }
.alert-item.success { border-color: var(--green); }

/* ‚ïê‚ïê‚ïê COMPARISON ‚ïê‚ïê‚ïê */
.compare-grid {
  display: grid;
  grid-template-columns: 1fr 60px 1fr;
  gap: 12px;
  align-items: start;
}
.compare-vs {
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 900;
  color: var(--orange);
  padding-top: 50px;
}
.compare-card {
  background: var(--bg3);
  border: 1px solid var(--border);
  padding: 16px;
  transition: all 0.3s;
}
.compare-card.winner { border-color: var(--green); box-shadow: 0 0 20px rgba(0,255,136,0.15); }
.compare-card.loser { border-color: var(--red); opacity: 0.7; }

/* ‚ïê‚ïê‚ïê FORECAST CANVAS ‚ïê‚ïê‚ïê */
#forecast-canvas { width: 100%; height: 180px; display: block; }

/* ‚ïê‚ïê‚ïê POWER RANKING ‚ïê‚ïê‚ïê */
.rank-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(0,212,255,0.05);
  transition: background 0.15s;
}
.rank-item:hover { background: var(--cyan-dim); }
.rank-num {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 900;
  width: 32px;
  text-align: center;
  flex-shrink: 0;
}
.rank-num.gold { color: #ffd600; }
.rank-num.silver { color: #b0bec5; }
.rank-num.bronze { color: #ff7043; }
.rank-num.other { color: var(--text-dim); }

/* ‚ïê‚ïê‚ïê LOG ‚ïê‚ïê‚ïê */
.log-area {
  background: var(--bg);
  border: 1px solid var(--border);
  font-family: var(--font-data);
  font-size: 11px;
  padding: 10px;
  height: 120px;
  overflow-y: auto;
  color: var(--text-dim);
  line-height: 1.6;
}
.log-area .log-entry { border-bottom: 1px solid rgba(255,255,255,0.03); padding: 2px 0; }
.log-area .log-entry .ts { color: var(--cyan); margin-right: 8px; }
.log-area .log-entry.good .ts { color: var(--green); }
.log-area .log-entry.warn .ts { color: var(--orange); }
.log-area .log-entry.bad .ts { color: var(--red); }

/* ‚ïê‚ïê‚ïê TRANSFER NOTIFICATION ‚ïê‚ïê‚ïê */
.offer-panel {
  background: var(--bg3);
  border: 1px solid var(--orange);
  padding: 12px;
  margin-bottom: 10px;
}
.offer-panel .offer-header {
  font-family: var(--font-display);
  font-size: 10px;
  letter-spacing: 3px;
  color: var(--orange);
  margin-bottom: 10px;
}
.offer-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg);
  padding: 10px 12px;
  margin-bottom: 6px;
  border-left: 3px solid var(--orange);
}

/* ‚ïê‚ïê‚ïê TRAVEL CHECKBOX ‚ïê‚ïê‚ïê */
.travel-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 7px 10px;
  border-bottom: 1px solid rgba(0,212,255,0.05);
  cursor: pointer;
  transition: background 0.15s;
}
.travel-item:hover { background: var(--cyan-dim); }
.travel-item input[type=checkbox] { accent-color: var(--cyan); width: 14px; height: 14px; }

/* ‚ïê‚ïê‚ïê ANIMATIONS ‚ïê‚ïê‚ïê */
@keyframes fade-in {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.anim { animation: fade-in 0.3s ease forwards; }

@keyframes glow-pulse {
  0%, 100% { box-shadow: 0 0 8px var(--cyan); }
  50% { box-shadow: 0 0 20px var(--cyan), 0 0 40px var(--cyan-dim); }
}

.glow { animation: glow-pulse 3s ease-in-out infinite; }

/* ‚ïê‚ïê‚ïê RISK METER ‚ïê‚ïê‚ïê */
.risk-bar {
  height: 8px;
  border-radius: 0;
  background: linear-gradient(to right, var(--green), var(--yellow), var(--orange), var(--red));
  position: relative;
  margin-top: 4px;
}
.risk-indicator {
  position: absolute;
  top: -3px;
  width: 3px;
  height: 14px;
  background: #fff;
  transform: translateX(-50%);
  box-shadow: 0 0 6px #fff;
}

/* ‚ïê‚ïê‚ïê MINI CHART ‚ïê‚ïê‚ïê */
.mini-chart { display: flex; align-items: flex-end; gap: 2px; height: 40px; }
.mini-bar {
  flex: 1;
  background: var(--cyan-dim);
  border-top: 1px solid var(--cyan);
  min-height: 2px;
  transition: height 0.3s ease;
}
.mini-bar:hover { background: var(--cyan); }

/* tooltip */
[data-tip] { position: relative; cursor: help; }
[data-tip]:hover::after {
  content: attr(data-tip);
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: #000;
  border: 1px solid var(--cyan);
  color: var(--text);
  font-family: var(--font-data);
  font-size: 11px;
  padding: 6px 10px;
  white-space: nowrap;
  z-index: 9999;
  pointer-events: none;
}

/* Separator */
.sep { border: none; border-top: 1px solid var(--border); margin: 12px 0; }

/* ‚ïê‚ïê‚ïê BOTTOM STRIP ‚ïê‚ïê‚ïê */
#bottom-strip {
  height: 32px;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  flex-shrink: 0;
  font-family: var(--font-data);
  font-size: 10px;
  color: var(--text-dim);
}

.bottom-actions { display: flex; gap: 10px; }

/* Month ticker */
#month-counter {
  font-family: var(--font-display);
  font-size: 11px;
  color: var(--cyan);
  letter-spacing: 2px;
}

/* Responsive tweaks */
@media (max-width: 1200px) { .g4 { grid-template-columns: 1fr 1fr; } }
@media (max-width: 900px) { .g3 { grid-template-columns: 1fr 1fr; } .g-sidebar { grid-template-columns: 1fr; } }

.upload-scan {
  padding: 10px 32px;
  background: transparent;
  border: 1px solid var(--cyan);
  color: var(--cyan);
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 3px;
  cursor: pointer;
  transition: all .2s;
  text-transform: uppercase;
}
.upload-scan:hover { background: var(--cyan-dim); box-shadow: 0 0 16px var(--cyan); }
.upload-scan.scanning { opacity: .5; cursor: wait; }
.scan-status {
  margin-top: 8px;
  font-family: var(--font-data);
  font-size: 11px;
  color: var(--text-dim);
  min-height: 16px;
  letter-spacing: 1px;
}
/* ‚ïê‚ïê‚ïê INTEL PANEL ‚ïê‚ïê‚ïê */
.intel-team-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  padding: 12px 14px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all .2s;
  position: relative;
}
.intel-team-card:hover { border-color: var(--cyan); background: var(--bg3); }
.intel-team-card.rising { border-left: 3px solid var(--green); }
.intel-team-card.falling { border-left: 3px solid var(--red); }
.intel-team-card.stable { border-left: 3px solid var(--cyan); }
.intel-team-card.selected { border-color: var(--cyan); background: var(--bg3); }
.intel-team-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.intel-team-name { font-family:var(--font-display); font-size:13px; font-weight:700; letter-spacing:2px; }
.intel-score-badge { font-family:var(--font-data); font-size:11px; padding:3px 8px; border-radius:2px; }
.intel-metrics { display:flex; gap:12px; flex-wrap:wrap; }
.intel-metric { font-family:var(--font-data); font-size:10px; color:var(--text-dim); }
.intel-metric span { color:var(--text); }
.intel-expand-hint { font-family:var(--font-data); font-size:9px; color:var(--text-dim); margin-top:6px; letter-spacing:1px; }

.intel-detail-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  padding: 20px;
}
.intel-detail-title { font-family:var(--font-display); font-size:16px; font-weight:900; letter-spacing:3px; margin-bottom:16px; display:flex; align-items:center; gap:10px; }
.intel-section { margin-bottom:18px; }
.intel-section-title { font-family:var(--font-display); font-size:10px; letter-spacing:3px; color:var(--text-dim); margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid var(--border); }
.intel-tip { background:var(--bg3); border-left:3px solid var(--cyan); padding:10px 14px; margin-bottom:8px; font-size:13px; line-height:1.7; }
.intel-tip.good { border-left-color:var(--green); }
.intel-tip.warn { border-left-color:var(--orange); }
.intel-tip.bad { border-left-color:var(--red); }
.intel-tip .tip-label { font-family:var(--font-display); font-size:9px; letter-spacing:2px; color:var(--text-dim); margin-bottom:4px; }
.intel-tip .tip-text { font-size:12px; line-height:1.8; }
.intel-diag-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
.intel-diag-item { background:var(--bg3); padding:10px; text-align:center; }
.intel-diag-item .d-val { font-family:var(--font-data); font-size:18px; font-weight:700; }
.intel-diag-item .d-lbl { font-family:var(--font-display); font-size:9px; letter-spacing:2px; color:var(--text-dim); margin-top:3px; }

.topbar-back {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px; height: 20px;
  font-size: 14px;
  color: var(--text-dim);
  text-decoration: none;
  opacity: 0.15;
  transition: opacity 0.3s, color 0.3s;
  margin-right: 4px;
  flex-shrink: 0;
}
.topbar-back:hover { opacity: 1; color: var(--cyan); }

/* ‚ïê‚ïê‚ïê PLAYER PROFILE MODAL ‚ïê‚ïê‚ïê */
.player-modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  animation: fade-in 0.2s ease;
}
.player-modal {
  background: var(--bg2);
  border: 1px solid var(--cyan);
  width: 520px; max-width: 92vw;
  max-height: 85vh; overflow-y: auto;
  position: relative;
  box-shadow: 0 0 60px rgba(0,212,255,0.15);
}
.player-modal::before {
  content: ''; position: absolute; top: 0; left: 0;
  width: 100%; height: 3px;
  background: linear-gradient(90deg, var(--cyan), var(--purple), var(--cyan));
}
.pm-header {
  padding: 20px 20px 12px;
  border-bottom: 1px solid var(--border);
}
.pm-close {
  position: absolute; top: 10px; right: 14px;
  background: none; border: none; color: var(--text-dim); font-size: 22px;
  cursor: pointer; transition: color 0.2s;
}
.pm-close:hover { color: var(--red); }
.pm-name {
  font-family: var(--font-display); font-size: 20px; font-weight: 900;
  letter-spacing: 3px; color: var(--cyan);
}
.pm-sub {
  font-family: var(--font-data); font-size: 11px; color: var(--text-dim); margin-top: 4px;
}
.pm-body { padding: 16px 20px 20px; }
.pm-section-title {
  font-family: var(--font-display); font-size: 10px; letter-spacing: 3px;
  color: var(--text-dim); margin: 14px 0 8px; padding-bottom: 5px;
  border-bottom: 1px solid var(--border);
}
.pm-section-title:first-child { margin-top: 0; }
.pm-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.pm-stat {
  background: var(--bg3); padding: 10px 12px; text-align: center;
}
.pm-stat .v { font-family: var(--font-display); font-size: 18px; font-weight: 700; }
.pm-stat .l { font-family: var(--font-data); font-size: 9px; color: var(--text-dim); letter-spacing: 1px; margin-top: 2px; }
.pm-medal-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
.pm-medal {
  background: var(--bg3); border: 1px solid var(--border); padding: 8px 14px;
  text-align: center; flex: 1; min-width: 80px;
}
.pm-medal .icon { font-size: 20px; }
.pm-medal .cnt { font-family: var(--font-display); font-size: 16px; font-weight: 700; margin-top: 2px; }
.pm-medal .lbl { font-family: var(--font-data); font-size: 9px; color: var(--text-dim); letter-spacing: 1px; }
.pm-mv-compare { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
.pm-mv-compare .mv-box { background: var(--bg3); padding: 10px 14px; flex: 1; text-align: center; }
.pm-mv-compare .mv-box .v { font-family: var(--font-display); font-size: 16px; font-weight: 700; }
.pm-mv-compare .mv-box .l { font-family: var(--font-data); font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.pm-mv-compare .mv-arrow { font-family: var(--font-display); font-size: 16px; color: var(--text-dim); }
</style>
<body>

<!-- UPLOAD OVERLAY -->
<div id="upload-overlay">
  <div class="upload-title">
    NEXUS COMMAND
    <span>eSports Intelligence Platform v9.0</span>
  </div>

  <div class="upload-zone">
    <div class="upload-box" id="fin-box">
      <input type="file" id="upload-finances" accept=".xlsx">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="upload-icon">üí∞</div>
      <div class="upload-label">FINANCES.XLSX</div>
      <div class="upload-status" id="fin-status">AWAITING DATA</div>
    </div>
    <div class="upload-box" id="ply-box">
      <input type="file" id="upload-players" accept=".xlsx">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="upload-icon">üéÆ</div>
      <div class="upload-label">PLAYERS.XLSX</div>
      <div class="upload-status" id="ply-status">AWAITING DATA</div>
    </div>
  </div>

  <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
    <button class="upload-scan" id="scan-btn" onclick="scanFiles()">‚ü≥ SCAN FILE/</button>
    <div class="scan-status" id="scan-status"></div>
    <button class="upload-launch" id="launch-btn" onclick="launchApp()">INITIALIZE NEXUS</button>
  </div>
</div>

<!-- TOP BAR -->
<div id="topbar">
  <a href="index.html" class="topbar-back" title="Back to Portal">‚Äπ</a>
  <div class="topbar-logo">NEXUS</div>
  <div id="topbar-ticker">
    <div class="ticker-inner" id="ticker-content">SYSTEM INITIALIZING...</div>
  </div>
  <div class="topbar-status">
    <div class="status-pill" id="status-season">MONTH <span id="month-num">1</span></div>
    <div class="status-pill" id="status-teams">0 TEAMS</div>
    <div class="status-pill" id="status-players">0 PLAYERS</div>
    <div class="status-pill alert" id="status-alerts" style="display:none">‚ö† ALERTS</div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">

  <!-- NAV -->
  <div id="nav">
    <button class="nav-tab active" onclick="showPanel('p-command', this)">‚¨° COMMAND</button>
    <button class="nav-tab" onclick="showPanel('p-market', this)">‚óà MARKET</button>
    <button class="nav-tab" onclick="showPanel('p-compare', this)">‚áå COMPARE</button>
    <button class="nav-tab" onclick="showPanel('p-league', this)">‚óâ LEAGUE</button>
    <button class="nav-tab" onclick="showPanel('p-ops', this)">‚öô OPS <span class="badge" id="alert-badge" style="display:none">!</span></button>
    <button class="nav-tab" onclick="showPanel('p-intel', this); runIntel()">üß† INTEL</button>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- ‚ïê‚ïê‚ïê COMMAND PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel active" id="p-command">
      <div class="g-sidebar">
        <!-- LEFT SIDEBAR -->
        <div style="display:flex; flex-direction:column; gap:16px;">

          <!-- ACTIVE TEAM SELECTOR -->
          <div class="card">
            <div class="card-title">‚óà ACTIVE COMMAND</div>
            <div class="form-group" style="margin-bottom:10px;">
              <div class="form-label">SELECTED TEAM</div>
              <select class="nx-select" id="dash-team-select" onchange="updateCommand()" style="font-size:15px; font-weight:700; font-family:var(--font-display); color:var(--cyan);"></select>
            </div>
            <div id="cmd-oracle-wrap"></div>
          </div>

          <!-- FINANCES -->
          <div class="card">
            <div class="card-title">üí∞ FINANCIAL STATUS</div>
            <div id="cmd-finances"></div>
          </div>

          <!-- RENEWAL TOOL -->
          <div class="card orange">
            <div class="card-title">üìã CONTRACT RENEWAL</div>
            <div class="form-group" style="margin-bottom:8px;">
              <div class="form-label">TARGET</div>
              <select class="nx-select" id="dash-renew-target"></select>
            </div>
            <div class="g2" style="margin-bottom:8px;">
              <div class="form-group">
                <div class="form-label">MONTHS (1‚Äì24)</div>
                <input type="number" class="nx-input" id="dash-renew-dur" min="1" max="24" value="12">
              </div>
            </div>
            <button class="btn btn-orange btn-full" onclick="applyRenewal()">EXECUTE RENEWAL</button>
          </div>

        </div>

        <!-- RIGHT MAIN -->
        <div style="display:flex; flex-direction:column; gap:16px;">

          <!-- OFFER NOTIFICATIONS -->
          <div id="cmd-notifications"></div>

          <!-- TOP ROW STATS -->
          <div id="cmd-stat-row" class="stat-row"></div>

          <!-- ROSTER + AI SCOUT -->
          <div class="g2">
            <div class="card">
              <div class="card-title">üë• ACTIVE ROSTER</div>
              <div id="cmd-roster" class="scroll-list" style="max-height:240px;"></div>
            </div>
            <div class="card yellow">
              <div class="card-title">üß† NEXUS AI SCOUT</div>
              <div id="cmd-ai-scout" style="font-size:13px; line-height:1.7;"></div>
            </div>
          </div>

          <!-- FINANCIAL FORECAST -->
          <div class="card">
            <div class="card-title">üìà 6-MONTH FINANCIAL FORECAST</div>
            <canvas id="forecast-canvas"></canvas>
          </div>

          <!-- LOG -->
          <div class="card">
            <div class="card-title" style="justify-content:space-between;">
              <span>üìã ACTIVITY LOG</span>
              <button class="btn btn-ghost btn-sm" onclick="undo()">‚Ü© UNDO</button>
            </div>
            <div class="log-area" id="action-log"></div>
          </div>

        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MARKET PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="p-market">
      <div class="g2">
        <!-- FILTERS -->
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="card">
            <div class="card-title">üî≠ SCOUTING FILTERS</div>
            <div class="g3" style="gap:10px; margin-bottom:10px;">
              <div class="form-group">
                <div class="form-label">ROLE</div>
                <select class="nx-select" id="market-filter" onchange="refreshMarket()">
                  <option value="all">All Roles</option>
                  <option value="none">üö´ Sem Time</option>
                  <option value="Bench">Benched</option>
                  <option value="Starter">Starters</option>
                </select>
              </div>
              <div class="form-group">
                <div class="form-label">TEAM</div>
                <select class="nx-select" id="market-team-filter" onchange="refreshMarket()">
                  <option value="all">All Teams</option>
                  <option value="my_roster">üõ° My Roster</option>
                  <option value="offers">üî• On Sale</option>
                </select>
              </div>
              <div class="form-group">
                <div class="form-label">SORT</div>
                <select class="nx-select" id="market-sort" onchange="refreshMarket()">
                  <option value="mv-desc">‚Üì Market Value</option>
                  <option value="mv-asc">‚Üë Market Value</option>
                  <option value="imp-asc">‚Üë 6m Impact (Safe)</option>
                  <option value="imp-desc">‚Üì 6m Impact (Risk)</option>
                  <option value="buy-asc">‚Üë Buyout</option>
                  <option value="buy-desc">‚Üì Buyout</option>
                </select>
              </div>
            </div>
            <div class="g3" style="gap:10px;">
              <div class="form-group">
                <div class="form-label">MV RANGE ($)</div>
                <div style="display:flex; gap:5px;">
                  <input type="number" class="nx-input" id="filter-mv-min" placeholder="Min" onkeyup="refreshMarket()" style="padding:6px 8px;">
                  <input type="number" class="nx-input" id="filter-mv-max" placeholder="Max" onkeyup="refreshMarket()" style="padding:6px 8px;">
                </div>
              </div>
              <div class="form-group">
                <div class="form-label">BUYOUT RANGE ($)</div>
                <div style="display:flex; gap:5px;">
                  <input type="number" class="nx-input" id="filter-buy-min" placeholder="Min" onkeyup="refreshMarket()" style="padding:6px 8px;">
                  <input type="number" class="nx-input" id="filter-buy-max" placeholder="Max" onkeyup="refreshMarket()" style="padding:6px 8px;">
                </div>
              </div>
              <div class="form-group">
                <div class="form-label">CONTRACT (MONTHS)</div>
                <div style="display:flex; gap:5px;">
                  <input type="number" class="nx-input" id="filter-con-min" placeholder="Min" onkeyup="refreshMarket()" style="padding:6px 8px;">
                  <input type="number" class="nx-input" id="filter-con-max" placeholder="Max" onkeyup="refreshMarket()" style="padding:6px 8px;">
                </div>
              </div>
            </div>
            <div class="g3" style="gap:10px; margin-top:10px;">
              <div class="form-group">
                <div class="form-label">üèÜ TOTAL TITLES</div>
                <div style="display:flex; gap:5px;">
                  <input type="number" class="nx-input" id="filter-titles-min" placeholder="Min" onkeyup="refreshMarket()" style="padding:6px 8px;">
                  <input type="number" class="nx-input" id="filter-titles-max" placeholder="Max" onkeyup="refreshMarket()" style="padding:6px 8px;">
                </div>
              </div>
              <div class="form-group">
                <div class="form-label">ü•á TOTAL MEDALS (MVP+EVP+VP)</div>
                <div style="display:flex; gap:5px;">
                  <input type="number" class="nx-input" id="filter-medals-min" placeholder="Min" onkeyup="refreshMarket()" style="padding:6px 8px;">
                  <input type="number" class="nx-input" id="filter-medals-max" placeholder="Max" onkeyup="refreshMarket()" style="padding:6px 8px;">
                </div>
              </div>
              <div class="form-group">
                <div class="form-label">üí∞ PRIZE POOL ($)</div>
                <div style="display:flex; gap:5px;">
                  <input type="number" class="nx-input" id="filter-prize-min" placeholder="Min" onkeyup="refreshMarket()" style="padding:6px 8px;">
                  <input type="number" class="nx-input" id="filter-prize-max" placeholder="Max" onkeyup="refreshMarket()" style="padding:6px 8px;">
                </div>
              </div>
            </div>
          </div>

          <!-- HOT DEALS AI -->
          <div class="card green">
            <div class="card-title">üî• AI HOT DEALS ‚Äî VERIFIED</div>
            <div id="hot-deals-list" style="font-size:13px;"></div>
          </div>

          <!-- PROPOSALS -->
          <div class="card purple">
            <div class="card-title">üì§ MY PROPOSALS</div>
            <div id="outbound-offers" class="scroll-list" style="max-height:200px;"></div>
          </div>
        </div>

        <!-- SCOUTING LIST -->
        <div class="card">
          <div class="card-title" style="justify-content:space-between;">
            <span>üì° SCOUTING FEED</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="form-label">CONTRACT (MO):</span>
              <input type="number" class="nx-input" id="market-duration" min="1" max="24" value="12" style="width:60px; padding:5px 8px;">
            </div>
          </div>
          <div id="market-list" class="scroll-list" style="max-height:680px;"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê COMPARE PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="p-compare">
      <div class="card" style="margin-bottom:0;">
        <div class="card-title">‚áå AI PLAYER COMPARISON ENGINE</div>
        <p style="color:var(--text-dim); font-size:12px; margin-bottom:14px;">Select two players. The NEXUS AI will calculate who is the smarter acquisition for your active team right now, based on financials, form, and sustainability.</p>
        <div class="g3" style="gap:10px; align-items:flex-end;">
          <div class="form-group">
            <div class="form-label">PLAYER A</div>
            <select class="nx-select" id="compare-p1" style="font-weight:600;"></select>
          </div>
          <div class="form-group">
            <div class="form-label">PLAYER B</div>
            <select class="nx-select" id="compare-p2" style="font-weight:600;"></select>
          </div>
          <button class="btn btn-cyan" onclick="runComparison()" style="height:38px;">‚áå RUN ANALYSIS</button>
        </div>
      </div>
      <div id="comparison-result"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê LEAGUE PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="p-league">
      <div class="g2">
        <div style="display:flex; flex-direction:column; gap:16px;">
          <!-- POWER RANKINGS -->
          <div class="card">
            <div class="card-title">üèÜ POWER RANKINGS</div>
            <div id="league-rankings"></div>
          </div>
          <!-- FINANCIAL HEALTH MATRIX -->
          <div class="card orange">
            <div class="card-title">‚ö† FINANCIAL HEALTH MATRIX</div>
            <div id="league-health"></div>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:16px;">
          <!-- ROSTER ALERTS -->
          <div class="card red">
            <div class="card-title">üö® ROSTER INTELLIGENCE</div>
            <div id="league-roster"></div>
          </div>
          <!-- RISING STARS -->
          <div class="card yellow">
            <div class="card-title">‚≠ê FORM LEADERBOARD</div>
            <div id="league-stars"></div>
          </div>
          <!-- MARKET ACTIVITY -->
          <div class="card purple">
            <div class="card-title">üîÑ TRANSFER HISTORY</div>
            <div id="league-transfers" class="scroll-list" style="max-height:200px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê OPS PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="p-ops">
      <div class="g3">

        <!-- TRAVEL -->
        <div class="card purple">
          <div class="card-title">‚úà BULK TRAVEL PLANNER</div>
          <div class="form-group" style="margin-bottom:8px;">
            <div class="form-label">TRAVEL TYPE</div>
            <select class="nx-select" id="travel-type" onchange="renderTravelList()">
              <option value="regional">Regional ($5,000)</option>
              <option value="national">National ($15,000)</option>
              <option value="international">International ($35,000)</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:8px;">
            <div class="form-label">SEARCH TEAM</div>
            <input type="text" class="nx-input" id="travel-search" placeholder="Filter..." onkeyup="renderTravelList()">
          </div>
          <div id="travel-list" class="scroll-list" style="max-height:200px; margin-bottom:10px;"></div>
          <button class="btn btn-purple btn-full" onclick="applyTravelExpenses()">CHARGE SELECTED TEAMS</button>
        </div>

        <!-- TOURNAMENT -->
        <div class="card green">
          <div class="card-title">üèÜ TOURNAMENT ENGINE</div>
          <div class="form-group" style="margin-bottom:8px;">
            <div class="form-label">TEAM</div>
            <select class="nx-select" id="tourney-team-select"></select>
          </div>
          <div class="form-group" style="margin-bottom:8px;">
            <div class="form-label">PRIZE POOL ($)</div>
            <input type="number" class="nx-input" id="prize-amount" placeholder="0.00">
          </div>
          <label style="display:flex; align-items:center; gap:8px; margin-bottom:10px; cursor:pointer; font-family:var(--font-data); font-size:12px; color:var(--text);">
            <input type="checkbox" id="tourney-award-title" style="accent-color:var(--green); width:16px; height:16px;">
            <span>üèÜ AWARD TITLE MEDALS <span style="color:var(--text-dim);">(check only if team won the tournament)</span></span>
          </label>
          <div class="alert-item info" style="margin-bottom:10px; font-size:11px; font-family:var(--font-data);">
            60% ‚Üí Team Bank&nbsp;&nbsp;|&nbsp;&nbsp;40% ‚Üí Starter MV split&nbsp;&nbsp;|&nbsp;&nbsp;Titles: optional ‚òë
          </div>
          <button class="btn btn-green btn-full" onclick="distributeTourneyPrize()">DISTRIBUTE PRIZE</button>

          <hr class="sep">

          <div class="card-title" style="margin-top:4px;">‚≠ê INDIVIDUAL AWARDS</div>
          <div class="form-group" style="margin-bottom:8px;">
            <div class="form-label">PLAYER</div>
            <select class="nx-select" id="perf-player-select"></select>
          </div>
          <div class="g2" style="margin-bottom:8px;">
            <div class="form-group">
              <div class="form-label">TIER</div>
              <select class="nx-select" id="perf-tier">
                <option value="region">Regional (10k)</option>
                <option value="global">Global (20k)</option>
                <option value="major">Major (50k)</option>
              </select>
            </div>
            <div class="form-group">
              <div class="form-label">AWARD</div>
              <select class="nx-select" id="perf-type">
                <option value="mvp">ü•á MVP</option>
                <option value="evp">ü•à EVP</option>
                <option value="vp">ü•â VP</option>
              </select>
            </div>
          </div>
          <button class="btn btn-cyan btn-full" onclick="applyIndividualPerformance()">GRANT AWARD + MEDAL</button>
        </div>

        <!-- INTERVENTIONS -->
        <div class="card red">
          <div class="card-title">‚ö° LEAGUE INTERVENTIONS</div>

          <div class="alert-item warning" style="margin-bottom:12px; font-size:12px;">
            ‚ö† These actions affect league balance. Use with caution.
          </div>

          <div class="form-group" style="margin-bottom:10px;">
            <div class="form-label">TARGET TEAM</div>
            <select class="nx-select" id="reset-team-select"></select>
          </div>

          <button class="btn btn-orange btn-full" onclick="applyBailout()" style="margin-bottom:8px;">üíä BANKRUPT BAILOUT (+$25k + 50% Sponsor Boost)</button>
          <button class="btn btn-red btn-full" onclick="applySeasonReset()">üîÅ GLOBAL SEASON RESET (‚àí30% MV, Accumulate Totals)</button>

          <hr class="sep">
          <div class="card-title">üìÅ DATA MANAGEMENT</div>
          <button class="btn btn-cyan btn-full" onclick="exportExcels()">üì• EXPORT UPDATED EXCELS</button>

          <hr class="sep">
          <div class="card-title">üìã CONTRACT ALERTS</div>
          <div class="form-group" style="margin-bottom:8px;">
            <div class="form-label">RENEWAL MONTHS (1‚Äì24)</div>
            <input type="number" class="nx-input" id="renew-duration" min="1" max="24" value="12">
          </div>
          <div id="contract-alerts" class="scroll-list" style="max-height:180px;"></div>
        </div>

      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê INTEL PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="p-intel" style="padding:16px; overflow-y:auto;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:10px;">
        <div style="font-family:var(--font-display); font-size:18px; font-weight:900; color:var(--cyan); letter-spacing:4px; text-shadow:0 0 20px var(--cyan);">
          üß† NEXUS INTEL ‚Äî AN√ÅLISE DE DESEMPENHO
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="form-group" style="margin:0;">
            <input type="text" class="nx-input" id="intel-search" placeholder="üîç Buscar time..." oninput="runIntel()" style="width:200px; padding:6px 12px; font-size:12px;">
          </div>
          <button class="btn btn-cyan" onclick="runIntel()" style="padding:8px 24px; letter-spacing:2px; font-size:11px;">‚ü≥ ATUALIZAR AN√ÅLISE</button>
        </div>
      </div>

      <!-- SUMMARY BAR -->
      <div id="intel-summary-bar" class="g4" style="margin-bottom:16px; gap:12px;"></div>

      <!-- MAIN GRID -->
      <div class="g2" style="gap:16px; align-items:start;">

        <!-- RISING TEAMS -->
        <div style="display:flex; flex-direction:column; min-height:0;">
          <div style="font-family:var(--font-display); font-size:11px; letter-spacing:3px; color:var(--green); margin-bottom:10px; display:flex; align-items:center; gap:8px;">
            <span style="font-size:16px;">üìà</span> TIMES EM ASCENS√ÉO
          </div>
          <div id="intel-rising" style="overflow-y:auto; max-height:380px; border:1px solid var(--border); background:var(--bg); padding:4px;"></div>
        </div>

        <!-- FALLING TEAMS -->
        <div style="display:flex; flex-direction:column; min-height:0;">
          <div style="font-family:var(--font-display); font-size:11px; letter-spacing:3px; color:var(--red); margin-bottom:10px; display:flex; align-items:center; gap:8px;">
            <span style="font-size:16px;">üìâ</span> TIMES EM COLAPSO
          </div>
          <div id="intel-falling" style="overflow-y:auto; max-height:380px; border:1px solid var(--border); background:var(--bg); padding:4px;"></div>
        </div>

      </div>

      <!-- STABLE TEAMS (shown when searching or always) -->
      <div id="intel-stable-wrap" style="margin-top:16px; display:none;">
        <div style="font-family:var(--font-display); font-size:11px; letter-spacing:3px; color:var(--cyan); margin-bottom:10px; display:flex; align-items:center; gap:8px;">
          <span style="font-size:16px;">‚óà</span> TIMES EST√ÅVEIS
        </div>
        <div id="intel-stable" style="overflow-y:auto; max-height:300px; border:1px solid var(--border); background:var(--bg); padding:4px; display:grid; grid-template-columns:1fr 1fr; gap:4px;"></div>
      </div>

      <!-- DETAIL REPORT (expanded) -->
      <div id="intel-detail" style="margin-top:16px; max-height:500px; overflow-y:auto;"></div>

    </div>

  </div><!-- /content -->

</div><!-- /app -->

<!-- BOTTOM STRIP -->
<div id="bottom-strip">
  <div id="month-counter">MONTH 01 ‚Äî NEXUS COMMAND</div>
  <div class="bottom-actions">
    <button class="btn btn-cyan" onclick="runMonthlyCycle()" style="padding:6px 20px; font-size:11px; letter-spacing:2px;">‚è≠ RUN MONTHLY CYCLE</button>
    <button class="btn btn-ghost btn-sm" onclick="undo()">‚Ü© UNDO</button>
    <button class="btn btn-ghost btn-sm" onclick="exportExcels()">üì• EXPORT</button>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NEXUS COMMAND ‚Äî Core Data & Utilities
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let finances = [], players = [], history = [];
let temporaryOffers = {}, pendingTransfers = [], transferHistory = [];
let monthCounter = 1;
let finLoaded = false, plyLoaded = false;

const $ = id => document.getElementById(id);
const fmt = v => '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
const fmtK = v => { const a = Math.abs(v); const s = v < 0 ? '-' : ''; return s + (a >= 1000 ? '$' + (a/1000).toFixed(1) + 'k' : fmt(v)); };
const clamp = (v,min,max) => Math.min(max, Math.max(min, v));

// File handling
$('upload-finances').addEventListener('change', e => handleXL(e, d => {
  finances = normalizeFinances(d); finLoaded = true;
  $('fin-box').classList.add('loaded');
  $('fin-status').textContent = `‚úì ${d.length} TEAMS LOADED`;
  checkLaunch();
}));
$('upload-players').addEventListener('change', e => handleXL(e, d => {
  players = normalizePlayers(d); plyLoaded = true;
  $('ply-box').classList.add('loaded');
  $('ply-status').textContent = `‚úì ${d.length} PLAYERS LOADED`;
  checkLaunch();
}));

function handleXL(e, cb) {
  const r = new FileReader();
  r.onload = ev => {
    const wb = XLSX.read(ev.target.result, {type:'binary'});
    cb(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
  };
  r.readAsBinaryString(e.target.files[0]);
}

/* Normalize column names from Excel ‚Üí internal code names */
function normalizePlayers(arr) {
  return arr.map(p => {
    const row = {...p};
    
    // L√™ EXATAMENTE os nomes corretos das colunas do seu Excel
    row['Market Value'] = Number(row['Market Value']) || 0;
    row['Prize Pool'] = Number(row['Prize Pool']) || 0;
    
    // Mant√©m as chaves sem espa√ßo caso alguma outra parte do c√≥digo as utilize
    row.MarketValue = row['Market Value'];
    row.PrizePool = row['Prize Pool'];
    
    // Garante que todos os outros campos existam com valores padr√£o (removido o Prestige)
    row.MVP = Number(row.MVP || row['MVP']) || 0;
    row.EVP = Number(row.EVP || row['EVP']) || 0;
    row.VP = Number(row.VP || row['VP']) || 0;
    row.Titles = Number(row.Titles || row['Titles']) || 0;
    row['Total MVP'] = Number(row['Total MVP']) || 0;
    row['Total EVP'] = Number(row['Total EVP']) || 0;
    row['Total VP'] = Number(row['Total VP']) || 0;
    row['Total Titles'] = Number(row['Total Titles']) || 0;
    row['Previous MV'] = Number(row['Previous MV']) || 0;
    row.ContractMonths = Number(row.ContractMonths || row['ContractMonths']) || 0;
    
    return row;
  });
}

function normalizeFinances(arr) {
  return arr.map(t => {
    const row = {...t};
    // Handle typo: HeathTeam ‚Üí HealthTeam
    if (row['HeathTeam'] !== undefined && row['HealthTeam'] === undefined) {
      row.HealthTeam = Number(row['HeathTeam']) || 0;
    }
    row.CurrentBank = Number(row.CurrentBank) || 0;
    return row;
  });
}

function checkLaunch() {
  if (finLoaded && plyLoaded) $('launch-btn').classList.add('ready');
}

async function scanFiles() {
  const btn = $('scan-btn');
  const status = $('scan-status');
  btn.classList.add('scanning');
  btn.textContent = '‚ü≥ SCANNING...';
  status.style.color = 'var(--cyan)';
  status.textContent = 'Buscando arquivos em file/...';

  async function fetchXL(path) {
    const res = await fetch(path);
    if (!res.ok) throw new Error(path);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array'});
    return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  }

  try {
    const [finData, plyData] = await Promise.all([
      fetchXL('file/finances_updated.xlsx'),
      fetchXL('file/players_updated.xlsx')
    ]);
    finances = normalizeFinances(finData); finLoaded = true;
    $('fin-box').classList.add('loaded');
    $('fin-status').textContent = `‚úì ${finData.length} RECORDS LOADED`;
    players = normalizePlayers(plyData); plyLoaded = true;
    $('ply-box').classList.add('loaded');
    $('ply-status').textContent = `‚úì ${plyData.length} PLAYERS LOADED`;
    $('launch-btn').classList.add('ready');
    status.style.color = 'var(--green)';
    status.textContent = `‚úì ARQUIVOS ENCONTRADOS ‚Äî PRONTO PARA INICIALIZAR`;
    btn.textContent = '‚úì FILES LOADED';
  } catch(e) {
    status.style.color = 'var(--red)';
    status.textContent = `‚úó N√ÉO ENCONTRADO: ${e.message} ‚Äî verifique a pasta file/`;
    btn.classList.remove('scanning');
    btn.textContent = '‚ü≥ SCAN FILE/';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NEXUS INTEL ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let intelSelectedTeam = null;

function runIntel() {
  // Build full profile for every team
  const profiles = finances.map(team => {
    const tName = team.TeamName;
    const oracle = getOracleScore(tName);
    const risk = getRiskIndex(tName);
    const fins = getTeamFinances(team);
    const bank = team.CurrentBank || 0;
    const teamPlayers = players.filter(p => p.TeamName === tName);
    const starters = teamPlayers.filter(p => p.Role === 'Starter').length;
    const bench = teamPlayers.filter(p => p.Role === 'Bench').length;
    const expiring = teamPlayers.filter(p => p.ContractMonths <= 2).length;
    const avgForm = teamPlayers.length ? teamPlayers.reduce((s,p) => s + getFormScore(p), 0) / teamPlayers.length : 0;
    const topPlayer = [...teamPlayers].sort((a,b) => getFormScore(b) - getFormScore(a))[0];
    const runway = fins.salaries > 0 ? bank / fins.salaries : 99;
    const tier = String(team.Tier || '').toLowerCase().trim();

    // Trend score: positive = ascending, negative = falling
    let trend = 0;
    if (oracle.score >= 75) trend += 3;
    else if (oracle.score >= 55) trend += 1;
    else if (oracle.score < 35) trend -= 3;
    else if (oracle.score < 50) trend -= 1;

    if (fins.net > 15000) trend += 2;
    else if (fins.net > 5000) trend += 1;
    else if (fins.net < 0) trend -= 2;
    else if (fins.net < 3000) trend -= 1;

    if (starters >= 5) trend += 1;
    else if (starters <= 2) trend -= 2;
    else if (starters <= 3) trend -= 1;

    if (expiring >= 3) trend -= 2;
    else if (expiring >= 2) trend -= 1;

    if (avgForm >= 8) trend += 2;
    else if (avgForm >= 4) trend += 1;
    else if (avgForm < 1) trend -= 1;

    if (risk > 65) trend -= 2;
    if (bank < 0) trend -= 2;

    return { team, tName, oracle, risk, fins, bank, teamPlayers, starters, bench, expiring, avgForm, topPlayer, runway, tier, trend };
  });

  profiles.sort((a,b) => b.oracle.score - a.oracle.score);

  const rising = profiles.filter(p => p.trend >= 2).sort((a,b) => b.trend - a.trend);
  const falling = profiles.filter(p => p.trend <= -2).sort((a,b) => a.trend - b.trend);
  const stable = profiles.filter(p => p.trend > -2 && p.trend < 2);

  // Apply search filter for display only (summary bar stays unfiltered)
  const intelQuery = ($('intel-search')?.value || '').toLowerCase().trim();
  const filterProf = arr => intelQuery ? arr.filter(p => p.tName.toLowerCase().includes(intelQuery)) : arr;
  const risingFiltered = filterProf(rising);
  const fallingFiltered = filterProf(falling);

  // Summary bar (always full counts)
  $('intel-summary-bar').innerHTML = `
    <div class="stat-box green"><div class="lbl">EM ASCENS√ÉO</div><div class="val">${rising.length}</div><div class="sub">times s√≥lidos</div></div>
    <div class="stat-box cyan"><div class="lbl">EST√ÅVEIS</div><div class="val">${stable.length}</div><div class="sub">monitorando</div></div>
    <div class="stat-box red"><div class="lbl">EM COLAPSO</div><div class="val">${falling.length}</div><div class="sub">precisam de a√ß√£o</div></div>
    <div class="stat-box ${falling.length > rising.length ? 'red' : 'green'}"><div class="lbl">LIGA HEALTH</div><div class="val">${Math.round(profiles.reduce((s,p)=>s+p.oracle.score,0)/Math.max(profiles.length,1))}</div><div class="sub">avg oracle</div></div>
  `;

  function renderTeamCard(prof, type) {
    const netColor = prof.fins.net >= 0 ? 'var(--green)' : 'var(--red)';
    const trendIcon = type === 'rising' ? '‚ñ≤' : type === 'falling' ? '‚ñº' : '‚óà';
    const trendColor = type === 'rising' ? 'var(--green)' : type === 'falling' ? 'var(--red)' : 'var(--cyan)';
    const bgBadge = `background:${prof.oracle.color}22; color:${prof.oracle.color};`;
    return `
      <div class="intel-team-card ${type} ${intelSelectedTeam===prof.tName?'selected':''}" onclick="selectIntelTeam('${prof.tName.replace(/'/g,"\\'")}')">
        <div class="intel-team-header">
          <div class="intel-team-name" style="color:${prof.oracle.color}">${prof.tName}</div>
          <div style="display:flex; gap:6px; align-items:center;">
            <span style="font-family:var(--font-data); font-size:11px; color:${trendColor};">${trendIcon} ${Math.abs(prof.trend)} pts</span>
            <span class="intel-score-badge" style="${bgBadge}">ORACLE ${prof.oracle.score} ‚Äî ${prof.oracle.grade}</span>
          </div>
        </div>
        <div class="intel-metrics">
          <div class="intel-metric">NET <span style="color:${netColor}">${fmtK(prof.fins.net)}/mo</span></div>
          <div class="intel-metric">BANK <span>${fmtK(prof.bank)}</span></div>
          <div class="intel-metric">STARTERS <span style="color:${prof.starters>=5?'var(--green)':'var(--orange)'}">${prof.starters}/5</span></div>
          <div class="intel-metric">EXPIRING <span style="color:${prof.expiring>=3?'var(--red)':prof.expiring>=1?'var(--orange)':'var(--green)'}">${prof.expiring}</span></div>
          <div class="intel-metric">AVG FORM <span>${prof.avgForm.toFixed(1)}</span></div>
          ${prof.topPlayer ? `<div class="intel-metric">STAR <span style="color:var(--yellow)">‚≠ê ${String(prof.topPlayer.PlayerName)}</span></div>` : ''}
        </div>
        <div class="intel-expand-hint">‚ñ∏ CLIQUE PARA AN√ÅLISE COMPLETA</div>
      </div>
    `;
  }

  const stableFiltered = filterProf(stable);

  $('intel-rising').innerHTML = risingFiltered.length
    ? risingFiltered.map(p => renderTeamCard(p, 'rising')).join('')
    : `<div style="color:var(--text-dim); font-family:var(--font-data); font-size:11px; padding:16px;">${intelQuery ? 'Nenhum resultado para "'+intelQuery+'".' : 'Nenhum time em ascens√£o detectado.'}</div>`;

  $('intel-falling').innerHTML = fallingFiltered.length
    ? fallingFiltered.map(p => renderTeamCard(p, 'falling')).join('')
    : `<div style="color:var(--text-dim); font-family:var(--font-data); font-size:11px; padding:16px;">${intelQuery ? 'Nenhum resultado para "'+intelQuery+'".' : 'Nenhum time cr√≠tico detectado.'}</div>`;

  // Show stable teams section when there are stable teams (always, or filtered)
  const stableWrap = $('intel-stable-wrap');
  if (stableFiltered.length > 0) {
    stableWrap.style.display = 'block';
    $('intel-stable').innerHTML = stableFiltered.map(p => renderTeamCard(p, 'stable')).join('');
  } else {
    stableWrap.style.display = intelQuery ? 'block' : 'none';
    $('intel-stable').innerHTML = intelQuery ? `<div style="color:var(--text-dim); font-family:var(--font-data); font-size:11px; padding:16px; grid-column:1/-1;">Nenhum resultado para "${intelQuery}".</div>` : '';
  }

  // Auto-select worst team on first run
  if (!intelSelectedTeam && falling.length > 0) {
    intelSelectedTeam = falling[0].tName;
  } else if (!intelSelectedTeam && profiles.length > 0) {
    intelSelectedTeam = profiles[0].tName;
  }
  if (intelSelectedTeam) renderIntelDetail(profiles);
}

function selectIntelTeam(name) {
  intelSelectedTeam = name;
  // Re-run to refresh selection highlight + detail
  document.querySelectorAll('.intel-team-card').forEach(c => c.classList.remove('selected'));
  const profiles = finances.map(team => {
    const tName = team.TeamName;
    const oracle = getOracleScore(tName);
    const risk = getRiskIndex(tName);
    const fins = getTeamFinances(team);
    const bank = team.CurrentBank || 0;
    const teamPlayers = players.filter(p => p.TeamName === tName);
    const starters = teamPlayers.filter(p => p.Role === 'Starter').length;
    const bench = teamPlayers.filter(p => p.Role === 'Bench').length;
    const expiring = teamPlayers.filter(p => p.ContractMonths <= 2).length;
    const avgForm = teamPlayers.length ? teamPlayers.reduce((s,p) => s + getFormScore(p), 0) / teamPlayers.length : 0;
    const topPlayer = [...teamPlayers].sort((a,b) => getFormScore(b) - getFormScore(a))[0];
    const runway = fins.salaries > 0 ? bank / fins.salaries : 99;
    const tier = String(team.Tier || '').toLowerCase().trim();
    let trend = 0;
    if (oracle.score >= 75) trend += 3; else if (oracle.score >= 55) trend += 1; else if (oracle.score < 35) trend -= 3; else if (oracle.score < 50) trend -= 1;
    if (fins.net > 15000) trend += 2; else if (fins.net > 5000) trend += 1; else if (fins.net < 0) trend -= 2; else if (fins.net < 3000) trend -= 1;
    if (starters >= 5) trend += 1; else if (starters <= 2) trend -= 2; else if (starters <= 3) trend -= 1;
    if (expiring >= 3) trend -= 2; else if (expiring >= 2) trend -= 1;
    if (avgForm >= 8) trend += 2; else if (avgForm >= 4) trend += 1; else if (avgForm < 1) trend -= 1;
    if (risk > 65) trend -= 2;
    if (bank < 0) trend -= 2;
    return { team, tName, oracle, risk, fins, bank, teamPlayers, starters, bench, expiring, avgForm, topPlayer, runway, tier, trend };
  });
  renderIntelDetail(profiles);
}

function renderIntelDetail(profiles) {
  const prof = profiles.find(p => p.tName === intelSelectedTeam);
  if (!prof) return;

  const { team, tName, oracle, risk, fins, bank, teamPlayers, starters, bench, expiring, avgForm, topPlayer, runway, tier } = prof;
  const isFalling = prof.trend <= -2;
  const isRising = prof.trend >= 2;

  // Generate diagnostic items
  const issues = [];
  const strengths = [];
  const actions = [];

  // ‚îÄ‚îÄ FINANCES ‚îÄ‚îÄ
  if (fins.net < 0) {
    issues.push({ label: 'FLUXO NEGATIVO', text: `O time est√° perdendo <b style="color:var(--red)">${fmt(Math.abs(fins.net))}/m√™s</b>. Com o banco atual de ${fmt(bank)}, isso √© insustent√°vel por mais de ${Math.max(0,(bank/Math.abs(fins.net))).toFixed(1)} meses.` });
    actions.push({ type: 'bad', label: 'A√á√ÉO URGENTE ‚Äî FINAN√áAS', text: `Reduza custos fixos ou libere jogadores com sal√°rio alto para equilibrar o fluxo. Considere dispensar bench players com MarketValue alto que n√£o contribuem com t√≠tulos. O objetivo m√≠nimo √© zerar o NET/m√™s antes de qualquer contrata√ß√£o.` });
  } else if (fins.net < 5000) {
    issues.push({ label: 'MARGEM APERTADA', text: `Lucro mensal de apenas ${fmt(fins.net)}. Qualquer nova contrata√ß√£o pode virar o saldo negativo.` });
    actions.push({ type: 'warn', label: 'CAUTELA ‚Äî FINAN√áAS', text: `Evite contrata√ß√µes que custam mais de ${fmt(fins.net * 0.6)}/m√™s. Priorize free agents (sem taxa de buyout). Foque em renovar contratos com dura√ß√£o curta antes de ficarem a zero.` });
  } else {
    strengths.push({ label: 'FINANCEIRO S√ìLIDO', text: `Lucro de ${fmt(fins.net)}/m√™s. Capacidade de aquisi√ß√£o confirmada sem comprometer estabilidade.` });
  }

  if (bank < 0) {
    issues.push({ label: 'BANCO NEGATIVO', text: `Saldo atual: <b style="color:var(--red)">${fmt(bank)}</b>. O time est√° tecnicamente insolvente.` });
    actions.push({ type: 'bad', label: 'EMERG√äNCIA ‚Äî BANCO NEGATIVO', text: `Interrompa TODAS as contrata√ß√µes imediatamente. Venda jogadores bench via transfer market para recuperar caixa. Prioridade m√°xima: trazer o banco para positivo antes de qualquer outra a√ß√£o.` });
  } else if (runway < 2) {
    issues.push({ label: 'RESERVA BAIXA', text: `Banco cobre apenas ${runway.toFixed(1)} meses de sal√°rios. Qualquer crise financeira seria fatal.` });
    actions.push({ type: 'warn', label: 'RESERVA DE EMERG√äNCIA', text: `Mantenha sempre no m√≠nimo 3 meses de sal√°rios em banco (‚âà ${fmt(fins.salaries * 3)}). Corte gastos n√£o essenciais at√© atingir esse colch√£o.` });
  } else if (runway >= 5) {
    strengths.push({ label: 'RESERVA EXCELENTE', text: `${runway.toFixed(1)} meses de runway. Equipe tem seguran√ßa para absorver varia√ß√µes e investir oportunisticamente.` });
  }

  // ‚îÄ‚îÄ ROSTER ‚îÄ‚îÄ
  if (starters < 5) {
    const missing = 5 - starters;
    issues.push({ label: `ROSTER INCOMPLETO (${starters}/5)`, text: `Faltam ${missing} starter(s). Time est√° competindo abaixo da capacidade m√°xima.` });
    if (fins.net > 0 && bank > fins.salaries * 2) {
      actions.push({ type: 'bad', label: 'CONTRATA√á√ÉO PRIORIT√ÅRIA', text: `Com ${missing} vaga(s) em aberto e finan√ßas est√°veis, busque no mercado free agents com MarketValue compat√≠vel ao seu budget (sal√°rio ‚âà MV √ó 10%). Priorize jogadores com Form Score > 5 para impacto imediato. Use o painel ‚óà MARKET com filtro "Free Agents" para identificar op√ß√µes.` });
    } else {
      actions.push({ type: 'warn', label: 'ROSTER INCOMPLETO ‚Äî SEM BUDGET', text: `Corrija as finan√ßas primeiro (zere o NET negativo), depois busque contratar. Roster vazio com banco negativo √© a pior combina√ß√£o poss√≠vel.` });
    }
  } else {
    strengths.push({ label: 'ROSTER COMPLETO', text: `5/5 starters ativos${bench > 0 ? ` e ${bench} bench player(s) de reserva` : ''}. Escala√ß√£o m√°xima dispon√≠vel.` });
  }

  if (bench === 0) {
    issues.push({ label: 'SEM BANCO DE RESERVAS', text: `Nenhum bench player. Se um starter sair ou expirar, o time fica com gap imediato no roster.` });
    actions.push({ type: 'warn', label: 'MONTE BANCO DE RESERVAS', text: `Contrate ao menos 1‚Äì2 bench players com sal√°rio baixo (MV abaixo de 50k) para cobrir emerg√™ncias. Bench players custam menos e oferecem seguran√ßa estrat√©gica quando contratos expiram.` });
  }

  // ‚îÄ‚îÄ CONTRACTS ‚îÄ‚îÄ
  if (expiring >= 3) {
    const expiringPlayers = teamPlayers.filter(p => p.ContractMonths <= 2).map(p => String(p.PlayerName)).join(', ');
    issues.push({ label: `${expiring} CONTRATOS EXPIRANDO`, text: `Jogadores com contratos cr√≠ticos (‚â§2 meses): <b style="color:var(--orange)">${expiringPlayers}</b>. Risco alto de perda gratuita.` });
    actions.push({ type: 'bad', label: 'RENOVA√á√ÉO URGENTE', text: `Renove contratos dos jogadores com maior Form Score primeiro. Use a ferramenta de renova√ß√£o no painel ‚¨° COMMAND. Contratos de 12+ meses s√£o ideais para estabilidade. Jogadores com Form Score 0 e contrato expirando podem ser dispensados para liberar verba.` });
  } else if (expiring >= 1) {
    const expiringPlayers = teamPlayers.filter(p => p.ContractMonths <= 2).map(p => String(p.PlayerName)).join(', ');
    issues.push({ label: `${expiring} CONTRATO(S) EXPIRANDO`, text: `Aten√ß√£o para: <b style="color:var(--orange)">${expiringPlayers}</b>. Renove antes do pr√≥ximo ciclo.` });
    actions.push({ type: 'warn', label: 'RENOVA√á√ÉO PREVENTIVA', text: `Renove os contratos expirando antes de rodar o pr√≥ximo ciclo mensal. Perder jogadores gratuitamente desperdi√ßa o investimento em buyout j√° feito.` });
  } else if (teamPlayers.length > 0) {
    strengths.push({ label: 'CONTRATOS EST√ÅVEIS', text: `Nenhum contrato cr√≠tico. Time tem estabilidade de roster garantida no curto prazo.` });
  }

  // ‚îÄ‚îÄ FORM / PERFORMANCE ‚îÄ‚îÄ
  if (avgForm < 2 && teamPlayers.length > 0) {
    issues.push({ label: 'PERFORMANCE FRACA', text: `Form Score m√©dio de ${avgForm.toFixed(1)}. Jogadores n√£o est√£o acumulando t√≠tulos, MVPs ou premia√ß√µes.` });
    actions.push({ type: 'warn', label: 'RENOVA√á√ÉO DE PLANTEL', text: `Considere substituir jogadores com Form Score 0 e contratos longos por op√ß√µes com hist√≥rico de MVPs ou T√≠tulos. Use o painel ‚áå COMPARE para identificar upgrades com custo-benef√≠cio favor√°vel. Jogadores com Form Score alto valorizam o Oracle Score e a imagem do time.` });
  } else if (avgForm >= 7) {
    strengths.push({ label: 'ALTA PERFORMANCE', text: `Form Score m√©dio de ${avgForm.toFixed(1)}. Plantel est√° rendendo acima da m√©dia da liga.` });
    if (isRising) actions.push({ type: 'good', label: 'MANTER O RITMO', text: `Com performance elevada, foco agora √© renovar contratos dos jogadores estrela antes que expirem e despertem interesse de outros times. N√£o deixe jogadores com Form Score > 8 chegarem a menos de 3 meses de contrato.` });
  }

  // ‚îÄ‚îÄ RISK ‚îÄ‚îÄ
  if (risk > 65) {
    issues.push({ label: `RISCO ALTO (${risk}/100)`, text: `√çndice de risco elevado. M√∫ltiplos fatores cr√≠ticos simult√¢neos.` });
  } else if (risk < 25) {
    strengths.push({ label: `RISCO BAIXO (${risk}/100)`, text: `Opera√ß√£o est√°vel e segura. Poucas vulnerabilidades detectadas.` });
  }

  // ‚îÄ‚îÄ TIER ‚îÄ‚îÄ
  if (tier === 'tier s' || tier === 'top 1') {
    strengths.push({ label: 'TIER S ‚Äî SPONSOR M√ÅXIMO', text: `Recebendo ${fmt(fins.sponsor)}/m√™s de patroc√≠nio. Status de elite mant√©m o time competitivo financeiramente.` });
    if (isRising) actions.push({ type: 'good', label: 'CONSOLIDAR DOM√çNIO', text: `Time de elite com finan√ßas saud√°veis tem condi√ß√µes de contratar os melhores free agents dispon√≠veis. Mantenha o Oracle Score acima de 80 e foque em renovar contratos de jogadores com MVP para n√£o perder vantagem competitiva.` });
  }

  // ‚îÄ‚îÄ SPECIFIC RISING TIPS ‚îÄ‚îÄ
  if (isRising && issues.length === 0) {
    actions.push({ type: 'good', label: 'ESTRAT√âGIA DE MANUTEN√á√ÉO', text: `Time em ascens√£o sem problemas cr√≠ticos. Prioridades: (1) renovar contratos de jogadores com Form Score alto, (2) manter banco acima de ${fmt(fins.salaries * 4)}, (3) usar Hot Deals oportunisticamente para elevar o teto do plantel sem comprometer o fluxo positivo.` });
    actions.push({ type: 'good', label: 'EXPANS√ÉO INTELIGENTE', text: `Se o banco ultrapassar ${fmt(fins.salaries * 6)}, considere contratar um 2¬∫ bench player de alto valor ou buscar upgrade em posi√ß√£o de starter com Form Score baixo. Equipes de elite mant√™m 2‚Äì3 bench players para rota√ß√£o e prote√ß√£o contra imprevistos.` });
  }

  // ‚îÄ‚îÄ BUILD HTML ‚îÄ‚îÄ
  const statusColor = isFalling ? 'var(--red)' : isRising ? 'var(--green)' : 'var(--cyan)';
  const statusLabel = isFalling ? '‚ö† REQUER INTERVEN√á√ÉO' : isRising ? '‚úì EM ASCENS√ÉO' : '‚óà EST√ÅVEL';

  let html = `
    <div class="intel-detail-card">
      <div class="intel-detail-title">
        <span style="color:${oracle.color}">${tName}</span>
        <span style="font-family:var(--font-data); font-size:11px; padding:4px 12px; background:${statusColor}22; color:${statusColor}; border:1px solid ${statusColor}44;">${statusLabel}</span>
        <span style="font-family:var(--font-data); font-size:11px; color:var(--text-dim); margin-left:auto;">ORACLE ${oracle.score} ‚Äî GRADE ${oracle.grade}</span>
      </div>

      <!-- DIAGNOSTICS GRID -->
      <div class="intel-section">
        <div class="intel-section-title">DIAGN√ìSTICO ATUAL</div>
        <div class="intel-diag-grid">
          <div class="intel-diag-item">
            <div class="d-val" style="color:${fins.net>=0?'var(--green)':'var(--red)'}">${fins.net>=0?'+':''}${fmtK(fins.net)}</div>
            <div class="d-lbl">NET / M√äS</div>
          </div>
          <div class="intel-diag-item">
            <div class="d-val" style="color:${bank>=0?'var(--cyan)':'var(--red)'}">${fmtK(bank)}</div>
            <div class="d-lbl">BANCO ATUAL</div>
          </div>
          <div class="intel-diag-item">
            <div class="d-val" style="color:${starters>=5?'var(--green)':'var(--orange)'}">${starters}/5</div>
            <div class="d-lbl">STARTERS</div>
          </div>
          <div class="intel-diag-item">
            <div class="d-val" style="color:${expiring>=3?'var(--red)':expiring>=1?'var(--orange)':'var(--green)'}">${expiring}</div>
            <div class="d-lbl">EXPIRANDO</div>
          </div>
          <div class="intel-diag-item">
            <div class="d-val" style="color:${avgForm>=5?'var(--green)':avgForm>=2?'var(--yellow)':'var(--orange)'}">${avgForm.toFixed(1)}</div>
            <div class="d-lbl">FORM M√âDIO</div>
          </div>
          <div class="intel-diag-item">
            <div class="d-val" style="color:${risk>65?'var(--red)':risk>35?'var(--orange)':'var(--green)'}">${risk}</div>
            <div class="d-lbl">RISK INDEX</div>
          </div>
        </div>
      </div>
  `;

  if (strengths.length > 0) {
    html += `<div class="intel-section"><div class="intel-section-title">PONTOS FORTES (${strengths.length})</div>`;
    strengths.forEach(s => {
      html += `<div class="intel-tip good"><div class="tip-label">‚úì ${s.label}</div><div class="tip-text">${s.text}</div></div>`;
    });
    html += `</div>`;
  }

  if (issues.length > 0) {
    html += `<div class="intel-section"><div class="intel-section-title">PROBLEMAS DETECTADOS (${issues.length})</div>`;
    issues.forEach(s => {
      html += `<div class="intel-tip bad"><div class="tip-label">‚úó ${s.label}</div><div class="tip-text">${s.text}</div></div>`;
    });
    html += `</div>`;
  }

  if (actions.length > 0) {
    html += `<div class="intel-section"><div class="intel-section-title">PLANO DE A√á√ÉO ‚Äî ${actions.length} RECOMENDA√á√ÉO(√ïES)</div>`;
    actions.forEach((a,i) => {
      html += `<div class="intel-tip ${a.type}"><div class="tip-label">${i+1}. ${a.label}</div><div class="tip-text">${a.text}</div></div>`;
    });
    html += `</div>`;
  }

  html += `</div>`;
  $('intel-detail').innerHTML = html;
  $('intel-detail').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function launchApp() {
  if (!finLoaded || !plyLoaded) return;
  $('upload-overlay').style.display = 'none';
  $('app').classList.add('visible');
  updateAll();
  addLog('NEXUS COMMAND initialized. Intelligence online.', 'good');
}

function showPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  $(id).classList.add('active');
  if (btn) btn.classList.add('active');
}

/* ‚ïê‚ïê‚ïê CORE CALCULATIONS ‚ïê‚ïê‚ïê */
function getPlayerBuyout(p) {
  const std = p.MarketValue * 0.10 * (p.ContractMonths||0) * 1.5;
  const off = temporaryOffers[String(p.PlayerName)];
  return off !== undefined ? off : std;
}

function getFormScore(p) {
  return ((p.MVP||0)*10) + ((p.EVP||0)*5) + ((p.VP||0)*2) + ((p.Titles||0)*1);
}

function canAddBench(team) {
  return players.filter(p => p.TeamName===team && p.Role==='Bench').length < 3;
}

function getTeamFinances(team) {
  let sponsor = 0;
  const tier = String(team.Tier||'').toLowerCase().trim();
  if (tier==='tier s') sponsor=70000;
  else if (tier==='tier 1'||tier==='top 1') sponsor=55000;
  else if (tier==='tier 2') sponsor=40000;
  else if (tier==='tier 3') sponsor=30000;
  if (team.sponsorshipBoost) sponsor *= 1.5;
  const getVal = (obj, key) => Number(obj[key] || (key==='HealthTeam' ? obj['HeathTeam'] : 0) || 0);
  const fixed = ['Coach','Analyst','HealthTeam','PhysicalTeam','Maintenance','Marketing'].reduce((s,k)=>s+getVal(team,k),0);
  const salaries = players.filter(p=>p.TeamName===team.TeamName).reduce((s,p)=>s+(p.MarketValue||0)*0.10,0);
  return { sponsor, fixed, salaries, net: sponsor-(fixed+salaries) };
}

/* NEXUS ORACLE ‚Äî team health score 0-100 */
function getOracleScore(teamName) {
  const team = finances.find(t=>t.TeamName===teamName);
  if (!team) return {score:0, grade:'F', color:getComputedStyle(document.documentElement).getPropertyValue('--red').trim()};
  const fins = getTeamFinances(team);
  const bank = team.CurrentBank||0;
  const starters = players.filter(p=>p.TeamName===teamName&&p.Role==='Starter').length;
  const bench = players.filter(p=>p.TeamName===teamName&&p.Role==='Bench').length;
  const expiring = players.filter(p=>p.TeamName===teamName&&p.ContractMonths<=2).length;
  const totalPlayers = players.filter(p=>p.TeamName===teamName).length;
  const avgForm = totalPlayers ? players.filter(p=>p.TeamName===teamName).reduce((s,p)=>s+getFormScore(p),0)/totalPlayers : 0;

  let score = 0;
  // Financial health (40 pts)
  if (fins.net > 15000) score+=40;
  else if (fins.net > 5000) score+=30;
  else if (fins.net > 0) score+=18;
  else if (fins.net > -10000) score+=6;
  // Bank reserve (20 pts)
  const months = fins.salaries>0 ? bank/fins.salaries : 6;
  score += clamp(months/6*20, 0, 20);
  // Roster completeness (25 pts)
  score += clamp(starters/5*15, 0, 15);
  score += clamp(bench/3*10, 0, 10);
  // Contract stability (10 pts)
  if (totalPlayers>0) score += clamp((1 - expiring/totalPlayers)*10, 0, 10);
  // Form bonus (5 pts)
  score += clamp(avgForm/10*5, 0, 5);

  score = Math.round(clamp(score,0,100));
  let grade='F', color='#ff1744';
  if (score>=90) { grade='S+'; color='#00d4ff'; }
  else if (score>=80) { grade='A'; color='#00ff88'; }
  else if (score>=65) { grade='B'; color='#b4f700'; }
  else if (score>=50) { grade='C'; color='#ffd600'; }
  else if (score>=35) { grade='D'; color='#ff9800'; }
  else { grade='F'; color='#ff1744'; }
  return {score, grade, color};
}

/* RISK INDEX 0-100 (higher = more dangerous) */
function getRiskIndex(teamName) {
  const team = finances.find(t=>t.TeamName===teamName);
  if (!team) return 100;
  const fins = getTeamFinances(team);
  const bank = team.CurrentBank||0;
  let risk = 0;
  if (fins.net < 0) risk += 35;
  else if (fins.net < 5000) risk += 15;
  if (bank < 0) risk += 30;
  else if (bank < fins.salaries*2) risk += 15;
  const expiring = players.filter(p=>p.TeamName===teamName&&p.ContractMonths<=2).length;
  risk += expiring * 5;
  const starters = players.filter(p=>p.TeamName===teamName&&p.Role==='Starter').length;
  risk += (5-starters)*8;
  return clamp(risk,0,100);
}

/* SMART HOT DEALS */
function getSmartHotDeals(activeTeamName) {
  const team = finances.find(t=>t.TeamName===activeTeamName);
  if (!team) return [];
  const bank = team.CurrentBank||0;
  const fins = getTeamFinances(team);
  const safetyReserve = (fins.fixed + fins.salaries)*3;
  const deals = [];

  players.filter(p=>{
    if (p.TeamName===activeTeamName) return false;
    const isOffer = temporaryOffers[String(p.PlayerName)]!==undefined;
    const isExpiring = p.ContractMonths<=1 && p.TeamName!=='none';
    return isOffer || isExpiring || p.TeamName==='none';
  }).forEach(p=>{
    const buyout = p.TeamName==='none'?0:getPlayerBuyout(p);
    const sal = (p.MarketValue||0)*0.10;
    const sixImpact = sal*6;
    const bankAfter = bank-buyout;
    const newNet = fins.net-sal;
    if (bankAfter < safetyReserve) return;
    if (newNet < 0) return;
    if (sixImpact > bankAfter*0.60) return;
    const vScore = (p.MarketValue||0)/Math.max(buyout+sixImpact,1);
    deals.push({player:p, buyout, sal, sixImpact, bankAfter, newNet, vScore: vScore+getFormScore(p)*0.1, isDiscounted: temporaryOffers[String(p.PlayerName)]!==undefined});
  });

  deals.sort((a,b)=>b.vScore-a.vScore);
  return deals.slice(0,4);
}

/* MEDALS HTML */
function medals(p) {
  let s='';
  if (p.MVP) s+=`<span class="badge badge-yellow">ü•á${p.MVP}</span> `;
  if (p.EVP) s+=`<span class="badge badge-ghost">ü•à${p.EVP}</span> `;
  if (p.VP) s+=`<span class="badge badge-ghost">ü•â${p.VP}</span> `;
  if (p.Titles) s+=`<span class="badge badge-cyan">üèÜ${p.Titles}</span> `;
  return s;
}

/* PLAYER PROFILE MODAL */
function openPlayerProfile(name) {
  const p = players.find(x => String(x.PlayerName) === name);
  if (!p) return;
  const form = getFormScore(p);
  const sal = (p.MarketValue||0)*0.10;
  const buyout = p.TeamName==='none' ? 0 : getPlayerBuyout(p);
  const prevMV = p['Previous MV']||0;
  const mvDiff = (p.MarketValue||0) - prevMV;
  const hasPrev = prevMV > 0;

  // Career totals (already accumulated + current season)
  const totalMVP = (p['Total MVP']||0) + (p.MVP||0);
  const totalEVP = (p['Total EVP']||0) + (p.EVP||0);
  const totalVP  = (p['Total VP']||0)  + (p.VP||0);
  const totalTitles = (p['Total Titles']||0) + (p.Titles||0);

  const overlay = document.createElement('div');
  overlay.className = 'player-modal-overlay';
  overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };

  overlay.innerHTML = `
    <div class="player-modal">
      <button class="pm-close" onclick="this.closest('.player-modal-overlay').remove()">&times;</button>
      <div class="pm-header">
        <div class="pm-name">${String(p.PlayerName)}</div>
        <div class="pm-sub">${p.TeamName==='none'?'FREE AGENT':p.TeamName} ‚Ä¢ ${p.Role} ‚Ä¢ Contract: ${p.ContractMonths||0}m ${medals(p)}</div>
      </div>
      <div class="pm-body">

        <!-- FINANCIAL -->
        <div class="pm-section-title">FINANCIAL OVERVIEW</div>
        <div class="pm-stats-grid">
          <div class="pm-stat"><div class="v" style="color:var(--cyan)">${fmt(p.MarketValue||0)}</div><div class="l">MARKET VALUE</div></div>
          <div class="pm-stat"><div class="v" style="color:var(--orange)">${fmt(sal)}/mo</div><div class="l">SALARY</div></div>
          <div class="pm-stat"><div class="v" style="color:var(--green)">${p.TeamName==='none'?'FREE':fmt(buyout)}</div><div class="l">BUYOUT</div></div>
          <div class="pm-stat"><div class="v" style="color:var(--yellow)">${form}</div><div class="l">FORM SCORE</div></div>
        </div>

        ${hasPrev ? `
        <!-- MV COMPARISON -->
        <div class="pm-section-title">MARKET VALUE vs PREVIOUS SEASON</div>
        <div class="pm-mv-compare">
          <div class="mv-box">
            <div class="v" style="color:var(--text-dim)">${fmt(prevMV)}</div>
            <div class="l">PREVIOUS MV</div>
          </div>
          <div class="mv-arrow">‚Üí</div>
          <div class="mv-box">
            <div class="v" style="color:var(--cyan)">${fmt(p.MarketValue||0)}</div>
            <div class="l">CURRENT MV</div>
          </div>
          <div class="mv-box" style="border:1px solid ${mvDiff>=0?'var(--green)':'var(--red)'}44;">
            <div class="v" style="color:${mvDiff>=0?'var(--green)':'var(--red)'}">${mvDiff>=0?'+':''}${fmt(mvDiff)}</div>
            <div class="l">CHANGE</div>
          </div>
        </div>
        ` : ''}

        <!-- CURRENT SEASON MEDALS -->
        <div class="pm-section-title">CURRENT SEASON MEDALS</div>
        <div class="pm-medal-row">
          <div class="pm-medal"><div class="icon">ü•á</div><div class="cnt" style="color:var(--yellow)">${p.MVP||0}</div><div class="lbl">MVP</div></div>
          <div class="pm-medal"><div class="icon">ü•à</div><div class="cnt" style="color:#b0bec5">${p.EVP||0}</div><div class="lbl">EVP</div></div>
          <div class="pm-medal"><div class="icon">ü•â</div><div class="cnt" style="color:#ff7043">${p.VP||0}</div><div class="lbl">VP</div></div>
          <div class="pm-medal"><div class="icon">üèÜ</div><div class="cnt" style="color:var(--cyan)">${p.Titles||0}</div><div class="lbl">TITLES</div></div>
        </div>

        <!-- CAREER TOTAL MEDALS -->
        <div class="pm-section-title">CAREER TOTAL (ALL SEASONS)</div>
        <div class="pm-medal-row">
          <div class="pm-medal" style="border-color:var(--yellow)44;"><div class="icon">ü•á</div><div class="cnt" style="color:var(--yellow)">${totalMVP}</div><div class="lbl">TOTAL MVP</div></div>
          <div class="pm-medal"><div class="icon">ü•à</div><div class="cnt" style="color:#b0bec5">${totalEVP}</div><div class="lbl">TOTAL EVP</div></div>
          <div class="pm-medal"><div class="icon">ü•â</div><div class="cnt" style="color:#ff7043">${totalVP}</div><div class="lbl">TOTAL VP</div></div>
          <div class="pm-medal" style="border-color:var(--cyan)44;"><div class="icon">üèÜ</div><div class="cnt" style="color:var(--cyan)">${totalTitles}</div><div class="lbl">TOTAL TITLES</div></div>
        </div>

        <!-- PRIZE POOL -->
        <div class="pm-section-title">üí∞ PRIZE POOL</div>
        <div class="pm-stats-grid" style="grid-template-columns:1fr;">
          <div class="pm-stat"><div class="v" style="color:var(--purple)">${fmt(p.PrizePool||0)}</div><div class="l">TOTAL EARNINGS (TOURNAMENTS + AWARDS)</div></div>
        </div>

      </div>
    </div>
  `;

  document.body.appendChild(overlay);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UPDATE ALL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateAll() {
  populateDropdowns();
  populateCompareDrops();
  updateCommand();
  updateLeague();
  updateContractAlerts();
  updateTicker();
  updateTopbarStatus();
}

function populateDropdowns() {
  const opts = finances.map(t=>`<option value="${t.TeamName}">${t.TeamName}</option>`).join('');
  $('tourney-team-select').innerHTML = opts;
  $('reset-team-select').innerHTML = opts;
  const mktOpts = `<option value="all">All Teams</option><option value="my_roster">üõ° My Roster</option><option value="offers">üî• On Sale</option>` + opts;
  $('market-team-filter').innerHTML = mktOpts;
  const dashSel = $('dash-team-select');
  const cur = dashSel.value;
  dashSel.innerHTML = opts;
  if (cur && finances.some(t=>t.TeamName===cur)) dashSel.value=cur;
  $('perf-player-select').innerHTML = players.map(p=>`<option value="${String(p.PlayerName)}">${String(p.PlayerName)} (${p.TeamName})</option>`).join('');
  updateRenewDropdown($('dash-team-select').value);
}

function updateRenewDropdown(tName) {
  let o=`<option value="all">‚Äî Entire Roster ‚Äî</option>`;
  players.filter(p=>p.TeamName===tName).forEach(p=>o+=`<option value="${String(p.PlayerName)}">${String(p.PlayerName)} [${p.ContractMonths}m left]</option>`);
  $('dash-renew-target').innerHTML=o;
}

function updateTopbarStatus() {
  $('status-teams').textContent = finances.length + ' TEAMS';
  $('status-players').textContent = players.length + ' PLAYERS';
  $('month-counter').textContent = `MONTH ${String(monthCounter).padStart(2,'0')} ‚Äî NEXUS COMMAND`;
  $('month-num').textContent = monthCounter;

  const critAlerts = finances.filter(t=>getTeamFinances(t).net<0).length + players.filter(p=>p.TeamName!=='none'&&p.ContractMonths<=0).length;
  if (critAlerts > 0) {
    $('status-alerts').style.display='flex';
    $('status-alerts').textContent = `‚ö† ${critAlerts} CRITICAL`;
    $('alert-badge').style.display='inline';
    $('alert-badge').textContent = critAlerts;
  } else {
    $('status-alerts').style.display='none';
    $('alert-badge').style.display='none';
  }
}

function updateTicker() {
  const items = [];
  // Include ALL teams in the ticker
  finances.forEach(t=>{
    const {net} = getTeamFinances(t);
    const cls = net>=0?'up':'down';
    items.push(`<span class="tick-item ${cls}">${t.TeamName}: ${net>=0?'+':''}${fmtK(net)}/mo</span>`);
  });
  // Add top form players
  players.filter(p=>getFormScore(p)>5).sort((a,b)=>getFormScore(b)-getFormScore(a)).slice(0,4).forEach(p=>{
    items.push(`<span class="tick-item up">‚≠ê ${String(p.PlayerName)} FORM:${getFormScore(p)}</span>`);
  });
  // Add expiring contracts
  const expiring = players.filter(p=>p.TeamName!=='none'&&p.ContractMonths<=1);
  expiring.slice(0,3).forEach(p=>{
    items.push(`<span class="tick-item warn">‚ö° ${String(p.PlayerName)} CONTRACT EXPIRING (${p.ContractMonths}m)</span>`);
  });
  
  // Create the content string
  const separator = '<span style="color:var(--border); margin:0 20px;">|</span>';
  const contentStr = items.join(separator);
  
  // Duplicate content for seamless infinite loop
  const tickerEl = $('ticker-content');
  tickerEl.innerHTML = contentStr + separator + contentStr;
  
  // Calculate animation duration based on number of items (more items = slower scroll)
  const duration = Math.max(30, items.length * 3); // 3 seconds per item, minimum 30s
  tickerEl.style.setProperty('--ticker-duration', duration + 's');
  
  // Add animation class
  tickerEl.classList.add('animated');
}

/* ‚ïê‚ïê‚ïê COMMAND PANEL ‚ïê‚ïê‚ïê */
function updateCommand() {
  const tName = $('dash-team-select').value;
  const team = finances.find(t=>t.TeamName===tName);
  if (!team) return;
  updateRenewDropdown(tName);

  const {sponsor, fixed, salaries, net} = getTeamFinances(team);
  const bank = team.CurrentBank||0;
  const oracle = getOracleScore(tName);
  const risk = getRiskIndex(tName);

  // Oracle ring
  const circ = 2*Math.PI*45;
  const dash = circ*(oracle.score/100);
  $('cmd-oracle-wrap').innerHTML = `
    <div class="oracle-ring" style="margin-bottom:12px;">
      <svg viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" fill="none" stroke="var(--bg3)" stroke-width="6"/>
        <circle cx="50" cy="50" r="45" fill="none" stroke="${oracle.color}" stroke-width="6"
          stroke-dasharray="${dash} ${circ-dash}" stroke-linecap="round"
          style="filter:drop-shadow(0 0 6px ${oracle.color});"/>
      </svg>
      <div class="oracle-score-text">
        <div class="num" style="color:${oracle.color}">${oracle.score}</div>
        <div class="lbl">GRADE ${oracle.grade}</div>
      </div>
    </div>
    <div style="font-family:var(--font-data); font-size:11px; display:flex; justify-content:space-between; margin-bottom:4px;">
      <span style="color:var(--text-dim);">RISK INDEX</span>
      <span style="color:${risk>60?'var(--red)':risk>35?'var(--orange)':'var(--green)'}">${risk}/100</span>
    </div>
    <div class="risk-bar"><div class="risk-indicator" style="left:${risk}%"></div></div>
  `;

  // Stats
  const starters = players.filter(p=>p.TeamName===tName&&p.Role==='Starter').length;
  const bench = players.filter(p=>p.TeamName===tName&&p.Role==='Bench').length;
  const months = salaries>0?(bank/salaries).toFixed(1):'‚àû';
  $('cmd-stat-row').innerHTML = `
    <div class="stat-box cyan"><div class="lbl">BANK BALANCE</div><div class="val">${fmtK(bank)}</div><div class="sub">${months}mo runway</div></div>
    <div class="stat-box ${net>=0?'green':'red'}"><div class="lbl">MONTHLY NET</div><div class="val">${net>=0?'+':''}${fmtK(net)}</div><div class="sub">${net>=0?'Profitable':'LOSING MONEY'}</div></div>
    <div class="stat-box ${starters>=5?'green':'orange'}"><div class="lbl">STARTERS</div><div class="val">${starters}/5</div><div class="sub">${bench} benched</div></div>
    <div class="stat-box ${oracle.score>=65?'cyan':'red'}"><div class="lbl">ORACLE SCORE</div><div class="val" style="color:${oracle.color}">${oracle.score}</div><div class="sub">Grade ${oracle.grade}</div></div>
  `;

  // Finances
  const boostBadge = team.sponsorshipBoost?`<span class="badge badge-green" style="margin-left:8px;">50% BOOST</span>`:'';
  $('cmd-finances').innerHTML = `
    <div style="font-family:var(--font-data); font-size:22px; font-weight:700; color:var(--cyan); margin-bottom:10px;">${fmt(bank)}</div>
    <div class="list-row" style="padding:5px 0;"><span style="color:var(--text-dim);">Sponsor Income</span><span style="color:var(--green);">+${fmt(sponsor)}${boostBadge}</span></div>
    <div class="list-row" style="padding:5px 0;"><span style="color:var(--text-dim);">Fixed Costs</span><span style="color:var(--red);">‚àí${fmt(fixed)}</span></div>
    <div class="list-row" style="padding:5px 0;"><span style="color:var(--text-dim);">Player Salaries</span><span style="color:var(--red);">‚àí${fmt(salaries)}</span></div>
    <div style="border-top:1px solid var(--border); margin-top:8px; padding-top:8px; display:flex; justify-content:space-between; font-weight:700; font-family:var(--font-display); font-size:13px;">
      <span>NET / MONTH</span><span style="color:${net>=0?'var(--green)':'var(--red)'}">${net>=0?'+':''}${fmt(net)}</span>
    </div>
  `;

  // Roster
  const rosterHtml = players.filter(p=>p.TeamName===tName).map(p=>`
    <div class="list-row">
      <div>
        <div class="name" style="cursor:pointer; text-decoration:underline; text-decoration-color:var(--border); text-underline-offset:3px;" onclick="openPlayerProfile('${String(p.PlayerName).replace(/'/g,"\\'")}')">${String(p.PlayerName)}</div>
        <div class="meta">${p.Role} ‚Ä¢ Contract: ${p.ContractMonths}m ‚Ä¢ ${fmt(p.MarketValue*0.10)}/mo ${medals(p)}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="toggleRole('${String(p.PlayerName).replace(/'/g,"\\'")}')">üîÑ ${p.Role==='Starter'?'BENCH':'START'}</button>
    </div>
  `).join('') || '<div style="color:var(--text-dim); padding:10px; font-size:12px;">No players on roster.</div>';
  $('cmd-roster').innerHTML = rosterHtml;

  // AI Scout (smart hot deals)
  const deals = getSmartHotDeals(tName);
  let aiHtml='';
  if (net<0) aiHtml+=`<div class="alert-item critical" style="margin-bottom:8px; font-size:12px;">‚õî CRITICAL: Team is losing ${fmt(Math.abs(net))}/mo</div>`;
  else if (net<5000) aiHtml+=`<div class="alert-item warning" style="margin-bottom:8px; font-size:12px;">‚ö† Thin margins. Signing high-salary players is risky.</div>`;
  else aiHtml+=`<div class="alert-item success" style="margin-bottom:8px; font-size:12px;">‚úì Finances nominal. Acquisition capacity confirmed.</div>`;
  if (starters<5) aiHtml+=`<div class="alert-item critical" style="margin-bottom:8px; font-size:12px;">üö® CRITICAL ROSTER GAP: ${starters}/5 starters active!</div>`;

  if (deals.length>0) {
    aiHtml+=`<div style="font-family:var(--font-display); font-size:10px; letter-spacing:2px; color:var(--green); margin:10px 0 6px;">üî• VERIFIED HOT DEALS</div>`;
    deals.forEach(d=>{
      const p=d.player;
      const tag=p.TeamName==='none'?'<span class="badge badge-cyan">FREE AGENT</span>'
        :d.isDiscounted?'<span class="badge badge-green">ON SALE</span>'
        :'<span class="badge badge-orange">EXPIRING</span>';
      aiHtml+=`<div style="background:var(--bg); padding:8px 10px; margin-bottom:5px; border-left:2px solid var(--green); font-size:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <b>${String(p.PlayerName)}</b> ${tag}
        </div>
        <div style="color:var(--text-dim); font-family:var(--font-data); font-size:10px; margin-top:4px;">
          Buyout: ${fmt(d.buyout)} | 6m Impact: ${fmt(d.sixImpact)} | New Net: <span style="color:var(--green)">+${fmt(d.newNet)}</span>
        </div>
      </div>`;
    });
  } else {
    aiHtml+=`<div style="color:var(--text-dim); font-family:var(--font-data); font-size:11px; margin-top:8px;">No financially-verified deals available for your current budget.</div>`;
  }
  $('cmd-ai-scout').innerHTML=aiHtml;

  // Forecast canvas
  drawForecast(tName, team, net);

  // Inbound offers
  renderInboundOffers(tName);
  refreshMarket();
  renderOutboundOffers();
  updateHotDealsList();
}

/* 6-month forecast */
function drawForecast(tName, team, netMonth) {
  const canvas = $('forecast-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * window.devicePixelRatio || 800;
  canvas.height = 180 * window.devicePixelRatio || 360;
  ctx.scale(window.devicePixelRatio||1, window.devicePixelRatio||1);
  const W = canvas.offsetWidth, H = 180;
  ctx.clearRect(0,0,W,H);

  const months = 6;
  const bank = team.CurrentBank||0;
  const points = Array.from({length:months+1},(_,i)=>bank + netMonth*i);
  const mn = Math.min(...points), mx = Math.max(...points);
  const range = mx-mn||1;
  const pad = {t:20,b:30,l:60,r:20};
  const iW = W-pad.l-pad.r, iH = H-pad.t-pad.b;

  // Grid
  ctx.strokeStyle='rgba(0,212,255,0.08)';
  ctx.lineWidth=1;
  for (let i=0;i<=4;i++) {
    const y = pad.t + iH*(1-i/4);
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+iW,y); ctx.stroke();
    ctx.fillStyle='rgba(0,212,255,0.4)';
    ctx.font=`10px 'Share Tech Mono'`;
    ctx.fillText(fmtK(mn+range*(i/4)), 2, y+4);
  }

  // Zero line
  if (mn<0 && mx>0) {
    const zy = pad.t + iH*(1-(0-mn)/range);
    ctx.strokeStyle='rgba(255,23,68,0.4)';
    ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(pad.l,zy); ctx.lineTo(pad.l+iW,zy); ctx.stroke(); ctx.setLineDash([]);
  }

  // Fill gradient
  const grad = ctx.createLinearGradient(0,pad.t,0,pad.t+iH);
  const posColor = netMonth>=0?'rgba(0,255,136,0.3)':'rgba(255,23,68,0.3)';
  grad.addColorStop(0, posColor); grad.addColorStop(1,'rgba(0,0,0,0)');
  ctx.beginPath();
  points.forEach((v,i)=>{
    const x=pad.l+iW*(i/months), y=pad.t+iH*(1-(v-mn)/range);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.lineTo(pad.l+iW,pad.t+iH); ctx.lineTo(pad.l,pad.t+iH); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();

  // Line
  const lineColor = netMonth>=0?'#00ff88':'#ff1744';
  ctx.strokeStyle=lineColor; ctx.lineWidth=2; ctx.setLineDash([]);
  ctx.shadowColor=lineColor; ctx.shadowBlur=8;
  ctx.beginPath();
  points.forEach((v,i)=>{
    const x=pad.l+iW*(i/months), y=pad.t+iH*(1-(v-mn)/range);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke(); ctx.shadowBlur=0;

  // Dots
  points.forEach((v,i)=>{
    const x=pad.l+iW*(i/months), y=pad.t+iH*(1-(v-mn)/range);
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2);
    ctx.fillStyle=v<0?'#ff1744':lineColor; ctx.fill();
    ctx.font=`9px 'Share Tech Mono'`; ctx.fillStyle='rgba(0,212,255,0.7)';
    ctx.fillText(`M${i+1}`, x-8, H-8);
  });
}

/* ‚ïê‚ïê‚ïê LEAGUE PANEL ‚ïê‚ïê‚ïê */
function updateLeague() {
  // Power Rankings
  const ranked = finances.map(t=>{
    const o=getOracleScore(t.TeamName);
    const fins=getTeamFinances(t);
    const formTotal=players.filter(p=>p.TeamName===t.TeamName).reduce((s,p)=>s+getFormScore(p),0);
    return {name:t.TeamName, score:o.score, grade:o.grade, color:o.color, net:fins.net, form:formTotal, bank:t.CurrentBank||0};
  }).sort((a,b)=>b.score-a.score);

  $('league-rankings').innerHTML = ranked.map((t,i)=>`
    <div class="rank-item">
      <div class="rank-num ${i===0?'gold':i===1?'silver':i===2?'bronze':'other'}">${i+1}</div>
      <div style="flex:1">
        <div style="font-weight:700; font-size:14px; display:flex; align-items:center; gap:8px;">
          ${t.name}
          <span class="badge badge-ghost" style="font-size:10px; color:${t.color}; border-color:${t.color};">${t.grade}</span>
        </div>
        <div style="margin-top:4px;">
          <div class="progress-track" style="height:3px;">
            <div class="progress-fill" style="width:${t.score}%; background:${t.color};"></div>
          </div>
        </div>
        <div style="font-family:var(--font-data); font-size:10px; color:var(--text-dim); margin-top:2px;">
          Score: ${t.score} | Net: <span style="color:${t.net>=0?'var(--green)':'var(--red)'}">${t.net>=0?'+':''}${fmtK(t.net)}</span> | Form: ${t.form} | Bank: ${fmtK(t.bank)}
        </div>
      </div>
    </div>
  `).join('');

  // Financial health
  const losing=finances.filter(t=>getTeamFinances(t).net<0);
  const lowMargin=finances.filter(t=>{const n=getTeamFinances(t).net; return n>=0&&n<5000;});
  let hHtml='';
  if (!losing.length&&!lowMargin.length) hHtml='<div class="alert-item success">‚úì All teams operating profitably.</div>';
  losing.forEach(t=>{
    const n=getTeamFinances(t).net;
    hHtml+=`<div class="alert-item critical"><div><b>${t.TeamName}</b><br><span style="font-family:var(--font-data); font-size:11px; color:var(--red);">${fmt(n)}/mo ‚Äî LOSING MONEY</span></div></div>`;
  });
  lowMargin.forEach(t=>{
    const n=getTeamFinances(t).net;
    hHtml+=`<div class="alert-item warning"><div><b>${t.TeamName}</b><br><span style="font-family:var(--font-data); font-size:11px; color:var(--orange);">+${fmt(n)}/mo ‚Äî LOW MARGIN</span></div></div>`;
  });
  $('league-health').innerHTML=hHtml;

  // Roster alerts
  let rHtml='';
  finances.forEach(t=>{
    const starters=players.filter(p=>p.TeamName===t.TeamName&&p.Role==='Starter').length;
    if (starters<5) rHtml+=`<div class="alert-item critical"><b>${t.TeamName}</b><span style="margin-left:auto; font-family:var(--font-data); color:var(--red);">${starters}/5 STARTERS</span></div>`;
  });
  if (!rHtml) rHtml='<div class="alert-item success">‚úì All teams have 5 active starters.</div>';
  $('league-roster').innerHTML=rHtml;

  // Form leaderboard
  const stars=[...players].filter(p=>getFormScore(p)>0).sort((a,b)=>getFormScore(b)-getFormScore(a)).slice(0,8);
  $('league-stars').innerHTML=stars.length ? stars.map((p,i)=>`
    <div class="rank-item" style="padding:7px 10px;">
      <div class="rank-num ${i===0?'gold':i===1?'silver':i===2?'bronze':'other'}" style="font-size:14px; width:24px;">${i+1}</div>
      <div style="flex:1;">
        <div style="font-size:13px; font-weight:600;"><span style="cursor:pointer; text-decoration:underline; text-decoration-color:var(--border); text-underline-offset:3px;" onclick="openPlayerProfile('${String(p.PlayerName).replace(/'/g,"\\'")}')"> ${String(p.PlayerName)}</span> <span style="color:var(--text-dim); font-weight:400; font-size:11px;">(${p.TeamName})</span> ${medals(p)}</div>
        <div style="font-family:var(--font-data); font-size:10px; color:var(--text-dim);">FORM SCORE: <span style="color:var(--yellow);">${getFormScore(p)}</span> | MV: ${fmt(p.MarketValue)}</div>
      </div>
    </div>
  `).join('') : '<div style="color:var(--text-dim); padding:10px; font-size:12px;">No medal holders yet.</div>';

  // Transfer history
  const all=[...pendingTransfers.map(o=>({...o,status:'‚è≥ PENDING'})), ...transferHistory];
  $('league-transfers').innerHTML=all.length ? all.slice(0,10).map(o=>`
    <div class="list-row">
      <div><div class="name" style="font-size:12px;">${o.playerName}</div>
        <div class="meta">${o.buyer} ‚Üê ${o.seller} for ${fmt(o.amount)}</div></div>
      <span style="font-family:var(--font-data); font-size:11px; color:${o.status.includes('‚úÖ')?'var(--green)':o.status.includes('‚ùå')?'var(--red)':'var(--orange)'};">${o.status}</span>
    </div>`).join('')
  : '<div style="color:var(--text-dim); padding:10px; font-size:12px;">No transfers recorded.</div>';
}

/* ‚ïê‚ïê‚ïê MARKET ‚ïê‚ïê‚ïê */
function updateHotDealsList() {
  const tName=$('dash-team-select').value;
  const deals=getSmartHotDeals(tName);
  const bank=(finances.find(t=>t.TeamName===tName)||{}).CurrentBank||0;
  if (!deals.length) {
    $('hot-deals-list').innerHTML='<div style="color:var(--text-dim); font-size:12px; font-family:var(--font-data);">No financially-verified deals for your current budget.</div>';
    return;
  }
  $('hot-deals-list').innerHTML=deals.map(d=>{
    const p=d.player;
    const pct=(d.sixImpact/Math.max(bank,1)*100).toFixed(0);
    const tag=p.TeamName==='none'?'<span class="badge badge-cyan">FA</span>':d.isDiscounted?'<span class="badge badge-green">SALE</span>':'<span class="badge badge-orange">EXPIRING</span>';
    return `<div style="background:var(--bg); padding:10px; margin-bottom:6px; border:1px solid rgba(0,255,136,0.2); border-left:3px solid var(--green);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <span style="font-weight:700;">${String(p.PlayerName)}</span> ${tag}
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px; font-family:var(--font-data); font-size:10px; color:var(--text-dim);">
        <span>Buyout: <b style="color:var(--text)">${fmt(d.buyout)}</b></span>
        <span>6m Impact: <b style="color:var(--orange)">${fmt(d.sixImpact)}</b></span>
        <span>Bank after: <b style="color:var(--text)">${fmt(d.bankAfter)}</b></span>
        <span>New Net/mo: <b style="color:var(--green)">+${fmt(d.newNet)}</b></span>
      </div>
      <div style="margin-top:6px;"><div class="progress-track" style="height:3px;"><div class="progress-fill" style="width:${clamp(pct,0,100)}%; background:${pct>50?'var(--red)':pct>25?'var(--orange)':'var(--green)'};"></div></div><div style="font-family:var(--font-data); font-size:9px; color:var(--text-dim); margin-top:2px;">${pct}% of bank over 6 months</div></div>
    </div>`;
  }).join('');
}

function refreshMarket() {
  const roleF=$('market-filter').value, teamF=$('market-team-filter').value, sortBy=$('market-sort').value;
  const activeTeam=$('dash-team-select').value;
  const bank=(finances.find(t=>t.TeamName===activeTeam)||{}).CurrentBank||0;
  const fins=getTeamFinances(finances.find(t=>t.TeamName===activeTeam)||{});
  const hotNames=new Set(getSmartHotDeals(activeTeam).map(d=>String(d.player.PlayerName)));
  const mvMin=parseFloat($('filter-mv-min').value)||0, mvMax=parseFloat($('filter-mv-max').value)||Infinity;
  const conMin=parseInt($('filter-con-min').value)||0, conMax=parseInt($('filter-con-max').value)||Infinity;
  const buyMin=parseFloat($('filter-buy-min').value)||0, buyMax=parseFloat($('filter-buy-max').value)||Infinity;
  // New filters for medals and prize pool
  const titlesMin=parseInt($('filter-titles-min').value)||0, titlesMax=parseInt($('filter-titles-max').value)||Infinity;
  const medalsMin=parseInt($('filter-medals-min').value)||0, medalsMax=parseInt($('filter-medals-max').value)||Infinity;
  const prizeMin=parseFloat($('filter-prize-min').value)||0, prizeMax=parseFloat($('filter-prize-max').value)||Infinity;

  let data=players.map(p=>{
    const pn=String(p.PlayerName);
    const isDisc=temporaryOffers[pn]!==undefined;
    const std=p.MarketValue*0.10*(p.ContractMonths||0)*1.5;
    const buyout=isDisc?temporaryOffers[pn]:std;
    const sal=p.MarketValue*0.10, six=sal*6;
    // Calculate total medals and titles
    const totalTitles=(p['Total Titles']||0)+(p.Titles||0);
    const totalMedals=(p['Total MVP']||0)+(p.MVP||0)+(p['Total EVP']||0)+(p.EVP||0)+(p['Total VP']||0)+(p.VP||0);
    const prizePool=p.PrizePool||0;
    return {...p, pn, isDisc, buyout, sal, six, totalTitles, totalMedals, prizePool};
  }).filter(p=>{
    if (teamF!=='my_roster'&&p.TeamName===activeTeam) return false;
    const passRole=roleF==='all'||(roleF==='none'?p.TeamName==='none':p.Role===roleF);
    let passTeam=false;
    if (teamF==='all') passTeam=true;
    else if (teamF==='my_roster') passTeam=p.TeamName===activeTeam;
    else if (teamF==='offers') passTeam=p.isDisc;
    else passTeam=p.TeamName===teamF;
    // Include new filter conditions
    const passTitles=p.totalTitles>=titlesMin&&p.totalTitles<=titlesMax;
    const passMedals=p.totalMedals>=medalsMin&&p.totalMedals<=medalsMax;
    const passPrize=p.prizePool>=prizeMin&&p.prizePool<=prizeMax;
    return passRole&&passTeam&&p.MarketValue>=mvMin&&p.MarketValue<=mvMax&&(p.ContractMonths||0)>=conMin&&(p.ContractMonths||0)<=conMax&&p.buyout>=buyMin&&p.buyout<=buyMax&&passTitles&&passMedals&&passPrize;
  });

  data.sort((a,b)=>{
    if (sortBy==='mv-desc') return b.MarketValue-a.MarketValue;
    if (sortBy==='mv-asc') return a.MarketValue-b.MarketValue;
    if (sortBy==='buy-desc') return b.buyout-a.buyout;
    if (sortBy==='buy-asc') return a.buyout-b.buyout;
    if (sortBy==='imp-desc') return b.six-a.six;
    if (sortBy==='imp-asc') return a.six-b.six;
    return 0;
  });

  const newNetAfter=(p)=>fins.net - p.sal;
  const container=$('market-list'); container.innerHTML='';

  data.forEach(p=>{
    const pct=bank>0?(p.six/bank*100).toFixed(0):'‚àû';
    const impColor=pct>50?'var(--red)':pct>20?'var(--orange)':'var(--green)';
    const newNet=newNetAfter(p);
    const isHot=hotNames.has(p.pn);

    let btnHtml='';
    if (p.TeamName==='none') btnHtml=`<button class="btn btn-cyan btn-sm" onclick="buyFreeAgent('${p.pn.replace(/'/g,"\\'")}')">SIGN FA</button>`;
    else if (p.TeamName===activeTeam) btnHtml=`<button class="btn btn-ghost btn-sm" onclick="createInternalOffer('${p.pn.replace(/'/g,"\\'")}', ${p.buyout})">PUT ON SALE</button>`;
    else if (p.isDisc) btnHtml=`<button class="btn btn-green btn-sm" onclick="buyOffer('${p.pn.replace(/'/g,"\\'")}', ${p.buyout})">BUY OFFER</button>`;
    else btnHtml=`<button class="btn btn-ghost btn-sm" onclick="proposeTransfer('${p.pn.replace(/'/g,"\\'")}', ${p.buyout})">PROPOSE</button>`;

    const row=document.createElement('div'); row.className='list-row';
    row.innerHTML=`
      <div style="flex:1; min-width:0;">
        <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
          <span class="name" style="cursor:pointer; text-decoration:underline; text-decoration-color:var(--border); text-underline-offset:3px;" onclick="event.stopPropagation(); openPlayerProfile('${p.pn.replace(/'/g,"\\'")}')">${p.pn}</span>
          <span style="color:var(--text-dim); font-size:11px;">[${p.TeamName}]</span>
          ${isHot?'<span class="badge badge-green">üî• HOT</span>':''}
          ${p.isDisc?'<span class="badge badge-orange">ON SALE</span>':''}
          ${medals(p)}
        </div>
        <div style="font-family:var(--font-data); font-size:10px; color:var(--text-dim); margin-top:3px; display:flex; gap:12px; flex-wrap:wrap;">
          <span>MV: <b style="color:var(--text)">${fmt(p.MarketValue)}</b></span>
          <span>Sal: <b style="color:var(--text)">${fmt(p.sal)}/mo</b></span>
          <span>6m: <b style="color:${impColor}">${fmt(p.six)} (${pct}%)</b></span>
          <span>Contract: <b style="color:${p.ContractMonths<=2?'var(--orange)':'var(--text)'}">${p.ContractMonths}m</b></span>
          <span>New Net: <b style="color:${newNet>=0?'var(--green)':'var(--red)'}">${newNet>=0?'+':''}${fmt(newNet)}</b></span>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px; flex-shrink:0;">
        <span style="font-family:var(--font-data); font-size:11px; font-weight:700; color:${p.TeamName==='none'?'var(--green)':'var(--text)'};">${p.TeamName==='none'?'FREE':'Buyout: '+fmt(p.buyout)}</span>
        ${btnHtml}
      </div>
    `;
    container.appendChild(row);
  });

  if (!data.length) container.innerHTML='<div style="color:var(--text-dim); padding:20px; text-align:center; font-family:var(--font-data); font-size:12px;">NO RESULTS ‚Äî Adjust filters</div>';
  updateHotDealsList();
}

/* ‚ïê‚ïê‚ïê COMPARISON ENGINE ‚ïê‚ïê‚ïê */
function populateCompareDrops() {
  const opts=players.map(p=>`<option value="${String(p.PlayerName)}">${String(p.PlayerName)} [${p.TeamName}]</option>`).join('');
  $('compare-p1').innerHTML=opts;
  $('compare-p2').innerHTML=opts;
  if (players.length>1) $('compare-p2').selectedIndex=1;
}

function runComparison() {
  const p1n=$('compare-p1').value, p2n=$('compare-p2').value;
  const atName=$('dash-team-select').value;
  if (p1n===p2n) { $('comparison-result').innerHTML='<div class="alert-item warning">Select two different players.</div>'; return; }

  const p1=players.find(p=>String(p.PlayerName)===p1n), p2=players.find(p=>String(p.PlayerName)===p2n);
  const team=finances.find(t=>t.TeamName===atName);
  if (!p1||!p2||!team) { $('comparison-result').innerHTML='<div class="alert-item critical">Load data first.</div>'; return; }

  const bank=team.CurrentBank||0;
  const fins=getTeamFinances(team);
  const safetyReserve=(fins.fixed+fins.salaries)*3;

  function score(p) {
    const buyout=p.TeamName==='none'?0:getPlayerBuyout(p);
    const sal=(p.MarketValue||0)*0.10, six=sal*6;
    const bankAfter=bank-buyout, newNet=fins.net-sal;
    const form=getFormScore(p), vRatio=p.MarketValue/Math.max(buyout,1);
    let sc=0, bd=[];

    // Value ratio (25)
    const vp=clamp(vRatio*5,0,25); sc+=vp;
    bd.push({label:'Value Ratio (MV√∑Buyout)', val:vp.toFixed(1), max:25, color:'#00ff88'});
    // Affordability (25)
    let ap=bank>=buyout+safetyReserve?25:bank>=buyout?10:0; sc+=ap;
    bd.push({label:'Affordability', val:ap, max:25, color:'#00d4ff'});
    // Sustainability (20)
    let sp=newNet>=5000?20:newNet>=0?12:newNet>=-5000?4:0; sc+=sp;
    bd.push({label:'Monthly Sustainability', val:sp, max:20, color:'#ff9800'});
    // 6m safety (15)
    const impPct=bank>0?six/bank:1;
    const ip=clamp(15-impPct*30,0,15); sc+=ip;
    bd.push({label:'6-Month Cost Safety', val:ip.toFixed(1), max:15, color:'#b94fff'});
    // Form (15)
    const fp=clamp(form*1.5,0,15); sc+=fp;
    bd.push({label:'Form & Medals', val:fp.toFixed(1), max:15, color:'#ffd600'});

    const flags=[];
    if (bank<buyout) flags.push({type:'danger', msg:'Cannot afford buyout.'});
    else if (bank<buyout+safetyReserve) flags.push({type:'warn', msg:'Buyout tight ‚Äî safety reserve risk.'});
    if (newNet<0) flags.push({type:'danger', msg:`Salary would cause ${fmt(Math.abs(newNet))}/mo loss.`});
    if (impPct>0.5) flags.push({type:'warn', msg:`6m salary = ${(impPct*100).toFixed(0)}% of bank.`});
    if (p.ContractMonths<=1&&p.TeamName!=='none') flags.push({type:'good', msg:'Expiring contract ‚Äî leverage on buyout.'});
    if (p.TeamName==='none') flags.push({type:'good', msg:'Free agent ‚Äî zero acquisition cost.'});
    if (form>10) flags.push({type:'good', msg:`Top-form player (score ${form}).`});

    return {p, buyout, sal, six, bankAfter, newNet, form, score:clamp(sc,0,100), bd, flags, canAfford:bank>=buyout};
  }

  const a1=score(p1), a2=score(p2);
  const winner=a1.score>=a2.score?'p1':'p2';
  const wData=winner==='p1'?a1:a2, lData=winner==='p1'?a2:a1;
  const diff=Math.abs(a1.score-a2.score);
  const strength=diff<5?'CLOSE CALL':diff<15?'MODERATE ADVANTAGE':'CLEAR RECOMMENDATION';

  function card(a, side) {
    const w=side===winner;
    return `
      <div class="compare-card ${w?'winner':'loser'}">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <span style="font-family:var(--font-display); font-size:14px; font-weight:700; color:${w?'var(--green)':'var(--text)'};">${String(a.p.PlayerName)}</span>
          ${w?'<span class="badge badge-green">RECOMMENDED ‚úì</span>':''}
        </div>
        <div style="font-family:var(--font-data); font-size:10px; color:var(--text-dim); margin-bottom:12px;">[${a.p.TeamName}] ‚Ä¢ ${a.p.Role} ‚Ä¢ ${a.p.ContractMonths}m left ${medals(a.p)}</div>

        <div style="display:flex; flex-direction:column; gap:4px; margin-bottom:12px;">
          ${[
            ['Market Value', fmt(a.p.MarketValue), 'var(--cyan)'],
            ['Buyout Cost', a.p.TeamName==='none'?'$0 (FREE)':fmt(a.buyout), a.canAfford?'var(--green)':'var(--red)'],
            ['Monthly Salary', fmt(a.sal), 'var(--orange)'],
            ['6-Month Impact', fmt(a.six), 'var(--red)'],
            ['Bank After Buyout', fmt(a.bankAfter), a.bankAfter>=0?'var(--text)':'var(--red)'],
            ['New Monthly Net', (a.newNet>=0?'+':'')+fmt(a.newNet), a.newNet>=0?'var(--green)':'var(--red)'],
            ['Form Score', a.form, 'var(--yellow)'],
          ].map(([l,v,c])=>`
            <div style="display:flex; justify-content:space-between; font-size:12px; padding:4px 0; border-bottom:1px solid rgba(0,212,255,0.05);">
              <span style="color:var(--text-dim);">${l}</span>
              <span style="font-family:var(--font-data); font-weight:700; color:${c};">${v}</span>
            </div>`).join('')}
        </div>

        <div style="font-family:var(--font-display); font-size:10px; letter-spacing:2px; color:${w?'var(--green)':'var(--text-dim)'}; margin-bottom:8px;">
          AI SCORE: <span style="font-size:22px;">${a.score.toFixed(1)}</span><span style="font-size:12px;">/100</span>
        </div>
        ${a.bd.map(b=>`
          <div style="margin-bottom:6px;">
            <div style="display:flex; justify-content:space-between; font-family:var(--font-data); font-size:10px; color:var(--text-dim); margin-bottom:2px;">
              <span>${b.label}</span><span style="color:${b.color}">${b.val}/${b.max}</span>
            </div>
            <div class="progress-track"><div class="progress-fill" style="width:${(parseFloat(b.val)/b.max*100)}%; background:${b.color};"></div></div>
          </div>`).join('')}

        ${a.flags.length?`<div style="margin-top:10px; display:flex; flex-direction:column; gap:4px;">
          ${a.flags.map(f=>`<div style="font-size:11px; color:${f.type==='good'?'var(--green)':f.type==='warn'?'var(--orange)':'var(--red)'}">${f.type==='good'?'‚úì':f.type==='warn'?'‚ö†':'‚úó'} ${f.msg}</div>`).join('')}
        </div>`:''}
      </div>`;
  }

  const verdictColor=diff<5?'var(--orange)':'var(--green)';
  $('comparison-result').innerHTML=`
    <div class="compare-grid" style="margin-top:16px;">
      ${card(a1,'p1')}
      <div class="compare-vs">VS</div>
      ${card(a2,'p2')}
    </div>
    <div class="card" style="margin-top:12px; border-color:${verdictColor};">
      <div class="card-title" style="color:${verdictColor};">ü§ñ NEXUS VERDICT ‚Äî ${strength}</div>
      ${!wData.canAfford&&!lData.canAfford?
        `<div class="alert-item critical">‚õî Your budget cannot cover either player's buyout right now. Build reserves first.</div>`:
        `<div style="font-size:13px; line-height:1.8;">
          <div>‚úÖ <b>${String(wData.p.PlayerName)}</b> scores <b>${wData.score}/100</b> vs ${lData.score}/100 ‚Äî ${diff<5?'narrowly':'clearly'} the better acquisition.</div>
          ${wData.buyout<lData.buyout?`<div>üí∞ Saves ${fmt(lData.buyout-wData.buyout)} upfront in buyout costs.</div>`:''}
          ${wData.sal<lData.sal?`<div>üìÜ Lower monthly commitment: ${fmt(wData.sal)} vs ${fmt(lData.sal)}/mo.</div>`:''}
          ${wData.newNet>lData.newNet?`<div>üìà Healthier post-signing net: <span style="color:var(--green)">${wData.newNet>=0?'+':''}${fmt(wData.newNet)}</span> vs ${lData.newNet>=0?'+':''}${fmt(lData.newNet)}.</div>`:''}
          ${wData.form>lData.form?`<div>‚≠ê Superior form (${wData.form} vs ${lData.form}) ‚Äî higher MV growth potential.</div>`:''}
          ${diff<5?`<div style="color:var(--text-dim); margin-top:8px; font-size:12px;">Scores nearly identical. Consider team positional needs.</div>`:''}
        </div>`}
    </div>
  `;
}

/* ‚ïê‚ïê‚ïê INBOUND OFFERS ‚ïê‚ïê‚ïê */
function renderInboundOffers(tName) {
  const myOff=pendingTransfers.filter(o=>o.seller===tName);
  let html='';
  if (myOff.length) {
    html=`<div class="offer-panel"><div class="offer-header">üõé PENDING TRANSFER OFFERS ‚Äî ACTION REQUIRED</div>`;
    myOff.forEach(o=>{
      const p=o.amount-o.standardBuyout;
      html+=`<div class="offer-row">
        <div><b style="font-size:13px;">${o.buyer}</b> offers <b style="color:var(--cyan)">${fmt(o.amount)}</b> for <b>${o.playerName}</b><br>
        <span style="font-family:var(--font-data); font-size:10px; color:var(--text-dim);">Std Buyout: ${fmt(o.standardBuyout)} | <span style="color:${p>=0?'var(--green)':'var(--red)'}">${p>=0?'+':''}${fmt(p)} ${p>=0?'profit':'loss'}</span></span></div>
        <div style="display:flex; gap:6px;"><button class="btn btn-green btn-sm" onclick="acceptTransfer(${o.id})">ACCEPT</button><button class="btn btn-red btn-sm" onclick="rejectTransfer(${o.id})">REJECT</button></div>
      </div>`;
    });
    html+='</div>';
  }
  $('cmd-notifications').innerHTML=html;
}

function renderOutboundOffers() {
  const at=$('dash-team-select').value;
  const all=[...pendingTransfers.filter(o=>o.buyer===at).map(o=>({...o,status:'‚è≥ PENDING'})), ...transferHistory.filter(o=>o.buyer===at)];
  $('outbound-offers').innerHTML=all.length ? all.map(o=>{
    const c=o.status.includes('‚úÖ')?'var(--green)':o.status.includes('‚ùå')?'var(--red)':'var(--orange)';
    return `<div class="list-row"><div><div class="name" style="font-size:12px;">${o.playerName}</div><div class="meta">${fmt(o.amount)} ‚Üí ${o.seller}</div></div><span style="color:${c}; font-family:var(--font-data); font-size:11px; font-weight:700;">${o.status}</span></div>`;
  }).join('') : '<div style="color:var(--text-dim); padding:10px; font-size:12px; font-family:var(--font-data);">No active proposals.</div>';
}

/* ‚ïê‚ïê‚ïê TRANSFER ACTIONS ‚ïê‚ïê‚ïê */
function createInternalOffer(name, std) {
  const p=prompt(`Put ${name} on sale.\nStd Buyout: ${fmt(std)}\nEnter sale price:`);
  if (p!==null&&!isNaN(p)&&p>=0) { temporaryOffers[name]=parseFloat(p); addLog(`üè∑ ${name} listed for sale at ${fmt(parseFloat(p))}.`,'good'); refreshMarket(); }
}

function buyFreeAgent(name) {
  const buyer=$('dash-team-select').value, months=parseInt($('market-duration').value);
  if (isNaN(months)||months<1||months>24) return alert('Invalid duration.');
  if (!canAddBench(buyer)) return alert('Bench full (max 3).');
  const p=players.find(x=>String(x.PlayerName)===name);
  if (p&&confirm(`Sign ${name} as Free Agent on a ${months}m contract?`)) {
    saveState(); p.TeamName=buyer; p.Role='Bench'; p.ContractMonths=months;
    addLog(`‚úç Signed FA: ${name} to ${buyer} (${months}m).`,'good'); updateAll();
  }
}

function buyOffer(name, cost) {
  const buyer=$('dash-team-select').value, months=parseInt($('market-duration').value);
  if (isNaN(months)||months<1||months>24) return alert('Invalid duration.');
  if (!canAddBench(buyer)) return alert('Bench full (max 3).');
  const b=finances.find(t=>t.TeamName===buyer), p=players.find(x=>String(x.PlayerName)===name);
  if (!b||!p) return;
  if (!confirm(`Buy ${name} for ${fmt(cost)}? Contract: ${months}m`)) return;
  if (b.CurrentBank<cost) return alert('Insufficient funds.');
  saveState(); b.CurrentBank-=cost;
  const seller=finances.find(t=>t.TeamName===p.TeamName); if (seller) seller.CurrentBank+=cost;
  p.TeamName=buyer; p.Role='Bench'; p.ContractMonths=months;
  delete temporaryOffers[name]; pendingTransfers=pendingTransfers.filter(o=>o.playerName!==name);
  addLog(`üí∏ ${buyer} bought ${name} for ${fmt(cost)}.`,'good'); updateAll();
}

function proposeTransfer(name, defPrice) {
  const buyer=$('dash-team-select').value, months=parseInt($('market-duration').value);
  if (isNaN(months)||months<1||months>24) return alert('Invalid duration.');
  if (!canAddBench(buyer)) return alert('Bench full.');
  const b=finances.find(t=>t.TeamName===buyer), p=players.find(x=>String(x.PlayerName)===name);
  if (!b||!p) return;
  if (pendingTransfers.some(o=>o.buyer===buyer&&o.playerName===name)) return alert('Offer already pending.');
  const amt=parseFloat(prompt(`Propose transfer for ${name}.\nStd Buyout: ${fmt(defPrice)}\nYour offer:`, defPrice.toFixed(0)));
  if (isNaN(amt)||amt<0) return;
  if (b.CurrentBank<amt) return alert('Insufficient funds.');
  saveState();
  pendingTransfers.push({id:Date.now(), buyer, seller:p.TeamName, playerName:name, amount:amt, standardBuyout:getPlayerBuyout(p), months});
  addLog(`üì® ${buyer} proposed ${fmt(amt)} for ${name} (${months}m).`); updateAll();
}

function acceptTransfer(id) {
  const i=pendingTransfers.findIndex(o=>o.id===id); if (i<0) return;
  const o=pendingTransfers[i];
  const buyer=finances.find(t=>t.TeamName===o.buyer), seller=finances.find(t=>t.TeamName===o.seller);
  const p=players.find(x=>String(x.PlayerName)===o.playerName);
  if (buyer.CurrentBank<o.amount) { alert(`${o.buyer} can no longer afford this!`); transferHistory.unshift({...o, status:'‚ùå REJECTED (BROKE)'}); pendingTransfers.splice(i,1); updateAll(); return; }
  if (!canAddBench(o.buyer)) return alert(`${o.buyer}'s bench is full.`);
  saveState(); buyer.CurrentBank-=o.amount; seller.CurrentBank+=o.amount;
  p.TeamName=o.buyer; p.Role='Bench'; p.ContractMonths=o.months;
  transferHistory.unshift({...o, status:'‚úÖ ACCEPTED'});
  pendingTransfers=pendingTransfers.filter(x=>x.playerName!==o.playerName);
  delete temporaryOffers[o.playerName];
  addLog(`‚úÖ TRANSFER: ${o.playerName} ‚Üí ${o.buyer} for ${fmt(o.amount)}.`,'good'); updateAll();
}

function rejectTransfer(id) {
  const i=pendingTransfers.findIndex(o=>o.id===id); if (i<0) return;
  saveState(); transferHistory.unshift({...pendingTransfers[i], status:'‚ùå REJECTED'});
  addLog(`‚ùå Transfer rejected.`,'bad'); pendingTransfers.splice(i,1); updateAll();
}

/* ‚ïê‚ïê‚ïê TOGGLE ROLE ‚ïê‚ïê‚ïê */
function toggleRole(name) {
  const p=players.find(x=>String(x.PlayerName)===name); if (!p) return;
  if (p.Role==='Starter') {
    if (players.filter(x=>x.TeamName===p.TeamName&&x.Role==='Bench').length>=3) return alert('Bench full (max 3).');
    saveState(); p.Role='Bench'; addLog(`üîÑ ${name} ‚Üí Bench.`); updateAll();
  } else {
    if (players.filter(x=>x.TeamName===p.TeamName&&x.Role==='Starter').length>=5) return alert('Starters full (max 5).');
    saveState(); p.Role='Starter'; addLog(`üîÑ ${name} ‚Üí Starter.`,'good'); updateAll();
  }
}

/* ‚ïê‚ïê‚ïê RENEWAL ‚ïê‚ïê‚ïê */
function applyRenewal() {
  const at=$('dash-team-select').value, target=$('dash-renew-target').value;
  const mos=parseInt($('dash-renew-dur').value);
  if (isNaN(mos)||mos<1||mos>24) return alert('Duration must be 1‚Äì24 months.');
  const team=finances.find(t=>t.TeamName===at);
  const tPly=target==='all'?players.filter(p=>p.TeamName===at):players.filter(p=>String(p.PlayerName)===target&&p.TeamName===at);
  if (!team||!tPly.length) return;
  if (tPly.some(p=>(p.ContractMonths||0)+mos>24)) return alert('Would exceed 24-month cap.');

  let fee=0, bonus=0;
  tPly.forEach(p=>{ fee+=p.MarketValue*0.10; if (target!=='all') bonus+=getFormScore(p)*1000; });

  let msg=target==='all'?`Renew ALL ${at} players +${mos}m\nFee: ${fmt(fee)}`:`Renew ${target} +${mos}m\nFee: ${fmt(fee)}`;
  if (bonus>0) msg+=`\n\nü§ñ AGENT BONUS DEMAND: ${fmt(bonus)}\nTotal: ${fmt(fee+bonus)}`;
  if (confirm(msg)) {
    saveState(); team.CurrentBank-=(fee+bonus);
    tPly.forEach(p=>p.ContractMonths=(p.ContractMonths||0)+mos);
    addLog(`üìã Renewed ${target==='all'?'all '+at:target} +${mos}m. Cost: ${fmt(fee+bonus)}.`,'good'); updateAll();
  }
}

function updateContractAlerts() {
  const alerts=players.filter(p=>p.TeamName!=='none'&&p.ContractMonths<=2);
  $('contract-alerts').innerHTML=alerts.length ? alerts.map(p=>`
    <div class="alert-item ${p.ContractMonths<=0?'critical':'warning'}">
      <div style="flex:1">
        <b>${String(p.PlayerName)}</b> <span style="color:var(--text-dim);">(${p.TeamName})</span>
        <div style="font-family:var(--font-data); font-size:10px; color:${p.ContractMonths<=0?'var(--red)':'var(--orange)'};">${p.ContractMonths}m remaining</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="quickRenew('${String(p.PlayerName).replace(/'/g,"\\'")}')" style="padding:4px 8px;">RENEW</button>
    </div>`).join('')
  : '<div class="alert-item success">‚úì All contracts stable.</div>';
}

function quickRenew(name) {
  const p=players.find(x=>String(x.PlayerName)===name), team=finances.find(t=>t.TeamName===p.TeamName);
  const mos=parseInt($('renew-duration').value);
  if (isNaN(mos)||mos<1||mos>24) return alert('Invalid duration.');
  if ((p.ContractMonths||0)+mos>24) return alert('Exceeds 24m cap.');
  const fee=p.MarketValue*0.10, bonus=getFormScore(p)*1000;
  let msg=`Renew ${name} +${mos}m\nFee: ${fmt(fee)}`;
  if (bonus>0) msg+=`\nü§ñ Agent Bonus: ${fmt(bonus)}\nTotal: ${fmt(fee+bonus)}`;
  if (confirm(msg)) { saveState(); team.CurrentBank-=(fee+bonus); p.ContractMonths=(p.ContractMonths||0)+mos; addLog(`üìã Renewed ${name} +${mos}m. Cost ${fmt(fee+bonus)}.`,'good'); updateAll(); }
}

/* ‚ïê‚ïê‚ïê TRAVEL ‚ïê‚ïê‚ïê */
function renderTravelList() {
  const type=$('travel-type').value, search=($('travel-search').value||'').toLowerCase();
  const cost={regional:5000,national:15000,international:35000}[type];
  const checked=new Set(Array.from(document.querySelectorAll('.travel-cb:checked')).map(c=>c.value));
  $('travel-list').innerHTML=finances.filter(t=>t.TeamName.toLowerCase().includes(search)).map(t=>{
    const t3=String(t.Tier||'').toLowerCase().trim()==='tier 3';
    const fc=t3?cost*0.5:cost, nb=(t.CurrentBank||0)-fc;
    return `<label class="travel-item">
      <input type="checkbox" class="travel-cb" value="${t.TeamName}" ${checked.has(t.TeamName)?'checked':''}>
      <div style="flex:1">
        <span style="font-weight:600;">${t.TeamName}</span>${t3?` <span class="badge badge-orange">50% OFF</span>`:''}
      </div>
      <div style="text-align:right; font-family:var(--font-data); font-size:10px;">
        <div style="color:var(--red);">‚àí${fmt(fc)}</div>
        <div style="color:${nb<0?'var(--red)':'var(--text-dim)'};">${fmt(nb)}</div>
      </div>
    </label>`;
  }).join('');
}

function applyTravelExpenses() {
  const type=$('travel-type').value, cbs=document.querySelectorAll('.travel-cb:checked');
  if (!cbs.length) return alert('Select at least one team.');
  const cost={regional:5000,national:15000,international:35000}[type];
  if (!confirm(`Charge ${cbs.length} teams for ${type} travel?`)) return;
  saveState();
  let teams=[];
  cbs.forEach(cb=>{ const t=finances.find(x=>x.TeamName===cb.value); if (t){ const t3=String(t.Tier||'').toLowerCase().trim()==='tier 3'; t.CurrentBank-=t3?cost*0.5:cost; teams.push(t.TeamName); }});
  addLog(`‚úà Travel (${type}): charged ${teams.join(', ')}.`,'warn'); $('travel-search').value=''; updateAll();
}

/* ‚ïê‚ïê‚ïê TOURNAMENT & AWARDS ‚ïê‚ïê‚ïê */
function distributeTourneyPrize() {
  const amt=parseFloat($('prize-amount').value), tName=$('tourney-team-select').value;
  const team=finances.find(t=>t.TeamName===tName);
  if (!amt||!team) return;
  const awardTitle=$('tourney-award-title').checked;
  saveState(); team.CurrentBank+=amt*0.6;
  const share=amt*0.4/5;
  players.filter(p=>p.TeamName===tName&&p.Role==='Starter').slice(0,5).forEach(p=>{ p.MarketValue+=share; p.PrizePool=(p.PrizePool||0)+share; if(awardTitle) p.Titles=(p.Titles||0)+1; });
  const titleMsg=awardTitle?' + üèÜ Title medals awarded':'';
  addLog(`üèÜ ${tName} received ${fmt(amt)}! Bank +${fmt(amt*0.6)}, starters +${fmt(share)} MV each${titleMsg}.`,'good'); updateAll();
}

function applyIndividualPerformance() {
  const pName=$('perf-player-select').value, p=players.find(x=>String(x.PlayerName)===pName);
  if (!p) return;
  saveState();
  const type=$('perf-type').value;
  const reward={region:{mvp:4000,evp:3500,vp:2500},global:{mvp:10000,evp:6000,vp:4000},major:{mvp:30000,evp:12500,vp:7500}}[$('perf-tier').value][type];
  p.MarketValue=(p.MarketValue||0)+reward;
  p.PrizePool=(p.PrizePool||0)+reward;
  if (type==='mvp') p.MVP=(p.MVP||0)+1;
  else if (type==='evp') p.EVP=(p.EVP||0)+1;
  else p.VP=(p.VP||0)+1;
  addLog(`‚≠ê ${pName} awarded ${type.toUpperCase()} (+${fmt(reward)} MV & prize pool, medal granted).`,'good'); updateAll();
}

/* ‚ïê‚ïê‚ïê MONTHLY CYCLE ‚ïê‚ïê‚ïê */
function runMonthlyCycle() {
  saveState(); monthCounter++;
  finances.forEach(team=>{
    team.CurrentBank=(team.CurrentBank||0)+getTeamFinances(team).net;
    if (team.sponsorshipBoost) team.sponsorshipBoost=false;
    if (team.CurrentBank<0) {
      const tp=players.filter(p=>p.TeamName===team.TeamName);
      if (tp.length) {
        tp.sort((a,b)=>b.MarketValue-a.MarketValue);
        const star=tp[0], sn=String(star.PlayerName);
        if (temporaryOffers[sn]===undefined) {
          const fire=star.MarketValue*0.10*(star.ContractMonths||0)*1.5*0.40;
          temporaryOffers[sn]=fire;
          addLog(`üö® [BOARD] ${team.TeamName} BANKRUPT ‚Äî ${sn} forced on sale at ${fmt(fire)} (60% OFF)!`,'bad');
        }
      }
    }
  });
  players.forEach(p=>{ if (p.TeamName!=='none'&&p.ContractMonths>0) p.ContractMonths--; });
  addLog(`‚è≠ Month ${monthCounter} cycle complete.`,'good'); updateAll();
}

function applyBailout() {
  const tName=$('reset-team-select').value, team=finances.find(t=>t.TeamName===tName);
  if (team&&confirm(`Apply emergency bailout to ${tName}?`)) {
    saveState(); team.CurrentBank=25000; team.sponsorshipBoost=true;
    addLog(`üíä Bailout: ${tName} recapitalized at $25,000 + 50% sponsor boost.`,'warn'); updateAll();
  }
}

function applySeasonReset() {
  if (confirm('GLOBAL SEASON RESET:\n- Accumulates medals into Total MVP/EVP/VP/Titles\n- Saves current MV as Previous MV\n- Wipes season medals (MVP, EVP, VP, Titles)\n- Cuts all MV by 30%\n\nThis cannot be undone. Continue?')) {
    saveState();
    players.forEach(p=>{
      // Accumulate season medals into career totals
      p['Total MVP'] = (p['Total MVP']||0) + (p.MVP||0);
      p['Total EVP'] = (p['Total EVP']||0) + (p.EVP||0);
      p['Total VP']  = (p['Total VP']||0)  + (p.VP||0);
      p['Total Titles'] = (p['Total Titles']||0) + (p.Titles||0);
      // Save current MV before cutting
      p['Previous MV'] = p.MarketValue||0;
      // Apply season reset
      p.MarketValue *= 0.7;
      p.MVP = p.EVP = p.VP = p.Titles = 0;
    });
    monthCounter=1; addLog('üîÅ Season reset applied. Totals accumulated, Previous MV saved. New season begins.','warn'); updateAll();
  }
}

/* ‚ïê‚ïê‚ïê UNDO & EXPORT ‚ïê‚ïê‚ïê */
function saveState() {
  if (history.length>=5) history.shift();
  history.push({f:JSON.parse(JSON.stringify(finances)), p:JSON.parse(JSON.stringify(players)), pt:JSON.parse(JSON.stringify(pendingTransfers)), th:JSON.parse(JSON.stringify(transferHistory)), mc:monthCounter});
}

function undo() {
  if (!history.length) return addLog('Nothing to undo.','warn');
  const s=history.pop(); finances=s.f; players=s.p; pendingTransfers=s.pt||[]; transferHistory=s.th||[]; monthCounter=s.mc||monthCounter;
  addLog('‚Ü© Undo successful.','warn'); updateAll();
}

function exportExcels() {
  // Export players with correct column names matching expected format
  const pData = players.map(p => ({
    'PlayerName': p.PlayerName || '',
    'Role': p.Role || '',
    'Market Value': p.MarketValue || 0,         // Internal MarketValue ‚Üí Excel "PrizePool"
    'Prize Pool': p.PrizePool || 0,           // Accumulated earnings ‚Üí Excel "Prize Pool"
    'ContractMonths': p.ContractMonths || 0,
    'TeamName': p.TeamName || '',
    'MVP': p.MVP || 0,
    'EVP': p.EVP || 0,
    'VP': p.VP || 0,
    'Titles': p.Titles || 0,
    'Total MVP': p['Total MVP'] || 0,
    'Total EVP': p['Total EVP'] || 0,
    'Total VP': p['Total VP'] || 0,
    'Total Titles': p['Total Titles'] || 0,
    'Previous MV': p['Previous MV'] || 0
  }));
  // Export finances preserving original column names
  const fData = finances.map(t => ({
    'TeamName': t.TeamName || '',
    'Tier': t.Tier || '',
    'CurrentBank': t.CurrentBank || 0,
    'Coach': t.Coach || 0,
    'Analyst': t.Analyst || 0,
    'HeathTeam': t.HealthTeam || t.HeathTeam || 0,
    'PhysicalTeam': t.PhysicalTeam || 0,
    'Maintenance': t.Maintenance || 0,
    'Marketing': t.Marketing || 0
  }));
  const wb1=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb1,XLSX.utils.json_to_sheet(fData),'Finances'); XLSX.writeFile(wb1,'finances_updated.xlsx');
  const wb2=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb2,XLSX.utils.json_to_sheet(pData),'Players'); XLSX.writeFile(wb2,'players_updated.xlsx');
  addLog('üì• Exported finances_updated.xlsx & players_updated.xlsx.','good');
}

/* ‚ïê‚ïê‚ïê LOG ‚ïê‚ïê‚ïê */
function addLog(msg, type='') {
  const el=$('action-log');
  const ts=new Date().toLocaleTimeString();
  const div=document.createElement('div'); div.className=`log-entry ${type}`;
  div.innerHTML=`<span class="ts">[${ts}]</span>${msg}`;
  el.insertBefore(div, el.firstChild);
}

// Init log
addLog('NEXUS COMMAND ‚Äî Upload your data files to begin.', 'good');

// Keyboard shortcut: press 0 to go back to portal
document.addEventListener('keydown', e => {
  if (e.key === '0' && !['INPUT','SELECT','TEXTAREA'].includes(document.activeElement.tagName)) {
    window.location.href = 'index.html';
  }
});
</script>
</body>
</html>
