<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VRS Rating</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #070b12;
      --surface: #0d1421;
      --surface2: #111d30;
      --border: #1a2840;
      --border-bright: #243352;
      --text: #e8f0ff;
      --muted: #5a7099;
      --muted2: #3d5175;
      --accent: #4f8cff;
      --accent2: #7b5fff;
      --good: #00e87a;
      --bad: #ff4060;
      --warn: #ffb930;
      --gold: #ffd700;
      --silver: #c0c8d8;
      --bronze: #cd7f32;

      --font-display: 'Syne', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --font-body: 'Inter', sans-serif;

      --glow-accent: 0 0 30px rgba(79,140,255,0.15);
      --glow-good: 0 0 20px rgba(0,232,122,0.2);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ Ambient background ‚îÄ‚îÄ‚îÄ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 800px 500px at 15% 10%, rgba(79,140,255,0.07) 0%, transparent 70%),
        radial-gradient(ellipse 600px 400px at 85% 80%, rgba(123,95,255,0.06) 0%, transparent 70%),
        radial-gradient(ellipse 400px 300px at 50% 50%, rgba(0,232,122,0.03) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
    .app-shell {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ */
    .sidebar {
      background: linear-gradient(180deg, rgba(13,20,33,0.98) 0%, rgba(7,11,18,0.99) 100%);
      border-right: 1px solid var(--border);
      padding: 28px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .logo {
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 4px;
      padding: 0 8px;
    }

    .logo-sub {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      font-family: var(--font-mono);
      padding: 0 8px;
      margin-bottom: 24px;
    }

    .sidebar-section {
      font-size: 10px;
      color: var(--muted2);
      letter-spacing: 2px;
      text-transform: uppercase;
      font-family: var(--font-mono);
      padding: 8px 8px 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
      transition: all 0.15s ease;
      border: 1px solid transparent;
      text-decoration: none;
    }

    .nav-item:hover {
      color: var(--text);
      background: rgba(79,140,255,0.08);
      border-color: rgba(79,140,255,0.15);
    }

    .nav-item.active {
      color: var(--accent);
      background: rgba(79,140,255,0.1);
      border-color: rgba(79,140,255,0.2);
    }

    .nav-icon {
      width: 18px;
      text-align: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .sidebar-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 12px 8px 0;
      border-top: 1px solid var(--border);
    }

    .sidebar-footer-text {
      font-size: 11px;
      color: var(--muted2);
      font-family: var(--font-mono);
    }

    /* ‚îÄ‚îÄ‚îÄ Main content ‚îÄ‚îÄ‚îÄ */
    .main {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .top-bar {
      padding: 20px 28px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(7,11,18,0.9);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .page-title {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .top-bar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* ‚îÄ‚îÄ‚îÄ Panels (tab content) ‚îÄ‚îÄ‚îÄ */
    .panels {
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      display: none;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.2s ease;
    }

    .panel.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
    .card {
      background: linear-gradient(135deg, rgba(17,29,48,0.9) 0%, rgba(13,20,33,0.95) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .card-header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .card-title {
      font-family: var(--font-display);
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
      font-family: var(--font-mono);
      margin-top: 2px;
    }

    .card-body {
      padding: 18px 20px;
    }

    /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 9px 16px;
      border-radius: 9px;
      border: 1px solid transparent;
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(79,140,255,0.3);
    }

    .btn-primary:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(79,140,255,0.4);
    }

    .btn-ghost {
      background: rgba(255,255,255,0.04);
      border-color: var(--border-bright);
      color: var(--text);
    }

    .btn-ghost:hover {
      background: rgba(255,255,255,0.07);
      border-color: rgba(79,140,255,0.3);
      color: var(--accent);
    }

    .btn:disabled {
      opacity: 0.35;
      pointer-events: none;
    }

    .btn:active {
      transform: translateY(1px);
    }

    /* ‚îÄ‚îÄ‚îÄ Form controls ‚îÄ‚îÄ‚îÄ */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
      font-family: var(--font-mono);
    }

    .form-control {
      padding: 9px 12px;
      border-radius: 9px;
      border: 1px solid var(--border-bright);
      background: rgba(7,11,18,0.8);
      color: var(--text);
      font-size: 13px;
      font-family: var(--font-body);
      outline: none;
      transition: border-color 0.15s ease;
      min-width: 160px;
    }

    .form-control:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79,140,255,0.1);
    }

    .controls-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    /* ‚îÄ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ‚îÄ */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(7,11,18,0.7);
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--muted);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
    }

    .status-dot.ok { background: var(--good); box-shadow: 0 0 8px var(--good); }
    .status-dot.err { background: var(--bad); box-shadow: 0 0 8px var(--bad); }
    .status-dot.loading {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ‚îÄ‚îÄ‚îÄ Stat badges ‚îÄ‚îÄ‚îÄ */
    .stats-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .stat-pill {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(7,11,18,0.6);
      border: 1px solid var(--border);
      min-width: 80px;
    }

    .stat-label {
      font-size: 10px;
      color: var(--muted2);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-family: var(--font-mono);
    }

    .stat-value {
      font-size: 20px;
      font-weight: 800;
      font-family: var(--font-display);
      color: var(--text);
    }

    .stat-value.up { color: var(--good); }
    .stat-value.down { color: var(--bad); }
    .stat-value.warn { color: var(--warn); }

    /* ‚îÄ‚îÄ‚îÄ Table ‚îÄ‚îÄ‚îÄ */
    .table-wrapper {
      overflow: auto;
      max-height: 65vh;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      text-align: left;
      padding: 12px 14px;
      font-size: 10px;
      color: var(--muted);
      font-family: var(--font-mono);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: rgba(7,11,18,0.95);
      backdrop-filter: blur(8px);
      z-index: 10;
      white-space: nowrap;
    }

    thead th:first-child { border-radius: 12px 0 0 0; }
    thead th:last-child { border-radius: 0 12px 0 0; }

    tbody td {
      padding: 11px 14px;
      border-bottom: 1px solid rgba(26,40,64,0.6);
      vertical-align: middle;
    }

    tbody tr:last-child td { border-bottom: none; }

    tbody tr {
      transition: background 0.12s ease;
    }

    tbody tr:hover td {
      background: rgba(79,140,255,0.04);
    }

    .right { text-align: right; }

    /* ‚îÄ‚îÄ‚îÄ Rank rows ‚îÄ‚îÄ‚îÄ */
    @keyframes shimmer {
      0% { transform: translateX(-100%) skewX(-12deg); }
      100% { transform: translateX(200%) skewX(-12deg); }
    }

    @keyframes waveShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .rank-row {
      position: relative;
      isolation: isolate;
      background-size: 300% 300%;
    }

    .rank-row::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.06) 50%, transparent 100%);
      transform: translateX(-100%) skewX(-12deg);
      animation: shimmer 4s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    .rank-row > td { position: relative; z-index: 1; }

    .rank-1 {
      background: linear-gradient(90deg, rgba(255,215,0,0.12) 0%, rgba(255,180,0,0.06) 50%, rgba(255,215,0,0.04) 100%);
      animation: waveShift 6s ease-in-out infinite;
    }

    .rank-2 {
      background: linear-gradient(90deg, rgba(192,200,216,0.10) 0%, rgba(160,175,200,0.05) 50%, rgba(192,200,216,0.03) 100%);
      animation: waveShift 7s ease-in-out infinite;
    }

    .rank-3 {
      background: linear-gradient(90deg, rgba(205,127,50,0.12) 0%, rgba(180,100,30,0.06) 50%, rgba(205,127,50,0.04) 100%);
      animation: waveShift 8s ease-in-out infinite;
    }

    .rank-top {
      background: linear-gradient(90deg, rgba(79,140,255,0.08) 0%, rgba(123,95,255,0.04) 50%, rgba(79,140,255,0.02) 100%);
      animation: waveShift 9s ease-in-out infinite;
    }

    /* ‚îÄ‚îÄ‚îÄ Team name gradient ‚îÄ‚îÄ‚îÄ */
    @keyframes textFlow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    .team-name-animated {
      font-family: var(--font-display);
      font-weight: 800;
      font-size: 13px;
      background-size: 200% 100%;
      animation: textFlow 3s linear infinite;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
    }

    .team-name-1 {
      background-image: linear-gradient(90deg, #ffd700, #fff7aa, #ffb700, #ffe566, #ffd700);
    }
    .team-name-2 {
      background-image: linear-gradient(90deg, #a0b8d8, #ffffff, #c8d8f0, #7090b8, #a0b8d8);
    }
    .team-name-3 {
      background-image: linear-gradient(90deg, #cd7f32, #f0b060, #cd7f32, #e8a050, #cd7f32);
    }
    .team-name-top {
      background-image: linear-gradient(90deg, #4f8cff, #7b5fff, #4f8cff);
    }
    .team-name-default {
      font-family: var(--font-body);
      font-weight: 500;
      color: var(--text);
    }

    /* ‚îÄ‚îÄ‚îÄ Rank badge ‚îÄ‚îÄ‚îÄ */
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 12px;
    }

    .rank-badge-1 { background: rgba(255,215,0,0.2); color: var(--gold); border: 1px solid rgba(255,215,0,0.3); }
    .rank-badge-2 { background: rgba(192,200,216,0.15); color: var(--silver); border: 1px solid rgba(192,200,216,0.25); }
    .rank-badge-3 { background: rgba(205,127,50,0.2); color: var(--bronze); border: 1px solid rgba(205,127,50,0.3); }
    .rank-badge-n { background: rgba(255,255,255,0.04); color: var(--muted); border: 1px solid var(--border); }

    /* ‚îÄ‚îÄ‚îÄ Delta chips ‚îÄ‚îÄ‚îÄ */
    .delta {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .delta.up { color: var(--good); }
    .delta.down { color: var(--bad); }
    .delta.flat { color: var(--muted); }
    .delta.new { color: var(--warn); }

    /* ‚îÄ‚îÄ‚îÄ Tier badge ‚îÄ‚îÄ‚îÄ */
    .tier-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
    }

    .tier-s { background: rgba(255,185,48,0.15); color: #ffb930; border: 1px solid rgba(255,185,48,0.25); }
    .tier-1 { background: rgba(79,140,255,0.15); color: #4f8cff; border: 1px solid rgba(79,140,255,0.25); }
    .tier-2 { background: rgba(123,95,255,0.15); color: #7b5fff; border: 1px solid rgba(123,95,255,0.25); }
    .tier-3 { background: rgba(90,112,153,0.15); color: #8aabcc; border: 1px solid rgba(90,112,153,0.25); }

    /* ‚îÄ‚îÄ‚îÄ Region flag ‚îÄ‚îÄ‚îÄ */
    .region-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      color: var(--muted);
      font-family: var(--font-mono);
    }

    .region-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .region-am .region-dot { background: #4f8cff; }
    .region-eu .region-dot { background: #7b5fff; }
    .region-as .region-dot { background: #00e87a; }

    /* ‚îÄ‚îÄ‚îÄ AI Analysis panel ‚îÄ‚îÄ‚îÄ */
    .ai-analysis-box {
      background: linear-gradient(135deg, rgba(79,140,255,0.05) 0%, rgba(123,95,255,0.05) 100%);
      border: 1px solid rgba(79,140,255,0.2);
      border-radius: 14px;
      padding: 20px;
    }

    .ai-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .ai-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .ai-title {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 700;
    }

    .ai-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .ai-section {
      margin-bottom: 16px;
    }

    .ai-section-title {
      font-size: 11px;
      color: var(--accent);
      font-family: var(--font-mono);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(79,140,255,0.2);
    }

    .ai-insight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }

    .ai-insight-card {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(7,11,18,0.7);
      border: 1px solid var(--border);
    }

    .ai-insight-label {
      font-size: 10px;
      color: var(--muted2);
      font-family: var(--font-mono);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .ai-insight-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      font-family: var(--font-display);
    }

    .ai-insight-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      font-family: var(--font-mono);
    }

    .ai-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ai-list-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
      padding: 6px 0;
      border-bottom: 1px solid rgba(26,40,64,0.4);
    }

    .ai-list-item:last-child { border-bottom: none; }

    .ai-list-num {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: rgba(79,140,255,0.15);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      font-family: var(--font-mono);
      flex-shrink: 0;
      margin-top: 1px;
    }

    .ai-placeholder {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 13px;
    }

    /* ‚îÄ‚îÄ‚îÄ Match predictor ‚îÄ‚îÄ‚îÄ */
    .vs-display {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 16px 20px;
      background: rgba(7,11,18,0.6);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 14px;
    }

    .vs-team {
      flex: 1;
      text-align: center;
    }

    .vs-team-name {
      font-family: var(--font-display);
      font-size: 15px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .vs-team-pts {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    .vs-divider {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 800;
      color: var(--muted2);
    }

    .vs-prob-bar {
      display: flex;
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      background: var(--border);
    }

    .vs-prob-a { background: var(--accent); transition: width 0.4s ease; }
    .vs-prob-b { background: var(--accent2); transition: width 0.4s ease; }

    /* ‚îÄ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted2); }

    /* ‚îÄ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .app-shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .panels { padding: 16px; }
    }

    @media (prefers-reduced-motion: reduce) {
      .rank-row::after, .rank-1, .rank-2, .rank-3, .rank-top, .team-name-animated { animation: none !important; }
    }

    /* ‚îÄ‚îÄ‚îÄ Streak indicator ‚îÄ‚îÄ‚îÄ */
    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 700;
    }

    .streak-badge.hot { color: var(--warn); }
    .streak-badge.cold { color: var(--muted); }

    /* ‚îÄ‚îÄ‚îÄ Small text ‚îÄ‚îÄ‚îÄ */
    .mono { font-family: var(--font-mono); }
    .text-muted { color: var(--muted); }
    .text-sm { font-size: 12px; }
    .text-xs { font-size: 11px; }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>

<body>
<div class="app-shell">

  <!-- ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ -->
  <aside class="sidebar">
    <div class="logo">VRS</div>
    <div class="logo-sub">Rating System</div>

    <div class="sidebar-section">Views</div>
    <a class="nav-item active" data-panel="global" onclick="switchPanel('global'); return false;" href="#">
      <span class="nav-icon">üåê</span> Global Ranking
    </a>
    <a class="nav-item" data-panel="region" onclick="switchPanel('region'); return false;" href="#">
      <span class="nav-icon">üó∫</span> Regional View
    </a>
    <a class="nav-item" data-panel="predictor" onclick="switchPanel('predictor'); return false;" href="#">
      <span class="nav-icon">‚ö°</span> Match Predictor
    </a>
    <a class="nav-item" data-panel="analysis" onclick="switchPanel('analysis'); return false;" href="#">
      <span class="nav-icon">üß†</span> AI Analysis
    </a>

    <div class="sidebar-divider"></div>
    <div class="sidebar-section">Quick Info</div>

    <div style="padding: 4px 8px; display: flex; flex-direction: column; gap: 8px;">
      <div class="stat-pill">
        <span class="stat-label">Teams</span>
        <span class="stat-value" id="sideCountTeams">‚Äî</span>
      </div>
      <div class="stat-pill">
        <span class="stat-label">Risers</span>
        <span class="stat-value up" id="sideCountUp">‚Äî</span>
      </div>
      <div class="stat-pill">
        <span class="stat-label">Fallers</span>
        <span class="stat-value down" id="sideCountDown">‚Äî</span>
      </div>
    </div>

    <div class="sidebar-divider"></div>
    <a class="nav-item" href="index.html">
      <span class="nav-icon">‚Üê</span> Back to Menu
    </a>

    <div class="sidebar-footer">
      <div class="sidebar-footer-text">VRS ¬∑ 02/17/2026</div>
      <div class="sidebar-footer-text" style="margin-top:2px; color:var(--muted2)">Local processing</div>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ -->
  <main class="main">

    <!-- Top bar -->
    <div class="top-bar">
      <div>
        <div class="page-title" id="pageTitle">Global Ranking</div>
        <div class="text-xs text-muted mono" style="margin-top:2px">VRS Rating System ¬∑ Comparative View</div>
      </div>
      <div class="top-bar-actions">
        <button class="btn btn-ghost" id="btnUpdateOld">‚Ü∫ Reload Old</button>
        <button class="btn btn-ghost" id="btnUpdateNew">‚Ü∫ Reload New</button>
        <button class="btn btn-primary" id="btnCompare">‚ü≥ Compare</button>
        <button class="btn btn-ghost" id="btnDownloadCsv" disabled>‚Üì CSV</button>
      </div>
    </div>

    <!-- Panels container -->
    <div class="panels">

      <!-- ‚îÄ‚îÄ‚îÄ STATUS + STATS always visible ‚îÄ‚îÄ‚îÄ -->
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div class="status-bar" style="flex:1; min-width:200px;">
          <div class="status-dot loading" id="statusDot"></div>
          <span id="statusText">Loading files automatically‚Ä¶</span>
        </div>
        <div class="stats-row" id="statsRow" style="display:none;">
          <div class="stat-pill">
            <span class="stat-label">Teams</span>
            <span class="stat-value" id="countTeams">0</span>
          </div>
          <div class="stat-pill">
            <span class="stat-label">Risers</span>
            <span class="stat-value up" id="countUp">0</span>
          </div>
          <div class="stat-pill">
            <span class="stat-label">Fallers</span>
            <span class="stat-value down" id="countDown">0</span>
          </div>
          <div class="stat-pill">
            <span class="stat-label">No Change</span>
            <span class="stat-value" id="countFlat">0</span>
          </div>
          <div class="stat-pill">
            <span class="stat-label">New</span>
            <span class="stat-value warn" id="countNew">0</span>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GLOBAL PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="panel active" id="panel-global">

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Global Ranking</div>
              <div class="card-subtitle">Sorted by Points ¬∑ All regions</div>
            </div>
            <div class="controls-row">
              <div class="form-group">
                <label class="form-label">Region</label>
                <select class="form-control" id="filterRegion" disabled style="min-width:130px;">
                  <option value="">All Regions</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Tier</label>
                <select class="form-control" id="filterTier" disabled style="min-width:110px;">
                  <option value="">All Tiers</option>
                  <option value="Tier S">Tier S</option>
                  <option value="Tier 1">Tier 1</option>
                  <option value="Tier 2">Tier 2</option>
                  <option value="Tier 3">Tier 3</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Search</label>
                <input class="form-control" id="filterText" type="text" placeholder="Team name‚Ä¶" disabled style="min-width:160px;">
              </div>
              <div style="display:flex; align-items:flex-end;">
                <button class="btn btn-ghost" id="btnClearFilters" disabled>‚úï Clear</button>
              </div>
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">#</th>
                  <th>Team</th>
                  <th class="right">Points</th>
                  <th class="right">Œî Pts</th>
                  <th class="right">Streak</th>
                  <th>Region</th>
                  <th>Tier</th>
                  <th class="right">Position Œî</th>
                  <th class="right" style="font-size:10px;">Old ‚Üí New</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="9" class="empty-state">No data yet. Files are loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REGION PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-region">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Regional Ranking</div>
              <div class="card-subtitle">Position changes computed within region</div>
            </div>
            <div class="form-group">
              <label class="form-label">Select Region</label>
              <select class="form-control" id="regionRankingSelect" disabled>
                <option value="">‚Äî</option>
              </select>
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">#</th>
                  <th>Team</th>
                  <th class="right">Points</th>
                  <th class="right">Œî Pts</th>
                  <th class="right">Streak</th>
                  <th>Tier</th>
                  <th class="right">Position Œî</th>
                  <th class="right" style="font-size:10px;">Old ‚Üí New</th>
                </tr>
              </thead>
              <tbody id="tbodyRegion">
                <tr><td colspan="8" class="empty-state">Select a region to display its ranking.</td></tr>
              </tbody>
            </table>
          </div>
          <div style="padding: 12px 16px; border-top: 1px solid var(--border); font-size: 11px; color: var(--muted); font-family: var(--font-mono);">
            Movement (Old ‚Üí New) is calculated within the selected region.
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PREDICTOR PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-predictor">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Match Predictor</div>
              <div class="card-subtitle">ELO-based simulation with streak multiplier</div>
            </div>
          </div>
          <div class="card-body">
            <div class="controls-row" style="margin-bottom: 16px;">
              <div class="form-group">
                <label class="form-label">Team A</label>
                <select class="form-control" id="matchTeamA" disabled>
                  <option value="">‚Äî Select ‚Äî</option>
                </select>
              </div>
              <div style="display:flex; align-items:flex-end; padding-bottom:1px;">
                <span style="font-family:var(--font-display); font-weight:800; color:var(--muted2); font-size:18px;">VS</span>
              </div>
              <div class="form-group">
                <label class="form-label">Team B</label>
                <select class="form-control" id="matchTeamB" disabled>
                  <option value="">‚Äî Select ‚Äî</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Result</label>
                <select class="form-control" id="matchResult" disabled>
                  <option value="A">Team A wins</option>
                  <option value="B">Team B wins</option>
                </select>
              </div>
            </div>

            <div id="vsMeter" style="display:none; margin-bottom:16px;">
              <div class="vs-display">
                <div class="vs-team">
                  <div class="vs-team-name" id="vsAName">‚Äî</div>
                  <div class="vs-team-pts" id="vsAPts">‚Äî</div>
                  <div class="text-xs text-muted mono" style="margin-top:4px;">Win prob: <strong id="vsAProb">‚Äî</strong></div>
                </div>
                <div>
                  <div class="vs-divider">VS</div>
                  <div class="vs-prob-bar" style="width:120px; margin-top:8px;">
                    <div class="vs-prob-a" id="vsProbBarA" style="width:50%;"></div>
                    <div class="vs-prob-b" id="vsProbBarB" style="width:50%;"></div>
                  </div>
                </div>
                <div class="vs-team">
                  <div class="vs-team-name" id="vsBName">‚Äî</div>
                  <div class="vs-team-pts" id="vsBPts">‚Äî</div>
                  <div class="text-xs text-muted mono" style="margin-top:4px;">Win prob: <strong id="vsBProb">‚Äî</strong></div>
                </div>
              </div>
            </div>

            <div class="status-bar" id="matchStatus" style="margin-bottom:14px;">
              <div class="status-dot"></div>
              <span>Select two teams to preview point and ranking changes.</span>
            </div>

            <div class="table-wrapper" style="max-height:40vh;">
              <table>
                <thead>
                  <tr>
                    <th style="width:50px;">Pos</th>
                    <th>Team</th>
                    <th class="right">Points</th>
                    <th class="right">Streak</th>
                    <th class="right">Œî Pts</th>
                    <th class="right">New Pts</th>
                    <th class="right">Movement</th>
                    <th class="right" style="font-size:10px;">Old ‚Üí New</th>
                  </tr>
                </thead>
                <tbody id="tbodyMatchPredict">
                  <tr><td colspan="8" class="empty-state">No selection yet.</td></tr>
                </tbody>
              </table>
            </div>

            <div style="margin-top: 10px; font-size: 11px; color: var(--muted); font-family: var(--font-mono); line-height:1.6;">
              Rules: ELO-based point transfer. K = 30 √ó (1 + streak bonus) √ó (1 + tournament bonus), capped at K√ó1.35.
              Win streak increments after win; resets to 0 after loss.
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI ANALYSIS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-analysis">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">AI Analysis</div>
              <div class="card-subtitle">Automated insights from ranking data</div>
            </div>
            <button class="btn btn-primary" id="btnRunAnalysis" disabled>üß† Generate Analysis</button>
          </div>
          <div class="card-body">
            <div id="aiContent">
              <div class="ai-placeholder">
                Load ranking data and click <strong>Generate Analysis</strong> to see insights.
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /panels -->
  </main>
</div>

<script>
const $ = (sel) => document.querySelector(sel);

const REGION_LABELS = {
  "AM": "Americas",
  "EU": "Europe",
  "AS/SIS/ESEA": "Asia"
};

const REGION_CLASS = {
  "AM": "region-am",
  "EU": "region-eu",
  "AS/SIS/ESEA": "region-as"
};

const OLD_URL = "file/old.xlsx";
const NEW_URL_PRIMARY = "file/ranking.xlsx";
const NEW_URL_FALLBACK = "file/ranking.xlsx";

let oldRowsCache = null;
let newRowsCache = null;
let currentNewTeams = null;
let lastCombined = null;
let lastRegionCombined = null;

// ‚îÄ‚îÄ‚îÄ Panel switching ‚îÄ‚îÄ‚îÄ
function switchPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  $(`#panel-${name}`).classList.add('active');
  document.querySelector(`[data-panel="${name}"]`)?.classList.add('active');
  const titles = { global: 'Global Ranking', region: 'Regional View', predictor: 'Match Predictor', analysis: 'AI Analysis' };
  $('#pageTitle').textContent = titles[name] || name;
}

// ‚îÄ‚îÄ‚îÄ Status helpers ‚îÄ‚îÄ‚îÄ
function setStatus(msg, state = 'loading') {
  $('#statusText').textContent = msg;
  const dot = $('#statusDot');
  dot.className = 'status-dot ' + state;
}

// ‚îÄ‚îÄ‚îÄ Excel loading ‚îÄ‚îÄ‚îÄ
async function readExcelFromUrl(url) {
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status} fetching ${url}`);
  const data = await res.arrayBuffer();
  const wb = XLSX.read(data, { type: "array" });
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, { defval: "", raw: true });
}

async function loadOld(force = false) {
  oldRowsCache = await readExcelFromUrl(OLD_URL + (force ? `?v=${Date.now()}` : ""));
}

async function loadNew(force = false) {
  const bust = force ? `?v=${Date.now()}` : "";
  try { newRowsCache = await readExcelFromUrl(NEW_URL_PRIMARY + bust); }
  catch (e) { newRowsCache = await readExcelFromUrl(NEW_URL_FALLBACK + bust); }
}

// ‚îÄ‚îÄ‚îÄ Data helpers ‚îÄ‚îÄ‚îÄ
function normalizeHeader(h) { return String(h || "").trim().toLowerCase(); }

function getColumn(row, headerMap, desired) {
  const candidates = {
    team:     ["team","time","equipe"],
    points:   ["points","pontos"],
    tier:     ["tier"],
    region:   ["region","regi√£o","regiao"],
    victories:["victories","vitorias","vit√≥rias"],
    streak:   ["streak","sequencia","sequ√™ncia"],
    loses:    ["loses","losses","derrotas","perdas"],
    prestige: ["prestige","prest√≠gio"],
    majors:   ["majors"],
    trophies: ["tournaments trophies","trophies","trof√©us"]
  }[desired];
  for (const c of candidates) {
    const key = headerMap[c];
    if (key !== undefined) return row[key];
  }
  return undefined;
}

function toNumber(v) {
  if (v === null || v === undefined) return NaN;
  if (typeof v === "number") return v;
  const s = String(v).replace(/\./g,"").replace(/,/g,".").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

function ptsFmt(v) {
  const n = typeof v === "number" ? v : toNumber(v);
  return Number.isFinite(n) ? Math.trunc(n).toLocaleString() : "0";
}

function buildHeaderMap(rows) {
  const map = {};
  const sample = rows[0] || {};
  Object.keys(sample).forEach(k => { map[normalizeHeader(k)] = k; });
  return map;
}

function buildRanking(rows) {
  const headerMap = buildHeaderMap(rows);
  const teams = [];
  for (const r of rows) {
    const team = String(getColumn(r, headerMap, "team") ?? "").trim();
    if (!team) continue;
    const points    = toNumber(getColumn(r, headerMap, "points"));
    const tier      = String(getColumn(r, headerMap, "tier") ?? "").trim();
    const region    = String(getColumn(r, headerMap, "region") ?? "").trim();
    const victories = toNumber(getColumn(r, headerMap, "victories"));
    const streak    = toNumber(getColumn(r, headerMap, "streak"));
    const loses     = toNumber(getColumn(r, headerMap, "loses"));
    const prestige  = toNumber(getColumn(r, headerMap, "prestige"));
    const majors    = toNumber(getColumn(r, headerMap, "majors"));
    const trophies  = toNumber(getColumn(r, headerMap, "trophies"));
    teams.push({
      team,
      points:    Number.isFinite(points)    ? points    : 0,
      tier,
      region,
      victories: Number.isFinite(victories) ? victories : 0,
      streak:    Number.isFinite(streak)    ? streak    : 0,
      loses:     Number.isFinite(loses)     ? loses     : 0,
      prestige:  Number.isFinite(prestige)  ? prestige  : 0,
      majors:    Number.isFinite(majors)    ? majors    : 0,
      trophies:  Number.isFinite(trophies)  ? trophies  : 0
    });
  }
  teams.sort((a, b) => b.points !== a.points ? b.points - a.points : a.team.localeCompare(b.team, "en"));
  teams.forEach((t, i) => t.pos = i + 1);
  return teams;
}

function mapPositions(teams) {
  const map = new Map();
  teams.forEach(t => map.set(t.team.toLowerCase(), t.pos));
  return map;
}

function mapPoints(teams) {
  const map = new Map();
  teams.forEach(t => map.set(t.team.toLowerCase(), t.points));
  return map;
}

function computeDelta(oldPos, newPos) {
  const d = oldPos - newPos;
  if (d === 0) return { text: "‚Äî", cls: "flat" };
  if (d > 0)   return { text: "+" + d, cls: "up" };
  return { text: "" + d, cls: "down" };
}

function computePointsDiff(oldPts, newPts) {
  const diff = Math.trunc(newPts) - Math.trunc(oldPts);
  if (diff === 0) return { text: "‚Äî", cls: "flat" };
  if (diff > 0)   return { text: "+" + diff.toLocaleString(), cls: "up" };
  return { text: diff.toLocaleString(), cls: "down" };
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function regionLabel(v) { return REGION_LABELS[v] || v || "‚Äî"; }
function regionCls(v) { return REGION_CLASS[v] || ""; }

function tierBadgeClass(tier) {
  if (!tier) return "";
  const t = tier.toLowerCase();
  if (t.includes("s")) return "tier-s";
  if (t.includes("1")) return "tier-1";
  if (t.includes("2")) return "tier-2";
  if (t.includes("3")) return "tier-3";
  return "";
}

function rankBadgeHtml(pos) {
  if (pos === 1) return `<span class="rank-badge rank-badge-1">1</span>`;
  if (pos === 2) return `<span class="rank-badge rank-badge-2">2</span>`;
  if (pos === 3) return `<span class="rank-badge rank-badge-3">3</span>`;
  return `<span class="rank-badge rank-badge-n">${pos}</span>`;
}

function teamNameHtml(name, pos) {
  if (pos === 1) return `<span class="team-name-animated team-name-1">${escHtml(name)}</span>`;
  if (pos === 2) return `<span class="team-name-animated team-name-2">${escHtml(name)}</span>`;
  if (pos === 3) return `<span class="team-name-animated team-name-3">${escHtml(name)}</span>`;
  if (pos <= 10) return `<span class="team-name-animated team-name-top">${escHtml(name)}</span>`;
  return `<span class="team-name-default">${escHtml(name)}</span>`;
}

function rowClass(pos) {
  if (pos === 1) return "rank-row rank-1";
  if (pos === 2) return "rank-row rank-2";
  if (pos === 3) return "rank-row rank-3";
  if (pos <= 10) return "rank-row rank-top";
  return "";
}

function streakHtml(streak) {
  const s = Number(streak) || 0;
  if (s === 0) return `<span class="streak-badge cold">‚Äî</span>`;
  return `<span class="streak-badge hot">üî•${s}</span>`;
}

// ‚îÄ‚îÄ‚îÄ Filter helpers ‚îÄ‚îÄ‚îÄ
function updateRegionOptions(combined, selectId) {
  const select = $(selectId);
  const cur = select.value;
  const regions = new Set();
  combined.forEach(r => { if (r.region) regions.add(r.region); });
  const order = ["AM","EU","AS/SIS/ESEA"];
  const list = Array.from(regions).sort((a,b) => {
    const ia = order.indexOf(a), ib = order.indexOf(b);
    return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
  });
  const placeholder = selectId === "#filterRegion" ? `<option value="">All Regions</option>` : ``;
  select.innerHTML = placeholder + list.map(v =>
    `<option value="${escHtml(v)}">${escHtml(regionLabel(v))}</option>`
  ).join("");
  select.value = list.includes(cur) ? cur : (selectId === "#regionRankingSelect" ? list[0] || "" : "");
}

function applyFilters(combined) {
  const txt = $('#filterText').value.trim().toLowerCase();
  const region = $('#filterRegion').value;
  const tier = $('#filterTier').value;
  return combined.filter(r =>
    (!txt || r.team.toLowerCase().includes(txt)) &&
    (!region || r.region === region) &&
    (!tier || r.tier === tier)
  );
}

// ‚îÄ‚îÄ‚îÄ Global table render ‚îÄ‚îÄ‚îÄ
function renderTable(combined) {
  const tbody = $('#tbody');
  const rows = applyFilters(combined);
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="9" class="empty-state">No results for current filters.</td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(r => {
    const oldToNew = (r.oldPos || "‚Äî") + " ‚Üí " + r.newPos;
    const deltaCell = r.deltaText === "NEW"
      ? `<span class="delta new">‚ú¶ NEW</span>`
      : `<span class="delta ${r.deltaCls}">${r.deltaText}</span>`;
    const diffCell = r.pointsDiffText === "NEW"
      ? `<span class="delta new">‚ú¶ NEW</span>`
      : `<span class="delta ${r.pointsDiffCls}">${r.pointsDiffText}</span>`;
    const tierCls = tierBadgeClass(r.tier);
    const tierHtml = r.tier
      ? `<span class="tier-badge ${tierCls}">${escHtml(r.tier)}</span>`
      : `<span class="text-muted text-xs">‚Äî</span>`;
    const regCls = regionCls(r.region);
    const regHtml = r.region
      ? `<span class="region-tag ${regCls}"><span class="region-dot"></span>${escHtml(regionLabel(r.region))}</span>`
      : `<span class="text-muted">‚Äî</span>`;
    return `<tr class="${rowClass(r.newPos)}">
      <td>${rankBadgeHtml(r.newPos)}</td>
      <td>${teamNameHtml(r.team, r.newPos)}</td>
      <td class="right mono">${ptsFmt(r.points)}</td>
      <td class="right">${diffCell}</td>
      <td class="right">${streakHtml(r.streak)}</td>
      <td>${regHtml}</td>
      <td>${tierHtml}</td>
      <td class="right">${deltaCell}</td>
      <td class="right mono text-xs text-muted">${oldToNew}</td>
    </tr>`;
  }).join("");
}

// ‚îÄ‚îÄ‚îÄ Region table render ‚îÄ‚îÄ‚îÄ
function renderRegionTable(combined) {
  const tbody = $('#tbodyRegion');
  if (!combined || !combined.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="empty-state">No data for selected region.</td></tr>`;
    return;
  }
  tbody.innerHTML = combined.map(r => {
    const oldToNew = (r.oldPos || "‚Äî") + " ‚Üí " + r.newPos;
    const deltaCell = r.deltaText === "NEW"
      ? `<span class="delta new">‚ú¶ NEW</span>`
      : `<span class="delta ${r.deltaCls}">${r.deltaText}</span>`;
    const diffCell = r.pointsDiffText === "NEW"
      ? `<span class="delta new">‚ú¶ NEW</span>`
      : `<span class="delta ${r.pointsDiffCls}">${r.pointsDiffText}</span>`;
    const tierCls = tierBadgeClass(r.tier);
    const tierHtml = r.tier
      ? `<span class="tier-badge ${tierCls}">${escHtml(r.tier)}</span>` : `‚Äî`;
    return `<tr class="${rowClass(r.newPos)}">
      <td>${rankBadgeHtml(r.newPos)}</td>
      <td>${teamNameHtml(r.team, r.newPos)}</td>
      <td class="right mono">${ptsFmt(r.points)}</td>
      <td class="right">${diffCell}</td>
      <td class="right">${streakHtml(r.streak)}</td>
      <td>${tierHtml}</td>
      <td class="right">${deltaCell}</td>
      <td class="right mono text-xs text-muted">${oldToNew}</td>
    </tr>`;
  }).join("");
}

// ‚îÄ‚îÄ‚îÄ Region ranking compute ‚îÄ‚îÄ‚îÄ
function computeRegionCombined(regionValue) {
  if (!oldRowsCache || !newRowsCache) return [];
  const oldHM = buildHeaderMap(oldRowsCache);
  const newHM = buildHeaderMap(newRowsCache);
  const oldFiltered = oldRowsCache.filter(r => String(getColumn(r, oldHM, "region") ?? "").trim() === regionValue);
  const newFiltered = newRowsCache.filter(r => String(getColumn(r, newHM, "region") ?? "").trim() === regionValue);
  const oldTeamsR = buildRanking(oldFiltered);
  const newTeamsR = buildRanking(newFiltered);
  const oldPosMap = mapPositions(oldTeamsR);
  const oldPtsMap = mapPoints(oldTeamsR);
  return newTeamsR.map(t => {
    const key = t.team.toLowerCase();
    const oldPos = oldPosMap.get(key);
    const oldPts = oldPtsMap.get(key);
    const posDelta = oldPos ? computeDelta(oldPos, t.pos) : { text: "NEW", cls: "new" };
    const ptsDelta = oldPts !== undefined ? computePointsDiff(oldPts, t.points) : { text: "NEW", cls: "new" };
    return {
      team: t.team, points: t.points, region: t.region, tier: t.tier,
      streak: t.streak, oldPos: oldPos ?? null, newPos: t.pos,
      deltaText: oldPos ? posDelta.text : "NEW",
      deltaCls: oldPos ? posDelta.cls : "new",
      pointsDiffText: oldPts !== undefined ? ptsDelta.text : "NEW",
      pointsDiffCls: oldPts !== undefined ? ptsDelta.cls : "new"
    };
  });
}

function recomputeRegionRanking() {
  const v = $('#regionRankingSelect').value;
  if (!v) {
    $('#tbodyRegion').innerHTML = `<tr><td colspan="8" class="empty-state">Select a region above.</td></tr>`;
    return;
  }
  const c = computeRegionCombined(v);
  lastRegionCombined = c;
  renderRegionTable(c);
}

// ‚îÄ‚îÄ‚îÄ ELO engine ‚îÄ‚îÄ‚îÄ
const ELO_K_BASE = 30;
const ELO_DIVISOR = 400;
const ELO_STREAK_ALPHA = 0.10;
const ELO_STREAK_SCALE = 5;
const ELO_K_CAP_MULT = 1.35;
const ELO_TOURNEY = { regional: 0.05, global: 0.10, major: 0.20 };

function eloExpected(ra, rb) { return 1 / (1 + Math.pow(10, (rb - ra) / ELO_DIVISOR)); }
function tanhLocal(x) { const e2x = Math.exp(2*x); return (e2x - 1) / (e2x + 1); }
function streakKBonus(streak) { return ELO_STREAK_ALPHA * tanhLocal((streak || 0) / ELO_STREAK_SCALE); }

function getBonusForTeam(lowerName) {
  if (!newRowsCache) return { type: "none", remaining: 0 };
  const hm = buildHeaderMap(newRowsCache);
  for (const r of newRowsCache) {
    const t = String(getColumn(r, hm, "team") ?? "").trim();
    if (t.toLowerCase() !== lowerName) continue;
    let bonusTypeKey = null, bonusRemKey = null;
    for (const k of Object.keys(r)) {
      const nk = normalizeHeader(k);
      if (nk === "bonustype") bonusTypeKey = k;
      if (nk === "bonusremaining") bonusRemKey = k;
    }
    const type = bonusTypeKey ? String(r[bonusTypeKey] ?? "").trim().toLowerCase() : "none";
    const remaining = bonusRemKey ? toNumber(r[bonusRemKey]) : 0;
    return { type: ELO_TOURNEY[type] !== undefined ? type : "none", remaining: Number.isFinite(remaining) ? remaining : 0 };
  }
  return { type: "none", remaining: 0 };
}

function kFinalFor(team) {
  const sBonus = streakKBonus(team.streak || 0);
  const b = getBonusForTeam(team.team.toLowerCase());
  const tBonus = (b.type !== "none" && b.remaining > 0) ? (ELO_TOURNEY[b.type] || 0) : 0;
  return Math.min(ELO_K_BASE * (1 + sBonus) * (1 + tBonus), ELO_K_BASE * ELO_K_CAP_MULT);
}

function computeHypotheticalRanking(teams, updates) {
  const hypo = teams.map(t => ({...t}));
  for (const ht of hypo) {
    const upd = updates.get(ht.team.toLowerCase());
    if (upd) { ht.points = upd.newPoints; ht.streak = upd.newStreak; }
  }
  hypo.sort((a,b) => b.points !== a.points ? b.points - a.points : a.team.localeCompare(b.team,"en"));
  hypo.forEach((t,i) => t.pos = i + 1);
  return hypo;
}

function renderMatchPredictor() {
  const tbody = $('#tbodyMatchPredict');
  const matchStatus = $('#matchStatus');
  const vsMeter = $('#vsMeter');

  if (!currentNewTeams || !currentNewTeams.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="empty-state">No data loaded.</td></tr>`;
    matchStatus.innerHTML = `<div class="status-dot"></div><span>Load ranking data first.</span>`;
    vsMeter.style.display = 'none';
    return;
  }

  const aName = $('#matchTeamA').value;
  const bName = $('#matchTeamB').value;
  const result = $('#matchResult').value;

  if (!aName || !bName) {
    tbody.innerHTML = `<tr><td colspan="8" class="empty-state">Select two teams.</td></tr>`;
    matchStatus.innerHTML = `<div class="status-dot"></div><span>Select Team A and Team B above.</span>`;
    vsMeter.style.display = 'none';
    return;
  }

  if (aName === bName) {
    tbody.innerHTML = `<tr><td colspan="8" class="empty-state">Pick two different teams.</td></tr>`;
    matchStatus.innerHTML = `<div class="status-dot err"></div><span>Team A and Team B must be different.</span>`;
    vsMeter.style.display = 'none';
    return;
  }

  const byName = new Map(currentNewTeams.map(t => [t.team.toLowerCase(), t]));
  const a = byName.get(aName.toLowerCase());
  const b = byName.get(bName.toLowerCase());
  if (!a || !b) {
    tbody.innerHTML = `<tr><td colspan="8" class="empty-state">Team not found.</td></tr>`;
    vsMeter.style.display = 'none';
    return;
  }

  const ra = a.points, rb = b.points;
  const ea = eloExpected(ra, rb), eb = 1 - ea;
  const kA = kFinalFor(a), kB = kFinalFor(b);

  let aDelta, bDelta, aNewStreak, bNewStreak;
  if (result === "A") {
    aDelta = kA * (1 - ea); bDelta = kB * (0 - eb);
    aNewStreak = (a.streak || 0) + 1; bNewStreak = 0;
  } else {
    aDelta = kA * (0 - ea); bDelta = kB * (1 - eb);
    aNewStreak = 0; bNewStreak = (b.streak || 0) + 1;
  }

  const aNewPoints = ra + aDelta;
  const bNewPoints = rb + bDelta;

  const updates = new Map([
    [a.team.toLowerCase(), { newPoints: aNewPoints, newStreak: aNewStreak }],
    [b.team.toLowerCase(), { newPoints: bNewPoints, newStreak: bNewStreak }]
  ]);

  const hypo = computeHypotheticalRanking(currentNewTeams, updates);
  const oldPosMap = mapPositions(currentNewTeams);
  const newPosMap = mapPositions(hypo);

  const aOldPos = oldPosMap.get(a.team.toLowerCase());
  const bOldPos = oldPosMap.get(b.team.toLowerCase());
  const aNewPos = newPosMap.get(a.team.toLowerCase());
  const bNewPos = newPosMap.get(b.team.toLowerCase());

  const aMove = computeDelta(aOldPos, aNewPos);
  const bMove = computeDelta(bOldPos, bNewPos);
  const aPD = computePointsDiff(ra, aNewPoints);
  const bPD = computePointsDiff(rb, bNewPoints);

  // VS meter
  vsMeter.style.display = '';
  $('#vsAName').textContent = a.team;
  $('#vsBName').textContent = b.team;
  $('#vsAPts').textContent = ptsFmt(ra);
  $('#vsBPts').textContent = ptsFmt(rb);
  const aProb = Math.round(ea * 100);
  const bProb = 100 - aProb;
  $('#vsAProb').textContent = aProb + '%';
  $('#vsBProb').textContent = bProb + '%';
  $('#vsProbBarA').style.width = aProb + '%';
  $('#vsProbBarB').style.width = bProb + '%';

  function makeRow(team, oldPos, newPos, pts, streak, pd, move) {
    const pdCell = `<span class="delta ${pd.cls}">${pd.text}</span>`;
    const mvCell = `<span class="delta ${move.cls}">${move.text}</span>`;
    const newPts = pts + (pd.cls === 'up' ? 1 : -1) * Math.abs(parseInt(pd.text.replace(/[^0-9]/g,''))) || pts;
    return `<tr>
      <td>${rankBadgeHtml(oldPos)}</td>
      <td>${escHtml(team.team)}</td>
      <td class="right mono">${ptsFmt(pts)}</td>
      <td class="right">${streakHtml(streak)}</td>
      <td class="right">${pdCell}</td>
      <td class="right mono">${ptsFmt(team === a ? aNewPoints : bNewPoints)}</td>
      <td class="right">${mvCell}</td>
      <td class="right mono text-xs text-muted">${oldPos} ‚Üí ${newPos}</td>
    </tr>`;
  }

  tbody.innerHTML = makeRow(a, aOldPos, aNewPos, ra, aNewStreak, aPD, aMove)
    + makeRow(b, bOldPos, bNewPos, rb, bNewStreak, bPD, bMove);

  const winner = result === "A" ? a.team : b.team;
  matchStatus.innerHTML = `<div class="status-dot ok"></div><span>Scenario: <strong>${escHtml(winner)}</strong> wins. `
    + `${escHtml(a.team)}: ${aPD.text} pts (${aMove.text} positions). `
    + `${escHtml(b.team)}: ${bPD.text} pts (${bMove.text} positions).</span>`;
}

// ‚îÄ‚îÄ‚îÄ AI Analysis ‚îÄ‚îÄ‚îÄ
function runAnalysis() {
  if (!lastCombined || !lastCombined.length) return;

  const combined = lastCombined;
  const n = combined.length;

  // Biggest risers
  const risers = combined
    .filter(r => r.deltaText !== "NEW" && r.deltaText.startsWith("+"))
    .sort((a,b) => parseInt(b.deltaText) - parseInt(a.deltaText))
    .slice(0,5);

  // Biggest fallers
  const fallers = combined
    .filter(r => r.deltaText !== "NEW" && r.deltaText.startsWith("-"))
    .sort((a,b) => parseInt(a.deltaText) - parseInt(b.deltaText))
    .slice(0,5);

  // Biggest point gains
  const ptGainers = combined
    .filter(r => r.pointsDiffText !== "NEW" && r.pointsDiffText.startsWith("+"))
    .sort((a,b) => {
      const pa = parseInt(b.pointsDiffText.replace(/[^0-9]/g,""));
      const pb = parseInt(a.pointsDiffText.replace(/[^0-9]/g,""));
      return pa - pb;
    }).slice(0,5);

  // Hot streaks
  const hotStreaks = currentNewTeams
    ? [...currentNewTeams].sort((a,b) => b.streak - a.streak).filter(t => t.streak >= 2).slice(0,5)
    : [];

  // Newly entered
  const newTeams = combined.filter(r => r.deltaText === "NEW");

  // Region distribution
  const regionDist = {};
  combined.forEach(r => { regionDist[r.region] = (regionDist[r.region] || 0) + 1; });

  // Points stats
  const pts = combined.map(r => r.points);
  const avgPts = pts.reduce((a,b)=>a+b,0) / n;
  const maxPts = Math.max(...pts);
  const minPts = Math.min(...pts);
  const top1 = combined[0];

  // Dominance: gap between #1 and #2
  const gap12 = combined.length >= 2 ? Math.trunc(combined[0].points - combined[1].points) : 0;

  // Tier distribution
  const tierDist = {};
  combined.forEach(r => { tierDist[r.tier || "Unknown"] = (tierDist[r.tier||"Unknown"] || 0) + 1; });

  const html = `
    <div class="ai-analysis-box">
      <div class="ai-header">
        <div class="ai-icon">üß†</div>
        <div>
          <div class="ai-title">Ranking Analysis Report</div>
          <div class="ai-subtitle mono">Generated from ${n} teams ¬∑ ${new Date().toLocaleDateString()}</div>
        </div>
      </div>

      <!-- Overview -->
      <div class="ai-section">
        <div class="ai-section-title">Overview</div>
        <div class="ai-insight-grid">
          <div class="ai-insight-card">
            <div class="ai-insight-label">Leader</div>
            <div class="ai-insight-value">${escHtml(top1.team)}</div>
            <div class="ai-insight-sub">${ptsFmt(top1.points)} pts ¬∑ ${escHtml(top1.region)}</div>
          </div>
          <div class="ai-insight-card">
            <div class="ai-insight-label">#1 vs #2 Gap</div>
            <div class="ai-insight-value" style="color:var(--warn)">${ptsFmt(gap12)} pts</div>
            <div class="ai-insight-sub">${gap12 > 200 ? "Strong dominance at the top" : gap12 > 50 ? "Moderate lead" : "Very tight at the top"}</div>
          </div>
          <div class="ai-insight-card">
            <div class="ai-insight-label">Avg Points</div>
            <div class="ai-insight-value">${ptsFmt(avgPts)}</div>
            <div class="ai-insight-sub">Range: ${ptsFmt(minPts)} ‚Äì ${ptsFmt(maxPts)}</div>
          </div>
          <div class="ai-insight-card">
            <div class="ai-insight-label">Movement</div>
            <div class="ai-insight-value">${risers.length + fallers.length}</div>
            <div class="ai-insight-sub">${risers.length} ‚Üë risen ¬∑ ${fallers.length} ‚Üì fallen</div>
          </div>
          <div class="ai-insight-card">
            <div class="ai-insight-label">New Entries</div>
            <div class="ai-insight-value" style="color:var(--warn)">${newTeams.length}</div>
            <div class="ai-insight-sub">${newTeams.map(t=>t.team).slice(0,2).join(", ")||"None"}${newTeams.length>2?"‚Ä¶":""}</div>
          </div>
          <div class="ai-insight-card">
            <div class="ai-insight-label">Hot Streaks</div>
            <div class="ai-insight-value" style="color:var(--good)">${hotStreaks.length}</div>
            <div class="ai-insight-sub">${hotStreaks.map(t=>`${t.team} (${t.streak})`).slice(0,2).join(", ")||"None"}</div>
          </div>
        </div>
      </div>

      <!-- Region distribution -->
      <div class="ai-section">
        <div class="ai-section-title">Region Distribution</div>
        <div class="ai-insight-grid">
          ${Object.entries(regionDist).map(([reg, cnt]) => `
            <div class="ai-insight-card">
              <div class="ai-insight-label">${escHtml(regionLabel(reg))}</div>
              <div class="ai-insight-value">${cnt}</div>
              <div class="ai-insight-sub">${Math.round(cnt/n*100)}% of all teams</div>
            </div>
          `).join("")}
        </div>
      </div>

      ${risers.length ? `
      <!-- Biggest risers -->
      <div class="ai-section">
        <div class="ai-section-title">Biggest Risers</div>
        <div class="ai-list">
          ${risers.map((r,i) => `
            <div class="ai-list-item">
              <div class="ai-list-num">${i+1}</div>
              <div>
                <strong>${escHtml(r.team)}</strong>
                <span class="delta up" style="margin-left:8px;">${r.deltaText} positions</span>
                <span class="delta up" style="margin-left:8px;">${r.pointsDiffText} pts</span>
                <br><span class="text-xs text-muted mono">${escHtml(regionLabel(r.region))} ¬∑ ${escHtml(r.tier||"‚Äî")} ¬∑ Now #${r.newPos}</span>
              </div>
            </div>
          `).join("")}
        </div>
      </div>` : ""}

      ${fallers.length ? `
      <!-- Biggest fallers -->
      <div class="ai-section">
        <div class="ai-section-title">Biggest Fallers</div>
        <div class="ai-list">
          ${fallers.map((r,i) => `
            <div class="ai-list-item">
              <div class="ai-list-num" style="background:rgba(255,64,96,0.1); color:var(--bad);">${i+1}</div>
              <div>
                <strong>${escHtml(r.team)}</strong>
                <span class="delta down" style="margin-left:8px;">${r.deltaText} positions</span>
                <span class="delta down" style="margin-left:8px;">${r.pointsDiffText} pts</span>
                <br><span class="text-xs text-muted mono">${escHtml(regionLabel(r.region))} ¬∑ ${escHtml(r.tier||"‚Äî")} ¬∑ Now #${r.newPos}</span>
              </div>
            </div>
          `).join("")}
        </div>
      </div>` : ""}

      ${hotStreaks.length ? `
      <!-- Hot streaks -->
      <div class="ai-section">
        <div class="ai-section-title">Active Win Streaks</div>
        <div class="ai-list">
          ${hotStreaks.map((t,i) => `
            <div class="ai-list-item">
              <div class="ai-list-num" style="background:rgba(255,185,48,0.1); color:var(--warn);">${i+1}</div>
              <div>
                <strong>${escHtml(t.team)}</strong>
                <span style="margin-left:8px;">üî• ${t.streak}-win streak</span>
                <br><span class="text-xs text-muted mono">${escHtml(regionLabel(t.region))} ¬∑ #${t.pos} ¬∑ ${ptsFmt(t.points)} pts</span>
              </div>
            </div>
          `).join("")}
        </div>
      </div>` : ""}

      ${ptGainers.length ? `
      <!-- Point gainers -->
      <div class="ai-section">
        <div class="ai-section-title">Biggest Point Gains</div>
        <div class="ai-list">
          ${ptGainers.map((r,i) => `
            <div class="ai-list-item">
              <div class="ai-list-num">${i+1}</div>
              <div>
                <strong>${escHtml(r.team)}</strong>
                <span class="delta up" style="margin-left:8px;">${r.pointsDiffText} pts</span>
                <br><span class="text-xs text-muted mono">${escHtml(regionLabel(r.region))} ¬∑ ${escHtml(r.tier||"‚Äî")} ¬∑ #${r.newPos}</span>
              </div>
            </div>
          `).join("")}
        </div>
      </div>` : ""}

      <!-- Key takeaways -->
      <div class="ai-section">
        <div class="ai-section-title">Key Takeaways</div>
        <div class="ai-list">
          ${[
            top1 ? `<strong>${escHtml(top1.team)}</strong> leads the global ranking with ${ptsFmt(top1.points)} points, holding a ${ptsFmt(gap12)}-point gap over the runner-up.` : null,
            hotStreaks.length ? `${escHtml(hotStreaks[0].team)} is on the hottest streak (${hotStreaks[0].streak} consecutive wins), which amplifies their ELO K-factor.` : null,
            newTeams.length ? `${newTeams.length} team${newTeams.length>1?"s":""} entered the ranking this update: ${escHtml(newTeams.map(t=>t.team).join(", "))}.` : null,
            risers.length ? `The most impressive riser is <strong>${escHtml(risers[0].team)}</strong>, climbing ${risers[0].deltaText} positions.` : null,
            fallers.length ? `<strong>${escHtml(fallers[0].team)}</strong> suffered the steepest drop, falling ${fallers[0].deltaText} positions.` : null,
            `Average points across all ${n} teams: ${ptsFmt(avgPts)}. The point spread (${ptsFmt(maxPts)} ‚àí ${ptsFmt(minPts)}) suggests a ${(maxPts - minPts) > 500 ? "highly stratified" : "competitive"} field.`
          ].filter(Boolean).map((txt,i) => `
            <div class="ai-list-item">
              <div class="ai-list-num">${i+1}</div>
              <div>${txt}</div>
            </div>
          `).join("")}
        </div>
      </div>

    </div>
  `;

  $('#aiContent').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ
function toCsv(combined) {
  const header = ["Position","Team","Points","Points Diff","Region","Tier","Position Delta","OldPos","NewPos"];
  const lines = [header.join(",")];
  for (const r of combined) {
    lines.push([
      r.newPos,
      `"${String(r.team).replaceAll('"','""')}"`,
      Math.trunc(r.points),
      r.pointsDiffText,
      `"${String(r.region||"").replaceAll('"','""')}"`,
      `"${String(r.tier||"").replaceAll('"','""')}"`,
      r.deltaText,
      r.oldPos ?? "",
      r.newPos
    ].join(","));
  }
  return lines.join("\n");
}

function downloadText(filename, content, mime = "text/plain") {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ Enable/disable controls ‚îÄ‚îÄ‚îÄ
function enableFilters(on) {
  ['filterRegion','filterTier','filterText','btnClearFilters'].forEach(id => $(('#'+id)).disabled = !on);
}
function enableRegion(on) { $('#regionRankingSelect').disabled = !on; }
function enablePredictor(on) {
  ['matchTeamA','matchTeamB','matchResult'].forEach(id => $(('#'+id)).disabled = !on);
}
function enableAnalysis(on) { $('#btnRunAnalysis').disabled = !on; }

// ‚îÄ‚îÄ‚îÄ Main compute ‚îÄ‚îÄ‚îÄ
function recomputeAndRender() {
  if (!oldRowsCache || !newRowsCache) {
    setStatus("Could not load both files.", "err");
    return;
  }

  const oldTeams = buildRanking(oldRowsCache);
  const newTeams = buildRanking(newRowsCache);
  const oldPosMap = mapPositions(oldTeams);
  const oldPtsMap = mapPoints(oldTeams);

  const combined = newTeams.map(t => {
    const key = t.team.toLowerCase();
    const oldPos = oldPosMap.get(key);
    const oldPts = oldPtsMap.get(key);
    const posDelta = oldPos ? computeDelta(oldPos, t.pos) : { text: "NEW", cls: "new" };
    const ptsDelta = oldPts !== undefined ? computePointsDiff(oldPts, t.points) : { text: "NEW", cls: "new" };
    return {
      team: t.team, points: t.points, region: t.region, tier: t.tier, streak: t.streak,
      oldPos: oldPos ?? null, newPos: t.pos,
      deltaText: oldPos ? posDelta.text : "NEW", deltaCls: oldPos ? posDelta.cls : "new",
      pointsDiffText: oldPts !== undefined ? ptsDelta.text : "NEW",
      pointsDiffCls: oldPts !== undefined ? ptsDelta.cls : "new"
    };
  });

  let up=0, down=0, flat=0, newly=0;
  combined.forEach(r => {
    if (r.deltaText === "NEW") newly++;
    else if (r.deltaText === "‚Äî" || r.deltaText === "0") flat++;
    else if (r.deltaText.startsWith("+")) up++;
    else down++;
  });

  // Stats
  ['countTeams','sideCountTeams'].forEach(id => $(('#'+id)).textContent = combined.length);
  ['countUp','sideCountUp'].forEach(id => $(('#'+id)).textContent = up);
  ['countDown','sideCountDown'].forEach(id => $(('#'+id)).textContent = down);
  $('#countFlat').textContent = flat;
  $('#countNew').textContent = newly;
  $('#statsRow').style.display = 'flex';

  lastCombined = combined;
  currentNewTeams = newTeams;

  updateRegionOptions(combined, '#filterRegion');
  enableFilters(true);
  renderTable(combined);
  $('#btnDownloadCsv').disabled = false;

  updateRegionOptions(combined, '#regionRankingSelect');
  enableRegion(true);
  recomputeRegionRanking();

  updateMatchTeamOptions(currentNewTeams);
  enablePredictor(true);
  renderMatchPredictor();

  enableAnalysis(true);
  setStatus(`Ranking loaded ‚Äî ${combined.length} teams compared.`, "ok");
}

function updateMatchTeamOptions(teams) {
  const selA = $('#matchTeamA'), selB = $('#matchTeamB');
  const curA = selA.value, curB = selB.value;
  const opts = `<option value="">‚Äî Select ‚Äî</option>` +
    (teams||[]).map(t => `<option value="${escHtml(t.team)}">${escHtml(t.team)}</option>`).join("");
  selA.innerHTML = opts; selB.innerHTML = opts;
  const names = new Set((teams||[]).map(t=>t.team));
  selA.value = names.has(curA) ? curA : "";
  selB.value = names.has(curB) ? curB : "";
}

// ‚îÄ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ
$('#btnCompare').addEventListener('click', recomputeAndRender);

$('#btnUpdateOld').addEventListener('click', async () => {
  try {
    setStatus("Reloading old.xlsx‚Ä¶", "loading");
    await loadOld(true);
    setStatus("Old reloaded. Recalculating‚Ä¶", "loading");
    recomputeAndRender();
  } catch(e) {
    setStatus("Error reloading old.xlsx ‚Äî check that file/old.xlsx is accessible.", "err");
  }
});

$('#btnUpdateNew').addEventListener('click', async () => {
  try {
    setStatus("Reloading ranking.xlsx‚Ä¶", "loading");
    await loadNew(true);
    setStatus("New reloaded. Recalculating‚Ä¶", "loading");
    recomputeAndRender();
  } catch(e) {
    setStatus("Error reloading ranking.xlsx.", "err");
  }
});

['filterText','filterRegion','filterTier'].forEach(id => {
  const el = $(('#'+id));
  el.addEventListener('input', () => { if (lastCombined) renderTable(lastCombined); });
  el.addEventListener('change', () => { if (lastCombined) renderTable(lastCombined); });
});

$('#btnClearFilters').addEventListener('click', () => {
  $('#filterText').value = '';
  $('#filterRegion').value = '';
  $('#filterTier').value = '';
  if (lastCombined) renderTable(lastCombined);
});

$('#btnDownloadCsv').addEventListener('click', () => {
  if (!lastCombined) return;
  downloadText('vrs_ranking.csv', toCsv(lastCombined), 'text/csv;charset=utf-8');
});

$('#regionRankingSelect').addEventListener('change', recomputeRegionRanking);

['matchTeamA','matchTeamB','matchResult'].forEach(id => {
  $(('#'+id)).addEventListener('change', renderMatchPredictor);
});

$('#btnRunAnalysis').addEventListener('click', () => {
  runAnalysis();
  switchPanel('analysis');
});

enableFilters(false);
enableRegion(false);
enablePredictor(false);
enableAnalysis(false);

// ‚îÄ‚îÄ‚îÄ Auto-load ‚îÄ‚îÄ‚îÄ
(async () => {
  try {
    setStatus("Loading old.xlsx and ranking.xlsx‚Ä¶", "loading");
    await loadOld(false);
    await loadNew(false);
    recomputeAndRender();
  } catch(e) {
    console.error(e);
    setStatus("Auto-load failed. Run from a local server and ensure /file/*.xlsx exists.", "err");
  }
})();

// Keyboard shortcut: press 0 to go back
document.addEventListener('keydown', e => {
  if (e.key !== '0' && e.code !== 'Numpad0') return;
  const el = document.activeElement;
  const tag = el?.tagName?.toLowerCase() || '';
  if (['input','textarea','select'].includes(tag) || el?.isContentEditable) return;
  window.location.href = 'index.html';
});
</script>
</body>
</html>
